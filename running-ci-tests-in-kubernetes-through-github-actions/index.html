
<!doctype html>
<!-- BEGIN _layouts/default.html -->
<html>
	<head>
		<meta charset="utf-8">
		
		<meta content="A brief guide on running your CI environment on Kubernetes through Github Actions." name="description">
		<meta content="Alessandro Nadalin" name="author">
		
		<title>Running CI tests in Kubernetes through Github Actions</title>
		<meta name="google-site-verification" content="dSNHLHJFQzKASjN8qHJisk2XLkKqbF_ilGSj9bscwKs" />
		<link href="/favicon.png" rel="icon">
		<link href="/stylesheets/screen.css" rel="stylesheet">
		<link href="/atom.xml" rel="alternate" title="Alessandro Nadalin" type="application/atom+xml">
		<link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" type="text/css" href="/MyFontsWebfontsKit.css">

		<meta name="twitter:card" content="summary" />
		<meta name="twitter:creator" content="@_odino_" />
		<meta property="og:url" content="https://odino.org/running-ci-tests-in-kubernetes-through-github-actions/" />
		<meta property="og:title" content="Running CI tests in Kubernetes through Github Actions" />
		<meta property="og:description" content="A brief guide on running your CI environment on Kubernetes through Github Actions." />
		
		<meta property="og:image" content="https://odino.org/images/github-actions-kubernetes.png" />
		
	</head>
	<body>
		<div class="wrap">
			<header>
				<div class="navi">
					<ul>
                        <li><a href="/"><i class="icon-home icon-large"></i> Home</a></li>
                        <li><a href="/about"><i class="icon-user icon-large"></i> About</a></li>
                        <li><a href="/conferences"><i class="icon-group icon-large"></i> Conferences</a></li>
                        <li><a href="/archives"><i class="icon-briefcase icon-large"></i> Archives</a></li>
                        <li><a href="/atom.xml"><i class="icon-rss icon-large"></i> RSS</a></li>
					</ul>
				</div>
			</header>
			<!-- BEGIN _layouts/post.html -->

    <header>
        <h1><a href="/running-ci-tests-in-kubernetes-through-github-actions/">Running CI tests in Kubernetes through Github Actions</a></h1>
        <time>20 March 2020</time>
        <!-- 
        
        
         -->
    </header>
<div class="entry-content "><p><img class="right" src="/images/github-actions-kubernetes.png"></p>

<p>Remember me? At the end of last decade I shared a post on <a href="/local-k8s-development-in-2020/">a simple way to run a Kubernetes cluster for local development</a>.</p>

<p>Today I&rsquo;d like to show the other side of the medal &mdash; running your CI
environment on Kubernetes (through <a href="https://github.com/features/actions">Github Actions</a>).</p>

<p>It&rsquo;s simple, mimics your production environment and it&rsquo;s automated &mdash;
let&rsquo;s get to it!</p>

<!-- more -->


<h2>How Github Actions work</h2>

<p>If you&rsquo;ve ever used <a href="https://travis-ci.com/">Travis CI</a> or similar tools
you&rsquo;re already familiar with Actions: they provide you an environment where
you can test your applications &mdash; generally in the form of a server with
your code checked out in a directory. When you push code to your Github
repository, an environment is booted, your code gets checked out and you
can run tasks on the environment &mdash; if any of the tasks fails, your CI
task fail.</p>

<p>This is not just useful for running automated tests &mdash; you could have
builds of your app being compiled in your CI environment and uploaded
to S3 or similar services, or send an email to your QA team to let them
know what tests are passing / failing.</p>

<p>So yes, you can think of Actions as Github booting a server, checking
out your code in there and giving you the option to run any command you
want on it &mdash; the actual implementation might be fairly different, but
this is all the eli5 you need right now.</p>

<h2>Like having a server. What now?</h2>

<p>If your development environment runs on a k8s cluster, or if you&rsquo;re planning
to run your CI environment in k8s, having a machine to play with everytime
you push code to Github is like a <em>manna from heaven</em>: you can simply
setup a k8s cluster in there and watch your application run like it would
on production.</p>

<p>You might be skeptical about installing k8s in your CI environment for
a couple of very valid reasons:</p>

<ul>
<li>installing k8s on a server is not always a straightforward operation</li>
<li>loads of moving parts that need to talk to each other (kubectl, apiserver, etcd, kubelet and so on),
so it could require quite some time to get everything up &amp; running</li>
</ul>


<p>Given that a CI environment should ideally be up in seconds,
the task of booting up a k8s cluster there seems quite daunting.</p>

<p>Luckily, the folks at <a href="https://rancher.com/">Rancher</a> got us covered:
they developed <a href="https://k3s.io/">k3s</a>, a lightweight Kubernetes distribution
geared towards IoT &amp; edge computing &mdash; with the main selling point
being the fact that the cluster is up &amp; running in a few seconds
with a simple:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>curl -sfL https://get.k3s.io | sh -
</span><span class='line'>
</span><span class='line'><span class="c"># wait ~30s</span>
</span><span class='line'>k3s kubectl get node
</span></code></pre></td></tr></table></div></figure>


<p>With k3s, bringing k8s into our Action is extremely simple &mdash; let&rsquo;s
see it in action!</p>

<h2>The Kubernetes Github Action</h2>

<p>First off, create your action file, eg. <code>test.yml</code> under the folder
<code>.github/workflows</code> in your repo &mdash; then add the following steps
to the workflow:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Example action</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">on</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">push</span><span class="p-Indicator">]</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">jobs</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">build</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">runs-on</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ubuntu-latest</span>
</span><span class='line'>    <span class="l-Scalar-Plain">timeout-minutes</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>
</span><span class='line'>    <span class="l-Scalar-Plain">steps</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">uses</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">actions/checkout@v2</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">install k8s</span>
</span><span class='line'>      <span class="l-Scalar-Plain">run</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
</span><span class='line'>        <span class="no">curl -sfL https://get.k3s.io | K3S_KUBECONFIG_MODE=777 sh -</span>
</span><span class='line'>        <span class="no">cat /etc/rancher/k3s/k3s.yaml</span>
</span><span class='line'>        <span class="no">mkdir -p ~/.kube</span>
</span><span class='line'>        <span class="no">cp /etc/rancher/k3s/k3s.yaml ~/.kube/config</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">example tests</span>
</span><span class='line'>      <span class="l-Scalar-Plain">run</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
</span><span class='line'>        <span class="no"># Whatever command you want to run</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, all the magic happens here:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>curl -sfL https://get.k3s.io | <span class="nv">K3S_KUBECONFIG_MODE</span><span class="o">=</span>777 sh -
</span><span class='line'>cat /etc/rancher/k3s/k3s.yaml
</span><span class='line'>mkdir -p ~/.kube
</span><span class='line'>cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
</span></code></pre></td></tr></table></div></figure>


<p>We download k3s, install it and copy its configuration into
the usual kubeconfig path. This is done so that <code>kubectl</code>
can talk to the cluster, else you have to use the one provided
by k3s under the alias <code>k3s kubectl</code> (meaning you need to run
commands such as <code>k3s kubectl get po</code>).</p>

<p>If you&rsquo;re wondering how does this look like in action,
you should probably head over to the sample repo I
setup at <a href="https://github.com/odino/k8s-github-action">github.com/odino/k8s-github-action</a>:
it&rsquo;s really not that crazy, as it simply contains the above
code. What you might find interesting, though, is having
a look at <a href="https://github.com/odino/k8s-github-action/actions">some of the &ldquo;builds&rdquo; that ran</a>, where you can clarly
see k8s up &amp; running:</p>

<p><img class="center" src="/images/k8s-github-action-example.png"></p>

<p>As usual, <a href="https://github.com/odino/k8s-github-action/pull/1">Actions report their status on PRs</a>, so you get
Github to confirm that everything ran smoothly whenever
you push:</p>

<p><img class="center" src="/images/k8s-github-action-pr.png"></p>

<p>Hope this was helpful &mdash; peace!</p>
</div>



<div class="recent entry-content">
  <hr class="divider-cazzuto">
  <h3>
    In the mood for some more reading?
  </h3>
  <ul>
    
      <li><a href="/dell-xps-13-9310-usb-c-port-not-recognizing-external-devices/">Dell XPS 13 9310: USB-C port not recognizing external devices</a> (25 July 2021)</li>
    
      <li><a href="/book-review-working-backwards/">Book review: Working Backwards</a> (24 July 2021)</li>
    
      <li><a href="/fwupd-is-the-best-thing-that-ever-happened-to-linux/">fwupd is the best thing that ever happened to Linux</a> (15 April 2021)</li>
    
      <li><a href="/avoid-battery-draining-on-your-linux-flavored-dell-xps/">Avoid battery draining on your Linux-flavored Dell XPS</a> (31 January 2021)</li>
    
      <li><a href="/combining-two-numbers-into-a-unique-one-pairing-functions/">Combining two numbers into a unique one: pairing functions</a> (05 December 2020)</li>
    
      <li><a href="/running-ci-tests-in-kubernetes-through-github-actions/">Running CI tests in Kubernetes through Github Actions</a> (20 March 2020)</li>
    
      <li><a href="/ive-decided-to-make-the-wasec-ebook-free-during-these-trying-times/">I've decided to make the WASEC ebook free during these trying times</a> (20 March 2020)</li>
    
  </ul>
    <p>
      ...or <a href="/archives/">check the archives</a>.
    </p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/anchor-js/3.2.0/anchor.min.js"></script>
<script type="text/javascript" />
(function () {
  'use strict';

  anchors.options = {
    placement: 'left',
    visible: 'hover',
    icon: '¶'
  };

  anchors.add('h2');
  anchors.add('h3');
  anchors.add('h4');

})();
</script>

			<footer>
				<center>
	Copyleft <!--[if lte IE 8]><span style="filter: FlipH; -ms-filter: "FlipH"; display: inline-block;"><![endif]--><span style="-moz-transform: scaleX(-1); -o-transform: scaleX(-1); -webkit-transform: scaleX(-1); transform: scaleX(-1); display: inline-block;">©</span><!--[if lte IE 8]></span><![endif]--> 2021 — Alessandro Nadalin
	<address>
	</address>
</center>
			</footer>
		</div>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-7407627-3', 'auto');
      ga('send', 'pageview');
	</script>
	
	<script type="application/ld+json">
		{
		"@context": "https://schema.org/",
		"@type": "BlogPosting",
		"mainEntityOfPage": {
			"@type": "WebPage",
			"@id": "https://odino.org/running-ci-tests-in-kubernetes-through-github-actions/"
		},
		"headline": "Running CI tests in Kubernetes through Github Actions",
		"description": "A brief guide on running your CI environment on Kubernetes through Github Actions.",
		
		"image": {
			"@type": "ImageObject",
			"url": "https://odino.org/images/github-actions-kubernetes.png"
		},
		
		"author": {
			"@type": "Person",
			"name": "Alessandro Nadalin"
		},
		"datePublished": "2020-03-20 09:21:00 +0000"
		}
	</script>
	
	</body>
</html>
<!-- END _layouts/default.html -->
