
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Functional testing symfony 1.X with PHPUnit: the Symfony2 way - Alessandro Nadalin</title>
  <meta name="author" content="Alessandro Nadalin">

  
  
  <meta name="description" content="In the process of starting a brand new project here at
DNSEE, me and my colleague
Matteo decided
&ndash; in order to make the whole team aware of how &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://odino.org/functional-testing-symfony-1-dot-4-with-phpunit-the-symfony2-way">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Alessandro Nadalin" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="../../stylesheets/font-awesome.min.css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-7407627-3']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <link rel="stylesheet" href="../../../stylesheets/font-awesome.min.css">
</head>
<body   class="no-sidebar"  >
  <header role="banner"><hgroup>
  <h1 class="hentry" role="title"><a href="">
    Functional testing symfony 1.X with PHPUnit: the Symfony2 way</a>
  </h1>
  
  <p class="article-date">
      Thursday, 26 January 2012, 00:45
  </p>
</hgroup>
</header>
  <nav role="navigation"><ul class="main-navigation">
  <li><a href="/"><i class="icon-home icon-large"></i> Home</a></li>
  <li><a href="/about"><i class="icon-user icon-large"></i> About me</a></li>
  <li><a href="/conferences"><i class="icon-group icon-large"></i> Conferences</a></li>
  <li><a href="/blog/archives"><i class="icon-briefcase icon-large"></i> Archives</a></li>
  <li><a href="/atom.xml"><i class="icon-rss icon-large"></i> RSS</a></li>
</ul>
</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
<div class="entry-content"><p>In the process of starting a brand new project here at
<a href="http://www.dnsee.com">DNSEE</a>, me and my colleague
<a href="http://www.linkedin.com/in/matteobiagetti">Matteo</a> decided
&ndash; in order to make the whole team aware of how to test
Symfony2 applications with <a href="http://www.phpunit.de">PHPUnit</a>
&ndash; to port the Symfony2 functional testing mechanism into
this project, which will be developed with symfony
1.X<sup id='fnref:1'><a href='#fn:1' rel='footnote'>1</a></sup>.</p>

<!-- more -->


<h2>Background</h2>

<p><a href="http://trac.symfony-project.org/wiki/LimeTestingFramework">Lime</a>
&ndash; as you may know &ndash; is the officially-supported testing
&ldquo;framework&rdquo;: it was specifically built to be used inside
symfony 1.X applications and introduced lots of developers
to the whole idea of testing in PHP.</p>

<p>It&rsquo;s a lightweight and simple implementation of a testing
framework, with poor support for mock objects, test doubles,
data providers and test isolation, but it does its job.</p>

<p>Since <a href="http://www.symfony.com">Symfony2</a> decided to move to
PHPUnit &ndash; a <strong>serious</strong> and more robust testing framework &ndash;
suddenly all symfony developers needed to learn PHPUnit in order
to test the new applications: this &ndash; at least &ndash; didn&rsquo;t
happened to me, because I heavily faced PHPUnit developing
<a href="http://github.com/congow/Orient">Orient</a>, with lots of
WTFs &ndash; mainly <em>my</em> fault.</p>

<p>So, starting this new project, I asked the team if they would
agree on using PHPUnit to functionally test this new symfony 1.4
application, for 2 main reasons:</p>

<ul>
<li><strong>learn PHPUnit</strong>, since the 3 developers involved in the project
have worked for 10|4|0 months on PHPUnit ever</li>
<li><strong>get prepared for the big move</strong>, since Symfony2 uses an analogous testing
mechanism</li>
</ul>


<h2>The Symfony2 way</h2>

<p>In Symfony2 you basically instantiate your application with a fake
client and make requests to it; at each request the application
produces a response and a crawler lets you
<a href="http://symfony.com/doc/2.0/book/testing.html#working-with-the-test-client">test the output</a>:</p>

<figure class='code'><figcaption><span>A functional test for Symfony2</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="nx">Acme\DemoBundle\Tests\Controller</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">use</span> <span class="nx">Symfony\Bundle\FrameworkBundle\Test\WebTestCase</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">FooControllerTest</span> <span class="k">extends</span> <span class="nx">WebTestCase</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">testIndex</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$client</span> <span class="o">=</span> <span class="k">static</span><span class="o">::</span><span class="na">createClient</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="nv">$crawler</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;/homepage&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="s2">&quot;Welcome!&quot;</span><span class="p">,</span> <span class="nv">$crawler</span><span class="o">-&gt;</span><span class="na">filter</span><span class="p">(</span><span class="s1">&#39;h1#page-title&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">text</span><span class="p">());</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>So, as you see, PHPUnit is used to make assertions
on the response body<sup id='fnref:2'><a href='#fn:2' rel='footnote'>2</a></sup>.</p>

<h2>The basic idea</h2>

<p>So, to backport the mechanism illustrated in the previous
chapter to symfony 1.X, we should <strong>rely on a
DOM crawler and a browser</strong>, capable of making HTTP requests
and parse subquent responses&#8217; bodies.</p>

<p>Fortunately, symfony 1.X&rsquo;s functional testing mechanism already
relies on an <a href="http://www.symfony-project.org/api/1_4/sfBrowser">internal browser</a>
, able to bootstrap the application and make fake HTTP
requests<sup id='fnref:3'><a href='#fn:3' rel='footnote'>3</a></sup>, so we only need to integrate this browser
into a PHPUnit test and parse responses with a crawler: since
Symfony2 is a well-decoupled set of libraries we will use its
<a href="https://github.com/symfony/DomCrawler">DomCrawler</a> component.</p>

<h2>Implementation</h2>

<p>First of all import the required libraries into your
symfony project; using SVN, we updated the <code>lib/vendor</code>
directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir -p lib/vendor/Symfony/Component
</span><span class='line'>svn add lib/vendor/Symfony
</span><span class='line'>svn pe svn:externals lib/vendor/Symfony/Component
</span></code></pre></td></tr></table></div></figure>


<p>the content of the <code>externals</code> property will be:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>DomCrawler https://svn.github.com/symfony/DomCrawler.git
</span><span class='line'>CssSelector https://svn.github.com/symfony/CssSelector.git
</span></code></pre></td></tr></table></div></figure>


<p>We are downloading the CssSelector component in order to use
CSS selectors within the crawler: if you don&rsquo;t want to use it you&rsquo;ll
need to write XPath queries to access the DOM nodes.</p>

<p>Save the <code>externals</code> file and commit, then update the
<code>lib/vendor/Symfony</code> directory in order to phisically
download the dependencies.</p>

<p>To finish the setup of the environment, create a <code>phpunit.xml.dist</code>
file in the root of the symfony project:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;phpunit</span> <span class="na">backupGlobals=</span><span class="s">&quot;true&quot;</span>
</span><span class='line'>         <span class="na">bootstrap=</span><span class="s">&quot;test/bootstrap/autoload.php&quot;</span>
</span><span class='line'>         <span class="na">backupStaticAttributes=</span><span class="s">&quot;false&quot;</span>
</span><span class='line'>         <span class="na">colors=</span><span class="s">&quot;true&quot;</span>
</span><span class='line'>         <span class="na">convertErrorsToExceptions=</span><span class="s">&quot;true&quot;</span>
</span><span class='line'>         <span class="na">convertNoticesToExceptions=</span><span class="s">&quot;true&quot;</span>
</span><span class='line'>         <span class="na">convertWarningsToExceptions=</span><span class="s">&quot;true&quot;</span>
</span><span class='line'>         <span class="na">forceCoversAnnotation=</span><span class="s">&quot;false&quot;</span>
</span><span class='line'>         <span class="na">mapTestClassNameToCoveredClassName=</span><span class="s">&quot;false&quot;</span>
</span><span class='line'>         <span class="na">processIsolation=</span><span class="s">&quot;false&quot;</span>
</span><span class='line'>         <span class="na">stopOnError=</span><span class="s">&quot;false&quot;</span>
</span><span class='line'>         <span class="na">stopOnFailure=</span><span class="s">&quot;false&quot;</span>
</span><span class='line'>         <span class="na">stopOnIncomplete=</span><span class="s">&quot;false&quot;</span>
</span><span class='line'>         <span class="na">stopOnSkipped=</span><span class="s">&quot;false&quot;</span>
</span><span class='line'>         <span class="na">syntaxCheck=</span><span class="s">&quot;false&quot;</span>
</span><span class='line'>         <span class="na">testSuiteLoaderClass=</span><span class="s">&quot;PHPUnit_Runner_StandardTestSuiteLoader&quot;</span>
</span><span class='line'>         <span class="na">strict=</span><span class="s">&quot;false&quot;</span>
</span><span class='line'>         <span class="na">verbose=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;testsuites&gt;</span>
</span><span class='line'>      <span class="nt">&lt;testsuite</span> <span class="na">name=</span><span class="s">&quot;Main tests&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          <span class="nt">&lt;directory</span> <span class="nt">&gt;</span>test/phpunit<span class="nt">&lt;/directory&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/testsuite&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/testsuites&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;filter&gt;</span>
</span><span class='line'>      <span class="nt">&lt;blacklist&gt;</span>
</span><span class='line'>        <span class="nt">&lt;directory</span> <span class="na">suffix=</span><span class="s">&quot;.php&quot;</span><span class="nt">&gt;</span>test<span class="nt">&lt;/directory&gt;</span>
</span><span class='line'>        <span class="nt">&lt;directory</span> <span class="na">suffix=</span><span class="s">&quot;.php&quot;</span><span class="nt">&gt;</span>src<span class="nt">&lt;/directory&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/blacklist&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/filter&gt;</span>
</span><span class='line'><span class="nt">&lt;/phpunit&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>and the <code>test/bootstrap/autoloader.php</code> file, used by PHPUnit
for -guess it &ndash; autoloading classes:</p>

<figure class='code'><figcaption><span>The autoloader taken from Composer</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="nx">Composer\Autoload</span><span class="p">;</span> <span class="k">class</span> <span class="nc">ClassLoader</span> <span class="p">{</span> <span class="k">private</span> <span class="nv">$prefixes</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span> <span class="k">private</span> <span class="nv">$fallbackDirs</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span> <span class="k">public</span> <span class="k">function</span> <span class="nf">getPrefixes</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">prefixes</span><span class="p">;</span> <span class="p">}</span> <span class="k">public</span> <span class="k">function</span> <span class="nf">getFallbackDirs</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fallbackDirs</span><span class="p">;</span> <span class="p">}</span> <span class="k">public</span> <span class="k">function</span> <span class="nf">add</span><span class="p">(</span><span class="nv">$prefix</span><span class="p">,</span> <span class="nv">$paths</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$prefix</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fallbackDirs</span> <span class="o">=</span> <span class="p">(</span><span class="k">array</span><span class="p">)</span> <span class="nv">$paths</span><span class="p">;</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span> <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">prefixes</span><span class="p">[</span><span class="nv">$prefix</span><span class="p">]))</span> <span class="p">{</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">prefixes</span><span class="p">[</span><span class="nv">$prefix</span><span class="p">]</span> <span class="o">=</span> <span class="nb">array_merge</span><span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">prefixes</span><span class="p">[</span><span class="nv">$prefix</span><span class="p">],</span> <span class="p">(</span><span class="k">array</span><span class="p">)</span> <span class="nv">$paths</span> <span class="p">);</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">prefixes</span><span class="p">[</span><span class="nv">$prefix</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">array</span><span class="p">)</span> <span class="nv">$paths</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span> <span class="k">public</span> <span class="k">function</span> <span class="nf">register</span><span class="p">(</span><span class="nv">$prepend</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span> <span class="nb">spl_autoload_register</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">&#39;loadClass&#39;</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="nv">$prepend</span><span class="p">);</span> <span class="p">}</span> <span class="k">public</span> <span class="k">function</span> <span class="nf">loadClass</span><span class="p">(</span><span class="nv">$class</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$file</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">findFile</span><span class="p">(</span><span class="nv">$class</span><span class="p">))</span> <span class="p">{</span> <span class="k">require</span> <span class="nv">$file</span><span class="p">;</span> <span class="k">return</span> <span class="k">true</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span> <span class="k">public</span> <span class="k">function</span> <span class="nf">findFile</span><span class="p">(</span><span class="nv">$class</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;\\&#39;</span> <span class="o">==</span> <span class="nv">$class</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span> <span class="nv">$class</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="p">}</span> <span class="k">if</span> <span class="p">(</span><span class="k">false</span> <span class="o">!==</span> <span class="nv">$pos</span> <span class="o">=</span> <span class="nb">strrpos</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="s1">&#39;\\&#39;</span><span class="p">))</span> <span class="p">{</span> <span class="nv">$classPath</span> <span class="o">=</span> <span class="nx">DIRECTORY_SEPARATOR</span> <span class="o">.</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">&#39;\\&#39;</span><span class="p">,</span> <span class="nx">DIRECTORY_SEPARATOR</span><span class="p">,</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$pos</span><span class="p">));</span> <span class="nv">$className</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="nv">$pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nv">$classPath</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span> <span class="nv">$className</span> <span class="o">=</span> <span class="nv">$class</span><span class="p">;</span> <span class="p">}</span> <span class="nv">$classPath</span> <span class="o">.=</span> <span class="nx">DIRECTORY_SEPARATOR</span> <span class="o">.</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="nx">DIRECTORY_SEPARATOR</span><span class="p">,</span> <span class="nv">$className</span><span class="p">)</span> <span class="o">.</span> <span class="s1">&#39;.php&#39;</span><span class="p">;</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">prefixes</span> <span class="k">as</span> <span class="nv">$prefix</span> <span class="o">=&gt;</span> <span class="nv">$dirs</span><span class="p">)</span> <span class="p">{</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$dirs</span> <span class="k">as</span> <span class="nv">$dir</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">===</span> <span class="nb">strpos</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="nv">$prefix</span><span class="p">))</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$dir</span> <span class="o">.</span> <span class="nv">$classPath</span><span class="p">))</span> <span class="p">{</span> <span class="k">return</span> <span class="nv">$dir</span> <span class="o">.</span> <span class="nv">$classPath</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fallbackDirs</span> <span class="k">as</span> <span class="nv">$dir</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$dir</span> <span class="o">.</span> <span class="nv">$classPath</span><span class="p">))</span> <span class="p">{</span> <span class="k">return</span> <span class="nv">$dir</span> <span class="o">.</span> <span class="nv">$classPath</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$__composer_autoload_init</span> <span class="o">=</span> <span class="k">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$loader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Composer\Autoload\ClassLoader</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$map</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>    <span class="s1">&#39;Symfony\\Component\\DomCrawler&#39;</span> <span class="o">=&gt;</span> <span class="nx">__DIR__</span> <span class="o">.</span> <span class="s1">&#39;/../../lib/vendor/&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;Symfony\\Component\\CssSelector&#39;</span> <span class="o">=&gt;</span> <span class="nx">__DIR__</span> <span class="o">.</span> <span class="s1">&#39;/../../lib/vendor/&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$map</span> <span class="k">as</span> <span class="nv">$namespace</span> <span class="o">=&gt;</span> <span class="nv">$path</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$loader</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$namespace</span><span class="p">,</span> <span class="nv">$path</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$loader</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nv">$loader</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">return</span> <span class="nv">$__composer_autoload_init</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>At this point the environment is ready, and you can start writing
your Symfony2&rsquo;s correspondent <code>WebTestCase</code> class<sup id='fnref:4'><a href='#fn:4' rel='footnote'>4</a></sup>:</p>

<figure class='code'><figcaption><span>lib/test/sfWebTestCase.class.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="k">abstract</span> <span class="k">class</span> <span class="nc">sfWebTestCase</span> <span class="k">extends</span> <span class="nx">PHPUnit_Framework_TestCase</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">protected</span> <span class="k">function</span> <span class="nf">createClient</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="nv">$app</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getApplication</span><span class="p">();</span>
</span><span class='line'>    <span class="k">include</span><span class="p">(</span><span class="nb">dirname</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;/../../test/bootstrap/functional.php&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="nx">sfPHPUnitBrowser</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">abstract</span> <span class="k">protected</span> <span class="k">function</span> <span class="nf">getApplication</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So we&rsquo;ve created a base class for every functional test we&rsquo;ll write.</p>

<p>It consist in:</p>

<ul>
<li>a <code>createClient()</code> method which instantiates a new browser based on
some configuration</li>
<li>an abstract method that each functional test need to implement in order
to setup the right application in the <code>createClient()</code> method
(frontent, backend, whatever&hellip;)</li>
</ul>


<p>The browser that we are using is <code>sfPHPUnitBrowser</code>, instance of a
non-existing class, so let&rsquo;s create it:</p>

<figure class='code'><figcaption><span>lib/test/sfPHPUnitBrowser.class.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="k">use</span> <span class="nx">Symfony\Component\DomCrawler\Crawler</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">sfPHPUnitBrowser</span> <span class="k">extends</span> <span class="nx">sfBrowser</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">function</span> <span class="nf">call</span><span class="p">(</span><span class="nv">$uri</span><span class="p">,</span> <span class="nv">$method</span> <span class="o">=</span> <span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="nv">$parameters</span> <span class="o">=</span> <span class="k">array</span><span class="p">(),</span> <span class="nv">$changeStack</span> <span class="o">=</span> <span class="k">true</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="nv">$browser</span> <span class="o">=</span> <span class="k">parent</span><span class="o">::</span><span class="na">call</span><span class="p">(</span><span class="nv">$uri</span><span class="p">,</span> <span class="nv">$method</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">,</span> <span class="nv">$changeStack</span><span class="p">);</span>
</span><span class='line'>    <span class="nv">$crawler</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Crawler</span><span class="p">();</span>
</span><span class='line'>    <span class="nv">$crawler</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$browser</span><span class="o">-&gt;</span><span class="na">getResponse</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getContent</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nv">$crawler</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This class extends the usual <code>sfBrowser</code> one adding a simple functionality:
when a request is made, it does not return itself but an instance of a
<code>Crawler</code> object.</p>

<p>This will let you do:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$crawler</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;/home&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertCount</span><span class="p">(</span><span class="nx">X</span><span class="p">,</span> <span class="nv">$crawler</span><span class="o">-&gt;</span><span class="na">filter</span><span class="p">(</span><span class="s1">&#39;CSS selector here&#39;</span><span class="p">));</span>
</span><span class='line'><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertTrue</span><span class="p">(</span><span class="nv">$crawler</span><span class="o">-&gt;</span><span class="na">filter</span><span class="p">(</span><span class="s1">&#39;html:contains(h1)&#39;</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>If you didn&rsquo;t mistyped anything you should be able to
create your first test:</p>

<figure class='code'><figcaption><span>test/phpunit/HomepageTest.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="k">include</span><span class="p">(</span><span class="nx">__DIR__</span> <span class="o">.</span> <span class="s2">&quot;/../../lib/test/sfWebTestCase.class.php&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">use</span> <span class="nx">Symfony\Component\DomCrawler\Crawler</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">HomepageTest</span> <span class="k">extends</span> <span class="nx">sfWebTestCase</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">function</span> <span class="nf">testHelloWorld</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="nv">$client</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createClient</span><span class="p">();</span>
</span><span class='line'>    <span class="nv">$crawler</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="s2">&quot;Hello world&quot;</span><span class="p">,</span> <span class="nv">$crawler</span><span class="o">-&gt;</span><span class="na">filter</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">text</span><span class="p">());</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">protected</span> <span class="k">function</span> <span class="nf">getApplication</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="s1">&#39;frontend&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, create a route for your homepage and render
some dummy template:</p>

<figure class='code'><figcaption><span>The template we are going to test</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;h1&gt;</span>Hello world<span class="nt">&lt;/h1&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now you can run the test with the usual <code>phpunit</code> command:</p>

<p><img class="center" src="/images/phpunit.symfony.png"></p>

<p>The greatest benefit of this approach is that you can <strong>use
PHPUnit&rsquo;s pure functionalities to test symfony 1.X
applications</strong> without re-inventing the wheel: what we saw
was the test of some output but bare in mind that, extending
<code>sfBrowser</code>, our <code>$client</code> object is able to access the request
and the user session too.</p>

<h2>Why not re-using existing integrations?</h2>

<p>Obviously, <strong>before</strong> writing any line of code, we took a look
at existing PHPUnit&rsquo;s integrations into symfony 1.X.</p>

<p>There are &ndash; basically &ndash; 2 plugins:</p>

<ul>
<li><a href="http://www.symfony-project.org/plugins/sfPHPUnit2Plugin">sfPHPUnit2Plugin</a>,
which seemed useless being a PHPUnit wrapper for lime</li>
<li><a href="http://www.symfony-project.org/plugins/sfPhpunitPlugin">sfPHPUnitPlugin</a>,
which uses PHPUnit + Selenium, but we really don&rsquo;t want to depend on
a selenium instance to run our tests</li>
</ul>


<div class="footnotes">
<span>
Notes
</span>
    <ol>
        <li id='fn:1'>We are actually developing a few projects with Symfony2, mostly landing pages and small data-driven CRUD applications, due to the lack of comprehensive documentation about Symfony2, but I will flame about it in another post <a href='#fnref:1' rev='footnote'>↩</a></li><li id='fn:2'>This is not entirely true: PHPUnit is mainly used for testing the response, but inside a test-case you can access the user&#8217;s session, cookies and so on, therefore you can assert against lots of objects and use-cases <a href='#fnref:2' rev='footnote'>↩</a></li><li id='fn:3'>You can also use a real HTTP client to make requests to your application and test the output, but this approach is strongly discouraged because of dramatically-low performances <a href='#fnref:3' rev='footnote'>↩</a></li><li id='fn:4'>The WebTestCase is a base class for every functional test (in Symfony2), like PHPUnit_Framework_TestCase for canonical unit tests <a href='#fnref:4' rev='footnote'>↩</a></li>
    </ol>
</div>



</div>

  <footer>
    <p class="meta">
<!--       
  

<span class="byline author vcard">Posted by <span class="fn">Alessandro Nadalin</span></span>

      








  


<time datetime="2012-01-26T00:45:00+04:00" pubdate data-updated="true">Thursday, 26 January 2012 at 00:45</time>
 -->      

<span class="categories"><i class="icon-tags"></i>
  
    <a class='category' href='/blog/categories/php/'>PHP</a>, <a class='category' href='/blog/categories/phpunit/'>PHPUnit</a>, <a class='category' href='/blog/categories/symfony/'>symfony</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://odino.org/functional-testing-symfony-1-dot-4-with-phpunit-the-symfony2-way/" data-via="_odino_" data-counturl="http://odino.org/functional-testing-symfony-1-dot-4-with-phpunit-the-symfony2-way/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/quality-isnt-always-better-than-quality/" title="Post anterior: Quality isn't always better than quantity">&laquo; Quality isn't always better than quantity</a>
      
      
        <a class="basic-alignment right" href="/enter-sfcctesting-symfony-1-dot-x-client-crawler-testing/" title="Próximo post: Enter SfCcTesting: Symfony 1.X Client-Crawler Testing">Enter SfCcTesting: Symfony 1.X Client-Crawler Testing &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><script type="text/javascript">
      var disqus_shortname = 'odino';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://odino.org/functional-testing-symfony-1-dot-4-with-phpunit-the-symfony2-way/';
        var disqus_url = 'http://odino.org/functional-testing-symfony-1-dot-4-with-phpunit-the-symfony2-way/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script></div>
  </section>

</div>


    </div>
  </div>
</html>
<div id="footer">
    <ul class="credit">
        <li>&copy; 2014</li>
    </ul>
</div>
