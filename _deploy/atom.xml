<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Alessandro Nadalin]]></title>
  <link href="http://odino.org/atom.xml" rel="self"/>
  <link href="http://odino.org/"/>
  <updated>2014-01-14T01:53:28+04:00</updated>
  <id>http://odino.org/</id>
  <author>
    <name><![CDATA[Alessandro Nadalin]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Frontend web development is not as fun as it could be]]></title>
    <link href="http://odino.org/frontend-web-development-is-not-as-fun-as-it-should-be/"/>
    <updated>2013-11-10T19:53:00+04:00</updated>
    <id>http://odino.org/frontend-web-development-is-not-as-fun-as-it-should-be</id>
    <content type="html"><![CDATA[<p><img class="right" src="http://odino.org/images/browsers.jpg"></p>

<p>I am writing this post in the middle of revamping
<a href="http://en-ae.namshi.com">Namshi&rsquo;s architecture</a>
with AngularJS, reverse proxies,
SPDY and HTTP APIs, because I
strongly believe in the future of these technologies and
that they are the de-facto cutting-edge solution for
most of the antipatterns that we&rsquo;ve seen so far:
monolithic applications, unscalable frontends,
limited protocols.</p>

<p>So why would I rant about it? Well, this is not a real
rant but it&rsquo;s more of a retrospective on the <em>gotchas</em>
that we faced over the past months: I do <strong>really</strong>
enjoy all of this techs, but also
recognize that most of them are at a
very early stage and have their pitfalls when it comes
to develop real-world, scalable architectures.</p>

<p>The boring part&rsquo;s over, let&rsquo;s get into the real mess ;&ndash;)</p>

<!-- more -->


<h2>Reducing redirects?</h2>

<p>Suppose that you have a frontend, maybe built with AngularJS,
that proxies all the requests to an API, so if you request
<code>example.org/about</code>, your frontend actually gets the content
from <code>api.example.org/about</code>.</p>

<p>One of the things that you can start optimizing are the
round trips between the client and the server (very important
for mobile connections): for example,
instead of sending simple redirects from your API to the
frontend, you can return a <code>30X</code> and include the actual body
in the response; in this way, the client can:</p>

<ul>
<li>read the body of the response and work with it (output or whatever)</li>
<li>update the browser URL according to the <code>Location</code> header provided in the response with the <a href="http://diveintohtml5.info/history.html">browsers&#8217; history API</a></li>
</ul>


<p>NOT. SO. FAST.</p>

<p>Turns out that modern browsers intercept redirects and make an
additional HTTP request to the <code>Location</code> provided by the response.</p>

<p>This behavior is pretty useful in 98% of your use-cases, as
you dont have to take care of handling AJAX redirects on
your own and you have a pretty simple solution, using a
custom HTTP status
code, like <a href="http://stackoverflow.com/questions/199099/how-to-manage-a-redirect-request-after-a-jquery-ajax-call">278</a>, for the remaining 2% of scenarios.</p>

<p>NOT. SO. FAST. 2.</p>

<p>Of course, the magnificent <a href="http://www.zdnet.com/blog/networking/the-number-one-mobile-web-browser-googles-native-android-browser/2091">Android native browser</a>
will mess this up, thinking that <code>278</code> is an error code: so if, for
your HTTP request, you have a callback in case of success and
one in case of an error, the latter will be triggered.</p>

<p>How to deal with this?</p>

<p>Well, we decided to return straight <code>200 Ok</code> codes and include
2 custom headers, <code>X-Location</code> and <code>X-Status-Code</code>, that our
clients will parse to find out if they need to update the
browser&rsquo;s URL.</p>

<p>In pseudo-code:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>res = http.get('api.example.org?search=BMW')
</span><span class='line'>
</span><span class='line'>if (res.status_code === 200 && res.headers.x-location) {
</span><span class='line'>  browser.url = res.headers.x-location
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>In any case, with the growing amount of mobile clients, I think
it might make sense to start thinking of an appropriate process
to handle redirects, within the HTTP protocol, so that browsers
can just follow the spec: in my opinion we could use something
like <code>308 Transparent redirect</code> for this.</p>

<h2>Reverse proxies and HTTP cache</h2>

<p><img class="left" src="http://odino.org/images/varnish-cache.jpg"></p>

<p>Two of the most <a href="http://www.mnot.net/blog/2007/12/12/stale">important directives</a>
that you can use while taking advantage of the HTTP cache
are <code>stale-while-revalidate</code> and <code>stale-if-error</code>:
the former lets you return stale responses
while you revalidate the cache while the latter lets you serve
cached responses if your backend is down (<code>50X</code> errors).</p>

<p>Of course, you will need a reverse proxy in front
of your webserver in order to really take advantage of
these directives: <a href="http://www.squid-cache.org/">Squid</a> natively implements
both of them but, in our case, it was too much of a hassle to setup,
as it&rsquo;s bloated compared to its cousin <a href="https://www.varnish-cache.org/">Varnish</a>,
which doesn&rsquo;t natively implement <code>stale-*</code> directives instead.</p>

<p>Setting up Varnish to support those 2 directives it&rsquo;s a matter
of a few tries anyhow, as you can mimic the (almost) same
behaviors with Varnish&rsquo;s <a href="https://www.varnish-software.com/static/book/Saving_a_request.html#core-grace-mechanisms">grace and saint modes</a>.</p>

<h2>Android&rsquo;s native browser</h2>

<p><img class="right" src="http://odino.org/images/android.jpg"></p>

<p>Android, oh Android!</p>

<p>As we already saw, its native browser doesn&rsquo;t let you play around
with unconventional HTTP status codes<sup id='fnref:1'><a href='#fn:1' rel='footnote'>1</a></sup> and, on top of that,
<strong>it breaks the HTTP cache</strong>.</p>

<p>If you have a cacheable resource that you retrieve via AJAX,
the first request to retrieve will work, but as soon as you reload
the page and retrieve it a second time, the browser messes things up,
things that the request returned an invalid HTTP status code (<code>0</code>)
and aborts the process.</p>

<p>And yes, it&rsquo;s a <a href="http://opensourcehacker.com/2011/03/20/android-webkit-xhr-status-code-0-and-expires-headers/">known bug</a>.</p>

<h2>Performances on old devices</h2>

<p>And when I say old I mean stuff like the Galaxy S2 or S3, which are not <strong>that</strong> old
to be honest.</p>

<p>Performances are anyhow a huge concern when you start moving the logic into
the clients, as resources might be very limited: let&rsquo;s not forget that the
first generation of Galaxy &ndash; or even the iPhone 4 &ndash; were shipped out with
just 512mb of RAM; think of a JS-heavy app, which sucks up to 40/50mb of RAM:
how would that perform on those devices?</p>

<p>Let me tell you that: it&rsquo;d be very slow, and would even feel slower when CPUs
comes into the mix as &ndash; we&rsquo;ve witnessed it &ndash; to build DOM elements<sup id='fnref:2'><a href='#fn:2' rel='footnote'>2</a></sup>
it could take up to 4s. Of course, you can optimize it, but a brand new smartphone
wouldn&rsquo;t let you feel such <em>lag</em>: truth is that when you decide to go for a JS app
you need to take into account the time spent in optimizations for old devices,
as you&rsquo;ll surely need to invest on it.</p>

<h2>What a hard time debugging browser events</h2>

<p><img class="left" src="http://odino.org/images/chrome-devtools.png"></p>

<p>If you&rsquo;ve ever dug deep into optimizing browser events (HTML parsing, repainting and so on)
you probably know what I&rsquo;m talking about: the devtools are still at an early stage and
it becomes really tricky to be able to nail issues down or at least to efficiently
reverse engineer them; even though you have a breakdown of every browser event it&rsquo;s
actually pretty difficult to trace events back to their &ldquo;cause&rdquo;<sup id='fnref:3'><a href='#fn:3' rel='footnote'>3</a></sup>.</p>

<p>Chrome provides profiles and the timeline which are very useful resources, but you can&rsquo;t
really inspect that much as at a certain point you&rsquo;ll end up with <strong>a lot</strong> of events
like <em>HTML parsing</em> or <em>Function call</em> and only God knows where they exactly came from.</p>

<h2>Persistent sessions and credentials</h2>

<p><img class="right" src="http://odino.org/images/security.jpg"></p>

<p>Authenticating users might be tricky for frontend apps: you don&rsquo;t have the good old
(and heavy) PHP sessions that you can just fill up on you server, but you &ndash; at least
initially &ndash; can try to persist sessions on cookies or <a href="http://diveintohtml5.info/storage.html">localStorage</a>.</p>

<p>But even before thinking of storing sessions you have to deal with authenticating each
of your user from the app: granted that the HTTP basic auth is not good as
<a href="http://en.wikipedia.org/wiki/Basic_access_authentication#Security">it&rsquo;s flawed</a> and that
the <a href="http://en.wikipedia.org/wiki/Digest_access_authentication">digest auth</a> might be too simple,
you should start looking at alternative methods to authenticate and authorize your users,
preferrably using tokens.</p>

<p>As you probably figured out, there is no real standard mechanism of doing this, as some
providers rely on oAuth (both 2-* and 3-legged) and some on OpenID. Even Mozilla, a while ago,
came out with its own protocol, <a href="http://www.mozilla.org/en-US/persona/">Persona</a>, to solve this
problem.</p>

<p>We actually found out another &ldquo;protocol&rdquo; to store and transmit credentials through HTTP
APIs, the <em>Javascript Object Signing and Encryption</em> specification (<a href="https://datatracker.ietf.org/wg/jose/">JOSE</a>).</p>

<h2>A note on AngularJS and the Grunt ecosystem</h2>

<p>A glimpse of our <code>package.json</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;devDependencies&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;grunt&quot;</span><span class="p">:</span> <span class="s2">&quot;~0.4.1&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;grunt-contrib-copy&quot;</span><span class="p">:</span> <span class="s2">&quot;~0.4.1&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;grunt-contrib-concat&quot;</span><span class="p">:</span> <span class="s2">&quot;~0.3.0&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;grunt-contrib-coffee&quot;</span><span class="p">:</span> <span class="s2">&quot;~0.7.0&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;grunt-contrib-uglify&quot;</span><span class="p">:</span> <span class="s2">&quot;~0.2.0&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;grunt-contrib-compass&quot;</span><span class="p">:</span> <span class="s2">&quot;~0.3.0&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;grunt-contrib-jshint&quot;</span><span class="p">:</span> <span class="s2">&quot;~0.6.0&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;grunt-contrib-cssmin&quot;</span><span class="p">:</span> <span class="s2">&quot;~0.6.0&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;grunt-contrib-connect&quot;</span><span class="p">:</span> <span class="s2">&quot;~0.4.0&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;grunt-contrib-clean&quot;</span><span class="p">:</span> <span class="s2">&quot;~0.4.1&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;grunt-contrib-htmlmin&quot;</span><span class="p">:</span> <span class="s2">&quot;~0.1.3&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;grunt-contrib-imagemin&quot;</span><span class="p">:</span> <span class="s2">&quot;~0.1.4&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;grunt-contrib-watch&quot;</span><span class="p">:</span> <span class="s2">&quot;~0.5.3&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;grunt-usemin&quot;</span><span class="p">:</span> <span class="s2">&quot;~0.1.11&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;grunt-rev&quot;</span><span class="p">:</span> <span class="s2">&quot;~0.1.0&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;grunt-karma&quot;</span><span class="p">:</span> <span class="s2">&quot;~0.4.3&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;grunt-open&quot;</span><span class="p">:</span> <span class="s2">&quot;~0.2.0&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;matchdep&quot;</span><span class="p">:</span> <span class="s2">&quot;~0.1.2&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="err">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you see, the bower/node/grunt/angular ecosystem is still very young and,
from certain points of view, very immature (for example, <a href="https://github.com/gruntjs/grunt-contrib-connect/issues/9">SSL support in Grunt</a>
was added just 2 months ago).</p>

<p>So if you want to use these kind of technologies you must accept that, sometimes,
doing an <code>npm install</code> might break something, or that you will need to keep your deps
updated to the latest releases: it&rsquo;s all about <strong>go big or go home</strong>.</p>

<h2>Internet Explorer. As always.</h2>

<p><img class="right" src="http://odino.org/images/ie.png"></p>

<p>Eheh, there could not be a post about <em>web gotchas</em> without mentioning IE:
the lack of support for <a href="http://en.wikipedia.org/wiki/Cross-origin_resource_sharing">CORS</a>
in IE8 and IE9 is actually a real kicker for
efficiently implementing frontend apps that rely on a remote API
(<code>example.org</code> &ndash;> <code>api.example.org</code>), since CORS considers as cross-domain
even a request on a subdomain<sup id='fnref:4'><a href='#fn:4' rel='footnote'>4</a></sup>.</p>

<p>And no, there is no native escape strategy for this: you <strong>must</strong> extend the
<a href="http://www.w3.org/TR/XMLHttpRequest/">XHR</a> in order to make it capable of doing
cross-domain communication through Iframes, a strategy that even Google and Facebook
have implemented in the past; luckily there is some stuff already written for us,
so we can use the good <a href="https://github.com/jpillora/xdomain">xDomain</a> and
include it with the IE conditional comments.</p>

<p>But then, you would think, why not using xDomain for everything, and simply drop
CORS?</p>

<p>Well, there are a few things to consider:</p>

<ul>
<li>even though Google and Facebook are known to be using some trick like xDomain, it&rsquo;s
pretty strange that they havent released anything yet (might be that they don&rsquo;t consider
it a long-term option)</li>
<li>the native Android browser was known to have <a href="https://github.com/jpillora/xdomain/issues/19">issues with this library</a></li>
<li>CORS is a growing standard that has been widely adopted by the community</li>
<li>the <a href="https://github.com/jpillora/xdomain/blob/gh-pages/dist/xdomain.js">code</a> looks kind of cryptic</li>
</ul>


<p>All in all, we didnt feel like using xDomain for everything, as we are just using
it for IE8/9<sup id='fnref:5'><a href='#fn:5' rel='footnote'>5</a></sup>: <a href="https://github.com/jpillora">Jaime</a> did a great job
implementing it but I personally feel that it might be <strong>too much</strong> to just blindly
rely on it for cross-domain communications.</p>

<h2>CORS and HTTP headers</h2>

<p>Deciding to go with CORS it&rsquo;s just half of it, as the other half consists
into actually implementing CORS on both your clients and servers (APIs): it&rsquo;s
worth mentioning that the specification is really strict when it comes to
<strong>send and manipulate custom HTTP headers</strong> (like the <code>X-Location</code> that we
saw at the beginning of this post).</p>

<p>If you wanna send a custom header you will need to specify it in the
<code>Access-Control-Request-Headers</code> header:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="err">Access-Control-Request-Headers:</span> <span class="err">X-My-Custom-Header</span>
</span></code></pre></td></tr></table></div></figure>


<p>and if you want your clients to be able to access some of the response&rsquo;s headers you will
need to declare them as &ldquo;accessible&rdquo;:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="err">Access-Control-Expose-Headers:</span> <span class="err">X-My-Other-Header,</span> <span class="err">X-...</span>
</span></code></pre></td></tr></table></div></figure>


<h2>How to do RUM?</h2>

<p>Another good question (and I don&rsquo;t have an answer so far) is how to measure
performances as felt by the end-user (<a href="http://en.wikipedia.org/wiki/Real_user_monitoring">Real User Monitoring</a>),
since AngularJS loads once and then never triggers server-side measurable events
other than HTTP requests to your APIs: the API&rsquo;s response times cannot be taken
into account as you wouldn&rsquo;t measure the
performance perceived by the end user &ndash; remember, JS frameworks add HTML parsing,
data-binding and so on on top of the cake.</p>

<p>We still have to figure out how we will implement RUM in our apps,
if you have any suggestion it would be highly appreciated!</p>

<h2>All in all&hellip;</h2>

<p>Developing on the frontend is an amazing experience that has some drawbacks, like on
any platform: beware of the specs (like CORS) and gotchas (IE, Android&rsquo;s native browser) and you will
enjoy it to the max!</p>

<hr />

<p><em>P.S. Thanks to <a href="https://github.com/hzarka">HZ</a> and <a href="https://github.com/AdamQuadmon">AdamQuadmon</a>
for passively contributing to this post, sharing with me and the rest of our team this amazing
and tortuous experience</em></p>

<hr />

<div class="footnotes">
<span>
Notes
</span>
    <ol>
        <li id='fn:1'>Which might be fair, as even Chrome has some funny behaviors <a href='#fnref:1' rev='footnote'>↩</a></li><li id='fn:2'>Not so many DOM elements! <a href='#fnref:2' rev='footnote'>↩</a></li><li id='fn:3'>Chrome&#8217;s Devtools &#8220;Profiles&#8221; are probably the best resource you can use to backtrace stuff <a href='#fnref:3' rev='footnote'>↩</a></li><li id='fn:4'>Which makes sense when you have platforms like Tumblr <a href='#fnref:4' rev='footnote'>↩</a></li><li id='fn:5'>BTW IE11 is out, so there&#8217;s even more hope <a href='#fnref:5' rev='footnote'>↩</a></li>
    </ol>
</div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Drop OpenJDK and upgrade Java to the Oracle packages]]></title>
    <link href="http://odino.org/drop-openjdk-and-upgrade-java-to-the-oracle-packages/"/>
    <updated>2013-11-10T08:59:00+04:00</updated>
    <id>http://odino.org/drop-openjdk-and-upgrade-java-to-the-oracle-packages</id>
    <content type="html"><![CDATA[<p><img class="left" src="http://odino.org/images/java.png"></p>

<p>A few weeks back I started noticing some performance
issues on my <a href="http://www.jetbrains.com/phpstorm/">IDE</a> and decided to investigate a bit more
on it: turns out that they recommended to 1) upgrade to
the latest JDK (7) and stop using <a href="http://openjdk.java.net/">OpenJDK</a>, as it has
some performance gotchas.</p>

<p>Turns out to be a no-brainer thanks to the <a href="https://github.com/flexiondotorg/oab-java6">apt repository manager provided by flexiondotorg</a>:</p>

<!-- more -->




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd ~/
</span><span class='line'>wget https://github.com/flexiondotorg/oab-java6/raw/0.3.0/oab-java.sh -O oab-java.sh
</span><span class='line'>chmod +x oab-java.sh
</span><span class='line'>sudo ./oab-java.sh</span></code></pre></td></tr></table></div></figure>


<p>After running it you just need to re-install all the packages:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo apt-get install oracle-java7-jdk oracle-java7-jre oracle-java7-plugin</span></code></pre></td></tr></table></div></figure>


<p>and tell ubuntu that the JDK version and location has changed:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo update-alternatives --config java</span></code></pre></td></tr></table></div></figure>


<p>A quick check with <code>java -version</code> and then enjoy it!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Speaking about AngularJS, SOA and OrientDB in Montreal at the Confoo 2014]]></title>
    <link href="http://odino.org/speaking-about-angularjs-soa-and-orientdb-in-montreal-at-the-confoo-2014/"/>
    <updated>2013-10-20T11:00:00+04:00</updated>
    <id>http://odino.org/speaking-about-angularjs-soa-and-orientdb-in-montreal-at-the-confoo-2014</id>
    <content type="html"><![CDATA[<p>I am very happy to announce that next February I will
be attending the <a href="http://confoo.ca/">Confoo 2014</a> and <a href="http://confoo.ca/en/speaker/alessandro-nadalin">speaking as well</a>,
with a good lineup of talks:</p>

<ul>
<li><a href="http://confoo.ca/en/2014/session/orientdb-the-fastest-document-based-graphdb">OrientDB, the fastest NoSQL graph database</a></li>
<li>building a <a href="http://confoo.ca/en/2014/session/soa-with-symfony2">SOA with Symfony2</a></li>
<li><a href="http://confoo.ca/en/2014/session/angularjs-is-the-future-maybe">is AngularJS the future?</a></li>
</ul>


<p>For the first time ever, I have to admit it, I will be
presenting <strong>3 topics that have very different backgrounds</strong>,
and, as the days go by, I realize that working at <a href="http://en-ae.namshi.com">Namshi</a>
has been terrific under this point of view: we have the ability of
experimenting with different technologies and use the best out on the
market, something that gets translated into the ability of having a
360° overview of the market.</p>

<p><img class="right" src="http://odino.org/images/montreal.jpg"></p>

<p>For me it will be the first time in the cold lands of Canada, and
I can&rsquo;t wait to make the most out of this trip: I always had a <strong>very</strong>
good opinion about canadians in general, hope this trip will
confirm my random thoughts.</p>

<p>If you have the chance to join, don&rsquo;t miss this amazing event:
<a href="http://confoo.ca/en/2014/sessions">the schedule</a> speaks for itself
and I am thrilled to be part of such an amazing speakers&#8217; lineup
&mdash; which I obviously ruin :&ndash;) !</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Space to the youngsters...]]></title>
    <link href="http://odino.org/space-to-the-youngsters-dot-dot-dot/"/>
    <updated>2013-09-23T18:26:00+04:00</updated>
    <id>http://odino.org/space-to-the-youngsters-dot-dot-dot</id>
    <content type="html"><![CDATA[<p>One of the best feeling ever, while heading
a team of (web) engineers, is when you lead
them to one particular thing: do <strong>not make the
same mistakes you made</strong> back at the time.</p>

<p><img class="center" src="http://odino.org/images/namshi-team.jpg"></p>

<p>For our people it&rsquo;s pretty interesting, since
most of them didn&rsquo;t work with automated tests
and enterprise framework before we decided to
go <a href="http://odino.org/tips-and-tricks-for-you-service-oriented-architecture/">SOA</a>,
and the <strong>coolest thing</strong> is to see how juniors
pick things up better, faster than you did back
at the time.</p>

<!-- more -->


<p>Today I want to introduce you to <a href="http://mohdhallal.github.io/">Mohammad Hallal</a>,
who joined us around 3 months ago, fresh from
university.</p>

<p>His dedication and will led him to be a very
valuable element of a team full of seniors,
and he decided to make the big step,
starting to <strong>share his experience</strong>
with a technical blog.</p>

<p>Kudos to Hallal, and don&rsquo;t miss his first post,
an introduction about <a href="http://mohdhallal.github.io/blog/2013/09/22/behat-mink-and-parallel-runner-a-recipe-for-automated-web-testing/">BDD, Behat and automated testing</a>!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[CakeFest 2013 wrap-up]]></title>
    <link href="http://odino.org/cakefest-2013-wrap-up/"/>
    <updated>2013-09-21T16:58:00+04:00</updated>
    <id>http://odino.org/cakefest-2013-wrap-up</id>
    <content type="html"><![CDATA[<p>I am taking some time off to describe my last trip between
Burlingame and San Francisco for the CakeFest 2013.</p>

<!-- more -->


<h2>First-timer in the States</h2>

<p><img class="right" src="http://odino.org/images/usa-flag.jpg"></p>

<p>It was actually &ndash; what a shame! &ndash; my first time in the States: given
that I find exotic cultures (SEA, Desi) a bit more attractive, I never took
the time to fly all the way west to visit the probably most discussed
country in the globe.</p>

<p>The flight, around 15 hours in total, was pretty stressful, at least for me, and
the visit VISA process at SFO took way longer than initially expected:
luckily, Italy is part of the VISA waiver program, and at least I didn&rsquo;t get
questioned too much by the federal agents at the airport.</p>

<p>In a couple of hours I am outside of the airport: without any accomodation, I head
towards the <a href="http://en.wikipedia.org/wiki/Tenderloin,_San_Francisco">tenderloin</a>,
probably not a wise choice :&ndash;)</p>

<p>I spent the first 2 days between Market and 7th, a pretty creepy location at night,
but very enjoyable during the day: from there it&rsquo;s very easy to take a cab or the tram
and get immersed in the tourist&rsquo;s life, visiting places like the Fisherman&rsquo;s Wharf,
Pier 39 or the Embarcadero.</p>

<p>Note to self: I should have checked about the America&rsquo;s cup before: since atteding
one of the races could have been pretty damn awesome!</p>

<h2>Location</h2>

<p><img class="right" src="http://odino.org/images/cali-bike.jpg"></p>

<p>The conference was held right next to the airport, in
<a href="https://www.google.com/maps/preview#!q=burlingame+san+francisco&amp;data=!4m10!1m9!4m8!1m3!1d32160518!2d-95.677068!3d37.0625!3m2!1i1855!2i947!4f13.1">Burlingame</a>, inside
the Crowne Plaza hotel: the location was easily reachable by BART
and the airport shuttle, if you were staying in the city in those days.</p>

<p>After spending a couple days inside the city itself, I decided to
move to the CP for the rest of my vacation, as it was very comfortable
and convenient &ndash; by taking the BART you could get in SF in ~40
minutes.</p>

<p>All in all the Crowne Plaza was a pretty expensive place, but if you,
like me, are lazy and go for the easy choice, you will
find yourself pretty well there: every day (after the conference) I used to
take the shuttle to SFO and the BART there: with less than 20$
per day you would be able to move around San Francisco even though
you are actually sleeping 25km away from downtown.</p>

<h2>Welcome!</h2>

<p>The guys from the organization, especially <a href="https://github.com/jameswatts">James</a>,
did a nice job in welcoming people and making them feel at a reunion party
rather than at a formal conference: the atmosphere was very enjoyable and
having people coming from all over the world (Japan, Germany, Dubai, UK, &hellip;)
just gave it that international vibe that only these kind of events
can give you.</p>

<h2>The community</h2>

<p>I was actually surprised to see that CakePHP&rsquo;s &ldquo;official&rdquo; annual
event was a bit short in terms of numbers: I can&rsquo;t really compare it
to the <a href="http://www.zendcon.com/">ZendCon</a> or the
<a href="http://live.symfony.com/">Symfony Live</a> since I&rsquo;ve never been at the former
and my last visit to the latter was in 2011, but I am sure they get together
a few more nerds.</p>

<p>I think I could count up to 80 people in the main hall during the <strong>hot talks</strong>:
nothing bad, but I was expecting other numbers; for sure, having less people
let everyone talk to each other, as the atmosphere there was very collaborative
and group-oriented: personally, I would like to thank some of the guys for providing
much fun between talks &ndash; especially <a href="https://twitter.com/angelxmoreno">Angel</a> and
<a href="http://www.linkedin.com/profile/view?id=104354&amp;authType=NAME_SEARCH&amp;authToken=9zAl&amp;locale=en_US&amp;srchid=277650061379771493631&amp;srchindex=1&amp;srchtotal=90&amp;trk=vsrp_people_res_name&amp;trkInfo=VSRPsearchId%3A277650061379771493631%2CVSRPtargetId%3A104354%2CVSRPcmpt%3Aprimary">Gary</a>.</p>

<p><img class="right" src="http://odino.org/images/sea-lion.jpg"></p>

<h2>Conference</h2>

<p>Technically, the conference went way beyond my expectations: I didn&rsquo;t follow
all the talks (I know, I know) as I was also working during those 2 days, but what
I&rsquo;ve seen was very interesting.</p>

<p>There were talk about <a href="http://www.vagrantup.com/">Vagrant</a>, scaling/autoscaling and
Ember.JS: for me they were very valuable since
<a href="http://www.slideshare.net/odino/tips-and-tricks-for-your-service-oriented-architecture-cakefest-2013-in-san-francisco/3">I&rsquo;ve never used Cake</a>
and I was actually pretty scared of not finding talks that would inspire me
in my day-to-day job.</p>

<p>Kudos for making the CakeFest an event that a Symfonian can enjoy ;&ndash;)</p>

<h2>Aftermath</h2>

<p>Last but not least, thank you very much to the crazy guys working
at <a href="http://www.loadsys.com/">LoadSys</a>: it was so much fun to hang
with this crew from Illinois, even though they promised some pool
and we didn&rsquo;t manage to find a place with tables &ndash; what a pity!</p>

<p>Besides the fun and the jokes that evening/night was also very
interesting since <a href="https://twitter.com/joeytrapp">Joey</a>
caught me to discuss the latest developments in the JS
ecosystem, from EmberJS to AngularJS: I must admit that it
was a very inspiring exchange of ideas, and that we both share
the same doubts about long-term, <strong>maintainable NodeJS
architectures</strong>.</p>

<p> #sob</p>

<h2>See you next year?</h2>

<p><img class="right" src="http://odino.org/images/sf.jpg"></p>

<p>The city was pretty good, the conference better than anything
I could expect and full of friendly nerds craving for new
concepts, ideas and patterns: all in all, I must admit that
the CakeFest is an event I would definitely like to join
again in the future.</p>

<p>Who knows where the <a href="http://bakery.cakephp.org/articles/predominant/2013/03/20/cakefest_2013_-_vote_for_the_location">crazy band is heading next year!</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[See you in Paris at the 2013 edition of the PHP Forum]]></title>
    <link href="http://odino.org/see-you-in-paris-at-the-2013-edition-of-the-php-forum/"/>
    <updated>2013-09-21T16:04:00+04:00</updated>
    <id>http://odino.org/see-you-in-paris-at-the-2013-edition-of-the-php-forum</id>
    <content type="html"><![CDATA[<p>In late november I will be for a few days in Paris,
attending and speaking at the 2013 edition of the
<a href="http://afup.org/pages/forumphp2013/sessions.php">Forum PHP Paris</a>:
funny enough, I&rsquo;ve only been to Paris for conferences so far,
as my <em>first-timer</em> there was during the
<a href="http://odino.org/symfony-live-2011-my-pov/">2011 edition of the Symfony Live</a>.</p>

<!-- more -->


<p><img class="right" src="http://odino.org/images/paris.jpg"></p>

<p>Topic of my talk will be what we&rsquo;ve witnessed
at <a href="http://afup.org/pages/forumphp2013/sessions.php#894">Namshi building our team and stack</a>:
from recruiting talents to automated testing, from
SOA&rsquo;s rules to deciding to use cutting-edge technologies
like <a href="http://angularjs.org/">AngularJS</a>: don&rsquo;t miss the
opportunity to
<a href="http://afup.org/pages/forumphp2013/inscription.php">reserve your seat for the event</a>,
since there will be amazing speakers, like
Igor Wiedler talking about <a href="http://afup.org/pages/forumphp2013/sessions.php#967">Stack</a>,
PHP&rsquo;s rack, and
Dustin Whittle who will give his insights about
<a href="http://afup.org/pages/forumphp2013/sessions.php#964">scaling PHP apps</a>.</p>

<p>See you in the core of europe!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[HTTP/1.1, SPDY and HTTP/2.0, again]]></title>
    <link href="http://odino.org/http-slash-1-dot-1-spdy-and-http-slash-2-dot-0-again/"/>
    <updated>2013-09-01T17:48:00+04:00</updated>
    <id>http://odino.org/http-slash-1-dot-1-spdy-and-http-slash-2-dot-0-again</id>
    <content type="html"><![CDATA[<p>Today, tired like hell due to an almost sleepless night,
I gave my second (and last) talk at the <a href="http://cakefest.org">CakeFest</a>
in San Francisco.</p>

<!-- more -->


<p>It was a slightly remixed version of the same talk I gave at the
IPC in Germany last year, with a few addition and changes: I hope the
attendees have enjoyed the conference as well as my 2 <strong>small</strong>
contributions as much as I did.</p>

<p>As usual, the presentation is on <a href="http://www.slideshare.net/odino/http-colon-slash-slash-end-of-the-road-cakefest-2013-in-san-francisco">slideshare</a>:
here are the slides for the lazy ones :)</p>

<div class="slideshare" id="__ss_25801971"><iframe src="http://www.slideshare.net/slideshow/embed_code/25801971 " width="850" height="730" frameborder="0" marginwidth="0" marginheight="0" scrolling="no"></iframe></div>


<p>Cheers!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Tips and Tricks for you Service-Oriented Architecture]]></title>
    <link href="http://odino.org/tips-and-tricks-for-you-service-oriented-architecture/"/>
    <updated>2013-08-31T19:05:00+04:00</updated>
    <id>http://odino.org/tips-and-tricks-for-you-service-oriented-architecture</id>
    <content type="html"><![CDATA[<p>Today I gave the first of my 2 presentations scheduled for the
<a href="http://cakefest.org">CakeFest</a> here in San Francisco,
&ldquo;<a href="http://www.slideshare.net/odino/tips-and-tricks-for-your-service-oriented-architecture-cakefest-2013-in-san-francisco">Tips and Tricks for your SOA</a>&rdquo;.</p>

<!-- more -->


<p>It basically contains a few tips derived from our experience at
<a href="http://en-ae.namshi.com">Namshi</a> while building our own service-oriented
architecture, and I hope, since there&rsquo;s not <em>that</em> much material
about SOA out there, that this can serve as a good feedback from who
is actually embracing this architectural style.</p>

<p>As always, the slides are on <a href="http://www.slideshare.net/odino/tips-and-tricks-for-your-service-oriented-architecture-cakefest-2013-in-san-francisco">slideshare</a>,
and I&rsquo;m embedding the presentation
here for those who immediately want to have a look at it:</p>

<div class="slideshare" id="__ss_25786089"><iframe src="http://www.slideshare.net/slideshow/embed_code/25786089 " width="850" height="730" frameborder="0" marginwidth="0" marginheight="0" scrolling="no"></iframe></div>


<p>Tomorrow, as per the conference&rsquo;s schedule, I will be giving my other talk,
&ldquo;HTTP colon slash slash: end of the road?&rdquo;, a remake of what I
presented at the <a href="http://www.slideshare.net/odino/http-colon-slash-slash-the-end-of-the-road">IPC in Mainz last year</a>,
with some more contents and &ndash; hopefully &ndash; fancier slides :-P</p>

<p>Cheers!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[WiFi not connecting or being wonky on a Dell XPS in Ubuntu 13.04]]></title>
    <link href="http://odino.org/wifi-not-connecting-or-being-wonky-on-a-dell-xps-in-ubuntu-13-dot-04/"/>
    <updated>2013-08-18T23:51:00+04:00</updated>
    <id>http://odino.org/wifi-not-connecting-or-being-wonky-on-a-dell-xps-in-ubuntu-13-dot-04</id>
    <content type="html"><![CDATA[<p>Today, even though I come from a weekend
of barely sleeping, I decided, after an entire
day unable to connect to the WiFi of the office,
to try to fix this issue that seems to be affecting
the Dell XPS harder than other laptops.</p>

<!-- more -->


<p>After googling for a while and realizing that
even at home I got no luck with my wireless,
I decided to go on with my own usual solution,
which means <strong>downgrading the kernel or grub</strong>.</p>

<p>You can get a list of the <em>installables</em> from
any terminal:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> dpkg -l 'linux-*' | sed '/^ii/!d;/'"$(uname -r | sed "s/\(.*\)-\([^0-9]\+\)/\1/")"'/d;s/^[^ ]* [^ ]* \([^ ]*\).*/\1/;/[0-9]/!d'</span></code></pre></td></tr></table></div></figure>


<p>And since I&rsquo;m currently using <code>3.8.0-27-generic</code>
I decided to give a slightly previous one a try;
let&rsquo;s edit grub:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo /etc/kernel/postrm.d/zz-update-grub 3.8.0-19-generic /boot/vmlinuz-3.8.0-19-generic</span></code></pre></td></tr></table></div></figure>


<p>This solved the issue, at least for me ;&ndash;)</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Hello US, I'm coming to San Francisco]]></title>
    <link href="http://odino.org/hello-us-im-coming-to-san-francisco/"/>
    <updated>2013-08-01T05:24:00+04:00</updated>
    <id>http://odino.org/hello-us-im-coming-to-san-francisco</id>
    <content type="html"><![CDATA[<p>At the end of August I will
be travelling to reach SF and
the <a href="http://cakefest.org/">CakeFest</a>, the annual
conference about
<a href="http://cakephp.org/">CakePHP</a>.</p>

<!-- more -->


<p>Funny thing is, I have two talks
and none of them deals with Cake, <strong>at all</strong> :)</p>

<p>I will be talking about the
evolution of Web Protocols, in
particular HTTP/2.0 and SPDY, in a
remake of the <a href="http://www.slideshare.net/odino/http-colon-slash-slash-the-end-of-the-road">talk I gave the IPC</a>,
in Mainz, last year.</p>

<p>My second talk will be a <em>new entry</em>, a
collection of tips, advices and tricks
in order to manage a SOA, learnt <strong>the hard
way</strong>.</p>

<p>If you are going to be around San Francisco
in the first days of Semptember, feel free to
ping me!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Sending HipChat notifications in PHP]]></title>
    <link href="http://odino.org/sending-hipchat-notifications-in-php/"/>
    <updated>2013-07-19T14:20:00+04:00</updated>
    <id>http://odino.org/sending-hipchat-notifications-in-php</id>
    <content type="html"><![CDATA[<p>This morning I added a couple handlers to
<a href="https://github.com/namshi/notificator">Notificator</a>, one for
RabbitMQ and another for <a href="https://hipchat.com">HipChat</a>: in
this post I would like to show you how easy is to integrate
HipChat within your systems.</p>

<!-- more -->


<p>The handler takes advantage of the
<a href="https://github.com/hipchat/hipchat-php">PHP SDK</a> that the HipChat
team built, which is very, very good and
<a href="https://packagist.org/packages/hipchat/hipchat-php">available through packagist</a>.</p>

<p>First thing you will need to do, is to create an instance of a
notification manager and adding the handler to it, with
an HipChat client and the API token you can generate from the HipChat
admin interface:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="k">use</span> <span class="nx">Namshi\Notificator\Manager</span><span class="p">;</span>
</span><span class='line'><span class="k">use</span> <span class="nx">Namshi\Notificator\Notification\Handler\HipChat</span> <span class="k">as</span> <span class="nx">HipChatHandler</span><span class="p">;</span>
</span><span class='line'><span class="k">use</span> <span class="nx">HipChat\HipChat</span><span class="p">;</span>
</span><span class='line'><span class="k">use</span> <span class="nx">Namshi\Notificator\Notification\HipChat\HipChatNotification</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$hipChatClient</span>  <span class="o">=</span> <span class="k">new</span> <span class="nx">HipChat</span><span class="p">(</span><span class="s1">&#39;YOUR_API_TOKEN_HERE&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nv">$hipChatHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HipChatHandler</span><span class="p">(</span><span class="o">%</span><span class="nx">hipChatClient</span><span class="p">);</span>
</span><span class='line'><span class="nv">$manager</span>      <span class="o">=</span> <span class="k">new</span> <span class="nx">Manager</span><span class="p">();</span>
</span><span class='line'><span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">addHandler</span><span class="p">(</span><span class="nv">$hipChatHandler</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then you only need to define a notification with a few, HipChat-specific,
properties and trigger it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$notification</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HipChatNotification</span><span class="p">(</span>
</span><span class='line'>  <span class="s1">&#39;YOLO!&#39;</span><span class="p">,</span> <span class="c1">// message</span>
</span><span class='line'>  <span class="s1">&#39;Alex&#39;</span><span class="p">,</span>  <span class="c1">// sender</span>
</span><span class='line'>  <span class="s1">&#39;room1&#39;</span><span class="p">,</span> <span class="c1">// name of the room you want this message to appear</span>
</span><span class='line'>  <span class="k">array</span><span class="p">(</span>
</span><span class='line'>      <span class="s1">&#39;hipchat_notify&#39;</span>            <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span> <span class="c1">// optional: should send notifications to everyone?</span>
</span><span class='line'>      <span class="s1">&#39;hipchat_color&#39;</span>             <span class="o">=&gt;</span> <span class="nx">HipChat</span><span class="o">::</span><span class="na">COLOR_GREEN</span><span class="p">,</span> <span class="c1">// optional: background color of the notification</span>
</span><span class='line'>      <span class="s1">&#39;hipchat_message_format&#39;</span>    <span class="o">=&gt;</span> <span class="nx">HipChat</span><span class="o">::</span><span class="na">FORMAT_TEXT</span><span class="p">,</span> <span class="c1">// optional: text or html</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">trigger</span><span class="p">(</span><span class="nv">$notification</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>The result is pretty self-explanatory:</p>

<p><img class="center" src="http://odino.org/images/hipchat-php.png"></p>

<p>Kind of the <a href="https://github.com/namshi/notificator/blob/master/examples/hipchat.php">same code</a>
is also available, as an example,
on the <a href="https://github.com/namshi/notificator">notificator repository</a>,
under the <a href="https://github.com/namshi/notificator/tree/master/examples">examples</a> folder.</p>

<p>The greatness of Notificator are its handlers, so if you feel
we should add another, useful handler, just shout out!
Even better, you can contribute to the project by sending
a <a href="https://github.com/namshi/notificator/pulls?direction=desc&amp;page=1&amp;sort=created&amp;state=closed">pull request</a>
like <a href="https://twitter.com/cirpo">Alessandro</a>,
<a href="https://twitter.com/pborreli">Pascal</a> and
<a href="https://twitter.com/cordoval">Luis</a> already did!</p>

<div class="footnotes">
<span>
Notes
</span>
    <ol>
        <li id='fn:1'>The sad truth is that capistrano has an hipchat gem/extension, but you cant really plug it the way you want (at least this happens to non-rubiers) <a href='#fnref:1' rev='footnote'>↩</a></li>
    </ol>
</div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[AB testing in PHP with namshi/ab]]></title>
    <link href="http://odino.org/ab-testing-in-php-with-namshi-slash-ab/"/>
    <updated>2013-07-13T14:27:00+04:00</updated>
    <id>http://odino.org/ab-testing-in-php-with-namshi-slash-ab</id>
    <content type="html"><![CDATA[<p>AB testing is a powerful tecnique that
lets you gather metrics about different
versions of a feature: it basically
consist into displaying a number of
different variations of it to your
users and tracking the results to see
which variation performed better.</p>

<p><img class="right" src="http://odino.org/images/ab-testing.jpg"></p>

<p>An example? In an e-commerce system,
you usually have an &ldquo;Add to cart&rdquo; button:
have you ever though about the impact that
single sentence has on your customers?
What would sound better, between &ldquo;Add to cart&rdquo;
and &ldquo;Buy now&rdquo;, for example? Copywriters
away, you want <strong>data</strong> to tell you that!</p>

<p>This is why AB testing is important:
you serve different versions of something,
and track the results to improve the
experience users have while using your
application: for example, Google benchmarked
<a href="http://gigaom.com/2009/07/09/when-it-comes-to-links-color-matters/">40 different shades of blue</a>
to find out how the rate of clickthrough
would be altered.</p>

<p>At <a href="http://en-ae.namshi.com">Namshi</a> we
decided to ease AB testing by creating a
very simple library that would let you generate
and manage tests in a very easy and practical
way: that&rsquo;s how <a href="https://github.com/namshi/ab">Namshi/AB</a>
was born.</p>

<!--   more -->


<h2>Installation</h2>

<p>You can install the library via composer,
as it&rsquo;s available on <a href="https://packagist.org/packages/namshi/ab">packagist</a>.</p>

<p>Then include it, specifying a major and
minor version, in your <code>composer.json</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>"namshi/ab": "1.0.*"</span></code></pre></td></tr></table></div></figure>


<h2>Creating and running tests</h2>

<p>The library is very small, and it comes bundled with
2 classes, <code>Test</code> and <code>Container</code>: as you can probably
guess, the first is a representation of an AB test and
the 2nd serves as a convenient container for all of your
test instances.</p>

<p>Here&rsquo;s how you can create a test:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="k">use</span> <span class="nx">Namshi\AB\Test</span><span class="p">;</span>
</span><span class='line'><span class="k">use</span> <span class="nx">Namshi\AB\Container</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$cssTest</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Test</span><span class="p">(</span><span class="s1">&#39;css&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>  <span class="s1">&#39;default.css&#39;</span>   <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;new.css&#39;</span>       <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'><span class="p">));</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$abContainer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Container</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
</span><span class='line'>  <span class="nv">$cssTest</span>
</span><span class='line'><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>At this point, for example, you can start
AB testing your website by changing the CSS
in the view:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">&lt;html&gt;</span>
</span><span class='line'><span class="x">  &lt;head&gt;</span>
</span><span class='line'><span class="x">      &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$abContainer</span><span class="p">[</span><span class="s1">&#39;css&#39;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">getVariation</span><span class="p">();</span> <span class="cp">?&gt;</span><span class="x">&quot;  /&gt;</span>
</span><span class='line'><span class="x">      ...</span>
</span><span class='line'><span class="x">      ...</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>getVariation()</code> will calculate the variation
(<code>default.css</code> or <code>new.css</code>) according to the
odds of each variation (66% for the first one,
33% for the second one) and will return a string
representing the variation.</p>

<h2>Persisting the variations through an entire session</h2>

<p>Of course, you want to display variations but be
consistent with each user, so that if a user gets
a variation, it will continue getting the same variation
throughout his entire session: to do so, just calculate
a random integer (seed), store it in session and pass it to
each test:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="nb">session_start</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;seed_for_example_test&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;seed_for_example_test&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">mt_rand</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$test</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Test</span><span class="p">(</span><span class="s1">&#39;example&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>  <span class="s1">&#39;a&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;b&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'><span class="p">));</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$test</span><span class="o">-&gt;</span><span class="na">setSeed</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;seed_for_example_test&#39;</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// as long as the seed doesn&#39;t change</span>
</span><span class='line'><span class="c1">// getVariation() will always return the</span>
</span><span class='line'><span class="c1">// same variation</span>
</span><span class='line'><span class="nv">$test</span><span class="o">-&gt;</span><span class="na">getVariation</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>Soon, you will realize that having a per-test seed
is <strong>not efficient at all</strong>, that&rsquo;s why you can create
a global seed and pass it to the container: from that
seed, the container will take care of generating a seed
for each test:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="nb">session_start</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">mt_rand</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// pass the seed into the constructor</span>
</span><span class='line'><span class="nv">$abContainer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Container</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
</span><span class='line'>    <span class="k">new</span> <span class="nx">Test</span><span class="p">(</span><span class="s1">&#39;greet&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>        <span class="s1">&#39;Hey dude!&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;Welcome&#39;</span>   <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>    <span class="p">)),</span>
</span><span class='line'>    <span class="k">new</span> <span class="nx">Test</span><span class="p">(</span><span class="s1">&#39;background-color&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>        <span class="s1">&#39;yellow&#39;</span>    <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;white&#39;</span>     <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>    <span class="p">)),</span>
</span><span class='line'><span class="p">),</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// or with a setter</span>
</span><span class='line'><span class="nv">$abContainer</span><span class="o">-&gt;</span><span class="na">setSeed</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">]);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Disabling the tests</h2>

<p>Sometimes you might want to disable tests
for different purposes, for example if
the user agent who is visiting the page is a bot:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$test</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Test</span><span class="p">(</span><span class="s1">&#39;my_ab_test&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>    <span class="s1">&#39;a&#39;</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;b&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'><span class="p">));</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$test</span><span class="o">-&gt;</span><span class="na">disable</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$test</span><span class="o">-&gt;</span><span class="na">getVariation</span><span class="p">();</span> <span class="c1">// will return &#39;a&#39;!</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once you disable the test and run it,
it will always return the first variation,
no matter what its odds are, even if it&rsquo;s zero.</p>

<h2>An example</h2>

<p>I would recommend you to have a look at the
<a href="https://github.com/namshi/AB/tree/master/examples">example provided</a> under the <code>examples</code> directory:
it&rsquo;s pretty silly, but it gives you an idea of
how easy is to create and run AB tests with
this library.</p>

<p><img class="center" src="http://odino.org/images/ab.png"></p>

<p>If you look at the code, you will soon realize that
it&rsquo;s very simple:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="k">require</span> <span class="nx">__DIR__</span> <span class="o">.</span> <span class="s1">&#39;/../vendor/autoload.php&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">use</span> <span class="nx">Namshi\AB\Test</span><span class="p">;</span>
</span><span class='line'><span class="k">use</span> <span class="nx">Namshi\AB\Container</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nb">session_start</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">mt_rand</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$abt</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Container</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
</span><span class='line'>    <span class="k">new</span> <span class="nx">Test</span><span class="p">(</span><span class="s1">&#39;greet&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>        <span class="s1">&#39;Hey dude!&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;Welcome&#39;</span>   <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>    <span class="p">)),</span>
</span><span class='line'>    <span class="k">new</span> <span class="nx">Test</span><span class="p">(</span><span class="s1">&#39;background-color&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>        <span class="s1">&#39;yellow&#39;</span>    <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;white&#39;</span>     <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>    <span class="p">)),</span>
</span><span class='line'><span class="p">),</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span><span class='line'>
</span><span class='line'><span class="x">&lt;html&gt;</span>
</span><span class='line'><span class="x">    &lt;head&gt;</span>
</span><span class='line'><span class="x">        &lt;style&gt;</span>
</span><span class='line'><span class="x">            * {</span>
</span><span class='line'><span class="x">                background-color: </span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$abt</span><span class="p">[</span><span class="s1">&#39;background-color&#39;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">getVariation</span><span class="p">();</span> <span class="cp">?&gt;</span><span class="x">;</span>
</span><span class='line'><span class="x">            }</span>
</span><span class='line'><span class="x">        &lt;/style&gt;</span>
</span><span class='line'><span class="x">    &lt;/head&gt;</span>
</span><span class='line'><span class="x">    &lt;body&gt;</span>
</span><span class='line'><span class="x">        &lt;h1&gt;</span>
</span><span class='line'><span class="x">            </span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$abt</span><span class="p">[</span><span class="s1">&#39;greet&#39;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">getVariation</span><span class="p">();</span> <span class="cp">?&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">        &lt;/h1&gt;</span>
</span><span class='line'><span class="x">        </span>
</span><span class='line'><span class="x">        &lt;div&gt;</span>
</span><span class='line'><span class="x">            Your seed is </span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">];</span> <span class="cp">?&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">        &lt;/div&gt;</span>
</span><span class='line'><span class="x">    &lt;/body&gt;</span>
</span><span class='line'><span class="x">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Of course, never write an application like this ;&ndash;)
this serves just as an example.</p>

<h2>Additional features</h2>

<p>We tried to extensively cover the available features of
the library in its <a href="https://github.com/namshi/ab">README</a>,
so I will just sum them up here:</p>

<ul>
<li>the container implements the <code>ArrayAccess</code> interface, so you can
retrieve tests like if they were stored into an array (<code>$abContainer['my_test']</code>)</li>
<li>since AB tests are very useful only when you <strong>track</strong>
the results, we added a <strong>tracking name</strong> that you can specify
for each test: this is due to the fact that your test might be
called <code>add_to_cart_text</code> but in your tracking tool, you
have to reference the test with the tracking tool&rsquo;s ID, which
might be a very clueless string (ie. <code>test_id_4njktn4t4tjjnn4on</code>)</li>
<li>you can also add an array of parameters to each test and retrieve
them later on: this is due to the fact that once you track the test&rsquo;s
result, you might want to send additional data together with the
tracking name, the variation and the result</li>
</ul>


<h2>Why not choosing an existing library</h2>

<p>Of course we checked out what the market was
offering, but weren&rsquo;t able to find out a very
good, generic-purpose, library in order to
generate AB tests:</p>

<ul>
<li><a href="https://packagist.org/packages/jm/ab-bundle">jm/ab-bundle</a>
is unfortunately coupled with Symfony2 and Twig, so
you can&rsquo;t really call it a stack-free library: even though
we <strong>love</strong> Symfony2, not all of our services run with
it and we don&rsquo;t want to <strong>force a technology just to
have a functionality</strong></li>
<li><a href="http://phpabtest.com/index">phpabtest</a> is a full-stack
service, meaning that it provides a library to register and
handle tests but also tracks stuff via Google Analytics; moreover,
<a href="https://github.com/briancray/phpA-B/blob/master/phpab.php">we didn&rsquo;t like the code that much</a></li>
</ul>


<p>At the end of the day, <code>namshi/ab</code> is a <strong>1 man-day effort</strong>, so we
spiked for a bit and decided that it was worth it.</p>

<h2>Testing this library</h2>

<p>We added a few PHPUnit tests, so you just have to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">cd /path/to/namshi/ab</span>
</span><span class='line'>
</span><span class='line'><span class="x">phpunit</span>
</span></code></pre></td></tr></table></div></figure>


<p>The funny thing is that we also added some test to check that
the library correctly <a href="https://github.com/namshi/AB/blob/master/tests/Namshi/AB/Test/TestTest.php#L161">generates variations according to their odds</a>.</p>

<h2>FOSS</h2>

<p>The library is available on
<a href="https://github.com/namshi/AB">Github</a>: please let
<a href="https://github.com/namshi">us</a> know if you
would like to see something different, have a suggestion
or whatsoever: even better than that, <strong>feel free to open
a pull request</strong> if we screwed up with anything!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Notificator, sending notifications through PHP in a clean and lightweight way]]></title>
    <link href="http://odino.org/notificator-sending-notifications-through-php-in-clean-and-lightweight-way/"/>
    <updated>2013-07-11T01:20:00+04:00</updated>
    <id>http://odino.org/notificator-sending-notifications-through-php-in-clean-and-lightweight-way</id>
    <content type="html"><![CDATA[<p>While implementing various pieces of our
<a href="http://odino.org/why-we-choose-symfony2-over-any-other-php-framework/">Service-Oriented Architecture</a>
we, at <a href="http://en-ae.namshi.com">Namshi</a>,
realized that a central notification
service would have been very good in order
to abstract the way we notify our customers
and everyone in the company (ie. skype messages
when a task is due a certain date).</p>

<p>We initially implemented all of this
<a href="http://odino.org/configuring-a-symfony2-application-to-support-soa/">inside a Symfony2 bundle</a>,
but soon realized that we could
abstract and generalize our implementation
in order to extract it into a library for the public
domain, and that&rsquo;s how
<a href="https://github.com/namshi/notificator">notificator</a>
was born.</p>

<!-- more -->


<h2>Aim of the library: a monolog-like implementation for notifications</h2>

<p>The aim of this library is to provide a very
clean abstraction for a task, handling notifications,
that can be spread across multiple channels (for example
emails, skype messages, desktop notifications, &hellip;):
by following this target, we soon realized that by merging
together 2 simple things, <a href="https://github.com/Seldaek/monolog">Monolog</a>
and the concept of <a href="http://en.wikipedia.org/wiki/Observer_pattern">event dispatching</a>,
we could have easily reached our goal.</p>

<p>Honestly, it&rsquo;s true that you can achieve the same goal with
Monolog, but the problem, there, is that it&rsquo;s a library
specifically built for logging, thus, when your domain
deals with simple notifications, your code would really
be inexpressive.</p>

<p>Even though <strong>Notificator is way simpler</strong>, we took a lot
of inspiration from Monolog: for example, the concept of
handlers is a total steal ;&ndash;)</p>

<h2>Installation</h2>

<p>The library is available via composer,
as you can see from its
<a href="https://packagist.org/packages/namshi/notificator">packagist page</a>.</p>

<p>Using semantic versioning, I recommend you
to pick a minor release (<code>1.0</code>, for example)
and stick to it in your <code>composer.json</code>:
what we try to do is that, if there is a BC break
in the API, we increase the minor version (<code>1.0.X</code> to <code>1.1.X</code>, for example).</p>

<p>At the end, you <strong>should</strong> require it like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>"namshi/notificator": "1.0.*"</span></code></pre></td></tr></table></div></figure>


<h2>Hello world! example</h2>

<p>Just to give a very rough and simple example on how this
library works, let&rsquo;s see how you can trigger a notification
via <strong>both</strong> email (with PHP&rsquo;s <code>mail</code> function<sup id='fnref:1'><a href='#fn:1' rel='footnote'>1</a></sup>)
and the <code>notify-send</code> utility available on ubuntu (I&rsquo;ve already spoke
about it in <a href="http://odino.org/desktop-notifications-for-phpunit-tests-on-ubuntu/">a previous post</a>).</p>

<p>First of all, we would need to create a <em>plain-old-php-class</em>
representing the notification, which implements 2 interfaces:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="k">use</span> <span class="nx">Namshi\Notificator\Notification</span><span class="p">;</span>
</span><span class='line'><span class="k">use</span> <span class="nx">Namshi\Notificator\NotificationInterface</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">interface</span> <span class="nx">NotifySendNotificationInterface</span> <span class="k">extends</span> <span class="nx">NotificationInterface</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">getMessage</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">interface</span> <span class="nx">EmailNotificationInterface</span> <span class="k">extends</span> <span class="nx">NotificationInterface</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">getAddress</span><span class="p">();</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">getSubject</span><span class="p">();</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">getBody</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">DoubleNotification</span> <span class="k">extends</span> <span class="nx">Notification</span> <span class="k">implements</span> <span class="nx">NotifySendNotificationInterface</span><span class="p">,</span> <span class="nx">EmailNotificationInterface</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">protected</span> <span class="nv">$address</span><span class="p">;</span>
</span><span class='line'>    <span class="k">protected</span> <span class="nv">$body</span><span class="p">;</span>
</span><span class='line'>    <span class="k">protected</span> <span class="nv">$subject</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$address</span><span class="p">,</span> <span class="nv">$subject</span><span class="p">,</span> <span class="nv">$body</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$parameters</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">address</span>  <span class="o">=</span> <span class="nv">$address</span><span class="p">;</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">body</span>     <span class="o">=</span> <span class="nv">$body</span><span class="p">;</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">subject</span>  <span class="o">=</span> <span class="nv">$subject</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">getAddress</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">address</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">getSubject</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">subject</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">getBody</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">body</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">getMessage</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getBody</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>At this point we need 2 notification handlers, which
will separately handle the notification:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="k">use</span> <span class="nx">Namshi\Notificator\Notification\Handler\HandlerInterface</span><span class="p">;</span>
</span><span class='line'><span class="k">use</span> <span class="nx">Namshi\Notificator\NotificationInterface</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">NotifySendNotificationHandler</span> <span class="k">implements</span> <span class="nx">HandlerInterface</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">shouldHandle</span><span class="p">(</span><span class="nx">NotificationInterface</span> <span class="nv">$notification</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nv">$notification</span> <span class="nx">instanceOf</span> <span class="nx">NotifySendNotificationInterface</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">(</span><span class="nx">NotificationInterface</span> <span class="nv">$notification</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nb">shell_exec</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span><span class="s1">&#39;notify-send &quot;%s&quot;&#39;</span><span class="p">,</span> <span class="nv">$notification</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">()));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">EmailNotificationHandler</span> <span class="k">implements</span> <span class="nx">HandlerInterface</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">shouldHandle</span><span class="p">(</span><span class="nx">NotificationInterface</span> <span class="nv">$notification</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nv">$notification</span> <span class="nx">instanceOf</span> <span class="nx">EmailNotificationInterface</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">(</span><span class="nx">NotificationInterface</span> <span class="nv">$notification</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nb">mail</span><span class="p">(</span><span class="nv">$notification</span><span class="o">-&gt;</span><span class="na">getAddress</span><span class="p">(),</span> <span class="nv">$notification</span><span class="o">-&gt;</span><span class="na">getSubject</span><span class="p">(),</span> <span class="nv">$notification</span><span class="o">-&gt;</span><span class="na">getBody</span><span class="p">());</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;re basically there: with a bunch of code we can now trigger
a notification both via email and <code>notify-send</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// create the manager and assign handlers to it</span>
</span><span class='line'><span class="k">use</span> <span class="nx">Namshi\Notificator\Manager</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$manager</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Manager</span><span class="p">();</span>
</span><span class='line'><span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">addHandler</span><span class="p">(</span><span class="k">new</span> <span class="nx">NotifySendNotificationHandler</span><span class="p">());</span>
</span><span class='line'><span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">addHandler</span><span class="p">(</span><span class="k">new</span> <span class="nx">EmailNotificationHandler</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$notification</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DoubleNotification</span><span class="p">(</span><span class="s1">&#39;alessandro.nadalin@gmail.com&#39;</span><span class="p">,</span> <span class="s1">&#39;Test email&#39;</span><span class="p">,</span> <span class="s1">&#39;Hello!&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  trigger the notification</span>
</span><span class='line'><span class="nv">$manager</span><span class="o">-&gt;</span><span class="na">trigger</span><span class="p">(</span><span class="nv">$notification</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p><img class="right" src="http://odino.org/images/notification-email.png"></p>

<p>At this point, if you run this example<sup id='fnref:2'><a href='#fn:2' rel='footnote'>2</a></sup>, you should
see a notification popping up on your desktop and, in a few seconds,
you will also receive an email to the address you&rsquo;ve given, with the subject
&ldquo;Test email&rdquo; and &ldquo;Hello!&rdquo; in the body.</p>

<p>By the way, if you want to see some examples on
how the library works, <a href="https://github.com/namshi/notificator/tree/master/examples">check them out on github</a>.</p>

<h2>Sending notifications via RabbitMQ</h2>

<p>It is no news that we heavily rely on
<a href="http://odino.org/refactoring-your-architecture-go-for-soa/">RabbitMQ in our SOA</a>,
so it&rsquo;s pretty obvious that, to implement the notification service,
we send messages containing the notifications, that will
be intercepted by our notification service, which relies on
Notificator.</p>

<p>To do so, we take advantage of the great job done by
<a href="https://twitter.com/old_sound">Alvaro Videla</a>
on RabbitMQ for PHP and Symfony2, through the
<a href="https://github.com/videlalvaro/php-amqplib">PHP AMQP library</a>
and the <a href="https://github.com/videlalvaro/RabbitMqBundle">RabbitMQ bundle</a>.</p>

<p>If you are familiar with them, you know that in order to consume messages,
you have to declare your consumer as a callback of the actual, generic
rabbitmq consumer, through the <code>config.yml</code> file:</p>

<figure class='code'><figcaption><span>app/config/config.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">old_sound_rabbit_mq</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">consumers</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">notification</span><span class="p-Indicator">:</span>
</span><span class='line'>            <span class="l-Scalar-Plain">connection</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">default</span>
</span><span class='line'>            <span class="l-Scalar-Plain">exchange_options</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span><span class="nv">name</span><span class="p-Indicator">:</span> <span class="s">&#39;notifications&#39;</span><span class="p-Indicator">,</span> <span class="nv">type</span><span class="p-Indicator">:</span> <span class="nv">direct</span><span class="p-Indicator">}</span>
</span><span class='line'>            <span class="l-Scalar-Plain">queue_options</span><span class="p-Indicator">:</span>    <span class="p-Indicator">{</span><span class="nv">name</span><span class="p-Indicator">:</span> <span class="s">&#39;notifications&#39;</span><span class="p-Indicator">}</span>
</span><span class='line'>            <span class="l-Scalar-Plain">callback</span><span class="p-Indicator">:</span>         <span class="l-Scalar-Plain">namshi.notification.consumer</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="err">    </span><span class="l-Scalar-Plain">namshi.notification.consumer</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="err">    </span>    <span class="l-Scalar-Plain">class</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Namshi\Notificator\Messaging\RabbitMQ\Symfony2\Consumer</span>
</span><span class='line'><span class="err">    </span>    <span class="l-Scalar-Plain">arguments</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="err">@</span><span class="nv">namshi.notification.manager</span><span class="p-Indicator">]</span>
</span><span class='line'><span class="err">    </span><span class="l-Scalar-Plain">namshi.notification.manager</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="err">    </span>    <span class="l-Scalar-Plain">class</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Namshi\Notificator\Manager</span>
</span><span class='line'><span class="err">    </span>    <span class="l-Scalar-Plain">calls</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="err">    </span>      <span class="p-Indicator">-</span> <span class="p-Indicator">[</span><span class="nv">addhandler</span><span class="p-Indicator">,</span> <span class="p-Indicator">[</span><span class="err">@</span><span class="nv">namshi.notification.handler.notify_send</span><span class="p-Indicator">]</span> <span class="p-Indicator">]</span>
</span><span class='line'><span class="err">    </span><span class="l-Scalar-Plain">namshi.notification.handler.notify_send</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="err">    </span>    <span class="l-Scalar-Plain">class</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Namshi\Notificator\Notification\Handler\NotifySend</span>
</span></code></pre></td></tr></table></div></figure>


<p>We already provide a <a href="https://github.com/namshi/notificator/blob/master/src/Namshi/Notificator/Messaging/RabbitMQ/Symfony2/Consumer.php">very basic consumer callback</a>
to be used with the RabbitMQ bundle.</p>

<p>The main idea behind this is that the publisher serializes the notification
and sends it through RabbitMQ, while the consumer unserializes and
triggers it through the <code>Manager</code>. The publisher code would be very, very simple:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$publisher</span> <span class="o">=</span> <span class="nv">$container</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;old_sound_rabbit_mq.notifications_producer&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$notification</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MySampleNotification</span><span class="p">(</span><span class="s2">&quot;man, this comes from RabbitMQ and Symfony2!&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$publisher</span><span class="o">-&gt;</span><span class="na">publish</span><span class="p">(</span><span class="nb">serialize</span><span class="p">(</span><span class="nv">$notification</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>and to start consuming messages you would only need to
start the consumer:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">php app/console rabbitmq:consumer -w notification</span>
</span></code></pre></td></tr></table></div></figure>


<h2>FOSS</h2>

<p>I&rsquo;ve tried to write a pretty extensive
<a href="https://github.com/namshi/notificator/">README</a> that you can use as a reference, on Github
(check the <a href="https://github.com/namshi/notificator/tree/master/tests">tests</a>, as well, to get an idea of the internals):
if you spot any typo or mistake, don&rsquo;t hesitate to
reach out and point it out.</p>

<p>This library is part of the efforts,
from <a href="https://github.com/namshi">Namshi</a>,
to be able to give back to the
OSS community as much as possible: you
are therefore strongly encouraged to open a PR
or express your opinion if you find that something
should be fixed or could be improved (there&rsquo;s a lot
of room for improvement, starting by implementing
many more <a href="https://github.com/namshi/notificator/tree/master/src/Namshi/Notificator/Notification/Handler">handlers</a>).</p>

<div class="footnotes">
<span>
Notes
</span>
    <ol>
        <li id='fn:1'>Only used for its simplicity here, please do not use it in production, use stuff like SwiftMailer instead! <a href='#fnref:1' rev='footnote'>↩</a></li><li id='fn:2'>I mostly took the example code from the README of the library on github, so forgive me if there are synthax errors or some typo. You can anyhow have a look at the examples (in the examples/ folder) to check some working code <a href='#fnref:2' rev='footnote'>↩</a></li>
    </ol>
</div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Using Emailvision's CampaignCommander APIs from PHP]]></title>
    <link href="http://odino.org/using-emailvisions-campaigncommander-apis-from-php/"/>
    <updated>2013-06-28T18:38:00+04:00</updated>
    <id>http://odino.org/using-emailvisions-campaigncommander-apis-from-php</id>
    <content type="html"><![CDATA[<p><img class="right" src="http://odino.org/images/emailvision-template.png"></p>

<p>This weekend I finally had the chance to
work a couple hours on the <code>namshi/emailvision</code>
library, which lets you integrate CampaignCommander
as (email) notification solution in your
PHP projects.</p>

<p>I already had a proof-of-concept of this library since weeks,
and it was already pushed to Github, but since I had no
valid API account to do some integration tests, I
could not really &ldquo;publicize&rdquo; it.</p>

<p>Right now I refactored the library and added a couple integration
tests which are working flawlessy, so, in this post, I&rsquo;m
going to show you how easy it is to send emails with
Emailvision&rsquo;s solution directly from PHP.</p>

<!-- more -->


<h2>Installation</h2>

<p>As usual with the latest libraries built for PHP,
the installation can simply be done with composer,
as the library itself is available over
<a href="https://packagist.org/packages/namshi/emailvision">packagist</a>:</p>

<figure class='code'><figcaption><span>composer.json</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="s2">&quot;namshi/emailvision&quot;</span>: <span class="s2">&quot;dev-master&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>then you simply have to run a <code>php composer.phar update</code> and
you can start utilizing it in your codebase (the namespace is
<code>Namshi\Emailvision</code>, as this library has been built in the
context of our company, <a href="http://en-ae.namshi.com">namshi.com</a>).</p>

<p>As of today, the latest stable release is <code>1.0.0</code>, which is the
one we recommend to run in production &ndash; keep an eye on packagist
if we come up with changes, but I bet it won&rsquo;t change that much
in the near future, as emailvision&rsquo;s API is pretty simple.</p>

<h2>Usage</h2>

<p>After you configure transactional email templates in the
CampaignCommander web interface, you just need to keep in mind
(and in your code) the unique identifier and the security tag
of the template; the rest is very straightforward:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="k">use</span> <span class="nx">Namshi\Emailvision\Client</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$config</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>    <span class="s1">&#39;random&#39;</span>            <span class="o">=&gt;</span> <span class="s1">&#39;UNIQUE_IDENTIFIER&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;encrypt&#39;</span>           <span class="o">=&gt;</span> <span class="s1">&#39;SECURITY_TAG&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;senddate&#39;</span>          <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">\DateTime</span><span class="p">(),</span>
</span><span class='line'>    <span class="s1">&#39;uidkey&#39;</span>            <span class="o">=&gt;</span> <span class="s1">&#39;EMAIL&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;stype&#39;</span>             <span class="o">=&gt;</span> <span class="s1">&#39;NOTHING&#39;</span><span class="p">,</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$emailvisionClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Client</span><span class="p">(</span><span class="nv">$config</span><span class="p">);</span>
</span><span class='line'><span class="nv">$emailvisionClient</span><span class="o">-&gt;</span><span class="na">sendEmail</span><span class="p">(</span><span class="s2">&quot;someone@gmail.com&quot;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>The nice thing here is that Emailvision lets you schedule
emails, so you can just play with the <code>senddate</code> parameter
and set it to the future &ndash; just be aware that it needs to
be a <code>DateTime</code> instance:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="k">use</span> <span class="nx">Namshi\Emailvision\Client</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$date</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\DateTime</span><span class="p">(</span><span class="s1">&#39;2025-01-01 12:45:00&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$config</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>    <span class="s1">&#39;random&#39;</span>            <span class="o">=&gt;</span> <span class="s1">&#39;UNIQUE_IDENTIFIER&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;encrypt&#39;</span>           <span class="o">=&gt;</span> <span class="s1">&#39;SECURITY_TAG&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;senddate&#39;</span>          <span class="o">=&gt;</span>  <span class="nv">$date</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;uidkey&#39;</span>            <span class="o">=&gt;</span> <span class="s1">&#39;EMAIL&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;stype&#39;</span>             <span class="o">=&gt;</span> <span class="s1">&#39;NOTHING&#39;</span><span class="p">,</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$emailvisionClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Client</span><span class="p">(</span><span class="nv">$config</span><span class="p">);</span>
</span><span class='line'><span class="nv">$emailvisionClient</span><span class="o">-&gt;</span><span class="na">sendEmail</span><span class="p">(</span><span class="s2">&quot;someone@gmail.com&quot;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>This code will tell CampaignCommander to trigger
the email on the 1st of January 2025, at 12:45.</p>

<h2>Dynamic content in your emails</h2>

<p>If we would stop here, the library would be pretty
useless, since the power of transactional emails
is to be able to serve dynamic content: in fact, the API
allows you to pass as much variables as you want
that can be configured and used in the email templates
you&rsquo;ve created in emailvision&rsquo;s web interface.</p>

<p>To do so, once you call the <code>sendEmail</code> method of the
client, just pass an array of variables (strings) as second
argument:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$emailvisionClient</span><span class="o">-&gt;</span><span class="na">sendEmail</span><span class="p">(</span><span class="s2">&quot;someone@gmail.com&quot;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>  <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Alex!&#39;</span><span class="p">,</span>
</span><span class='line'><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>and then you will start receiving personalized emails:</p>

<p><img class="center" src="http://odino.org/images/emailvision-received.png"></p>

<h2>Running the tests</h2>

<p>Of course, we&rsquo;ve added some unit and <strong>integration</strong>
tests which let us refactor the library and add
functionalities to it without regressions; to run
the test suite, just use <code>phpunit</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> /path/to/namshi/emailvision
</span><span class='line'>
</span><span class='line'>phpunit
</span></code></pre></td></tr></table></div></figure>


<p>You will notice that even though the tests should contain
some actual HTTP calls, they are very fast: this is because,
unless you provide some real credentials for emailvision,
integration tests aren&rsquo;t run by default.</p>

<p>To run them, you will have to create a new dummy email template
on CampaignCommander and store the credentials you get
after saving it and the email address that is going to
receive the test emails in a file named <code>emailvision.config</code>
in your system&rsquo;s temporary folder (you can get it by
running <code>php -r "echo sys_get_temp_dir();"</code>):</p>

<figure class='code'><figcaption><span>/tmp/emailvision.config</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$encrypt</span>  <span class="o">=</span> <span class="s1">&#39;email_template_security_tag&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nv">$random</span>   <span class="o">=</span> <span class="s1">&#39;email_template_unique_id&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nv">$email</span>    <span class="o">=</span> <span class="s1">&#39;your.address@gmail.com&#39;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Enjoy!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Beautifying JSON data from the shell]]></title>
    <link href="http://odino.org/beautifying-json-data-from-the-shell/"/>
    <updated>2013-06-22T15:36:00+04:00</updated>
    <id>http://odino.org/beautifying-json-data-from-the-shell</id>
    <content type="html"><![CDATA[<p>Yesterday I bumped into a very
handly utility to beautify JSON
data directly from your command
line.</p>

<!-- more -->


<p>Let&rsquo;s say that, with a command, you
are retrieving some data in JSON
format<sup id='fnref:1'><a href='#fn:1' rel='footnote'>1</a></sup>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl -X POST --user admin:admin <span class="se">\</span>
</span><span class='line'>http://localhost:2480/command/temp/sql/select%20from%20person
</span><span class='line'>
</span><span class='line'><span class="o">{</span><span class="s2">&quot;result&quot;</span>:<span class="o">[{</span><span class="s2">&quot;@type&quot;</span>:<span class="s2">&quot;d&quot;</span>,<span class="s2">&quot;@rid&quot;</span>:<span class="s2">&quot;#9:2&quot;</span>,<span class="s2">&quot;@version&quot;</span>:0,<span class="s2">&quot;@class&quot;</span>:<span class="s2">&quot;person&quot;</span>,<span class="s2">&quot;name&quot;</span>:<span class="s2">&quot;Luca&quot;</span><span class="o">}</span>, <span class="o">{</span><span class="s2">&quot;@type&quot;</span>:<span class="s2">&quot;d&quot;</span>,<span class="s2">&quot;@rid&quot;</span>:<span class="s2">&quot;#9:3&quot;</span>,<span class="s2">&quot;@version&quot;</span>:0,<span class="s2">&quot;@class&quot;</span>:<span class="s2">&quot;person&quot;</span><span class="o">}</span>, <span class="o">{</span><span class="s2">&quot;@type&quot;</span>:<span class="s2">&quot;d&quot;</span>,<span class="s2">&quot;@rid&quot;</span>:<span class="s2">&quot;#9:4&quot;</span>,<span class="s2">&quot;@version&quot;</span>:0,<span class="s2">&quot;@class&quot;</span>:<span class="s2">&quot;person&quot;</span><span class="o">}]}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Of course, the result doesn&rsquo;t really look
readable, but thanks to a python
utility we can directly expand and beautify
our JSON by piping:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl -X POST --user admin:admin <span class="se">\</span>
</span><span class='line'>http://localhost:2480/command/temp/sql/select%20from%20person <span class="se">\</span>
</span><span class='line'>| python -mjson.tool
</span><span class='line'>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;result&quot;</span>: <span class="o">[</span>
</span><span class='line'>        <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;@class&quot;</span>: <span class="s2">&quot;person&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;@rid&quot;</span>: <span class="s2">&quot;#9:2&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;@type&quot;</span>: <span class="s2">&quot;d&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;@version&quot;</span>: 0,
</span><span class='line'>            <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;Luca&quot;</span>
</span><span class='line'>        <span class="o">}</span>,
</span><span class='line'>        <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;@class&quot;</span>: <span class="s2">&quot;person&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;@rid&quot;</span>: <span class="s2">&quot;#9:3&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;@type&quot;</span>: <span class="s2">&quot;d&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;@version&quot;</span>: 0
</span><span class='line'>        <span class="o">}</span>,
</span><span class='line'>        <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;@class&quot;</span>: <span class="s2">&quot;person&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;@rid&quot;</span>: <span class="s2">&quot;#9:4&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;@type&quot;</span>: <span class="s2">&quot;d&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;@version&quot;</span>: 0
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s all, folks!</p>

<div class="footnotes">
<span>
Notes
</span>
    <ol>
        <li id='fn:1'>In my case, I am retrieving data from OrientDB, a NoSQL graph=document DB which handles data in JSON format over its HTTP interface <a href='#fnref:1' rev='footnote'>↩</a></li>
    </ol>
</div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Desktop notifications for PHPUnit tests on Ubuntu]]></title>
    <link href="http://odino.org/desktop-notifications-for-phpunit-tests-on-ubuntu/"/>
    <updated>2013-06-21T03:48:00+04:00</updated>
    <id>http://odino.org/desktop-notifications-for-phpunit-tests-on-ubuntu</id>
    <content type="html"><![CDATA[<p><img class="left" src="http://odino.org/images/phpunit-notification-ko.png"></p>

<p>As everyone knows, automated tests are great
since they let you test a system without the need
of proactively checking anything: you launch your suite
and you get a feedback; moreover, systems like Jenkins or Travis-CI allow you
to even forget about checking the status of
a build since they can do all of this work for you:
the problem, instead, happens when you need
to run the tests locally, as you always need to
check the shell to know whether the tests passed or not.</p>

<p>A solution would be to launch the tests and mind
your own business, instead of having to check the CLI
output, waiting for a notification that tells
use about the tests&#8217; result.</p>

<!-- more -->


<h2>Notifications to the rescue</h2>

<p>A very simple program, written for Linux, can help
you with this task: it&rsquo;s <code>notify-send</code>.</p>

<p>Given that you have PHPUnit installed via composer
(so the binary is accessible at <code>./vendor/bin/phpunit</code>)
you can simply use a small shell function that can
sends notifications about the tests&#8217; results, that I
put on <a href="https://github.com/odino/phpunit-notifications">Github</a>.</p>

<h2>Installation</h2>

<p>Clone the repository and add the shell function to your
shell profile<sup id='fnref:2'><a href='#fn:2' rel='footnote'>2</a></sup>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd wherever
</span><span class='line'>
</span><span class='line'>git clone git@github.com:odino/phpunit-notifications.git
</span><span class='line'>
</span><span class='line'>chmod +x phpunit-notifications/phpunit-notifications.sh
</span><span class='line'>
</span><span class='line'>echo 'source wherever/phpunit-notifications/phpunit-notifications.sh' &gt;&gt; ~/.zshrc</span></code></pre></td></tr></table></div></figure>


<h2>Usage</h2>

<p>At this point you can open a new shell and run your tests with
the <code>phpunit</code> commmand:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd ~/projects/my-project
</span><span class='line'>
</span><span class='line'>phpunit
</span><span class='line'>
</span><span class='line'>// or
</span><span class='line'>
</span><span class='line'>phpunit -c config
</span><span class='line'>
</span><span class='line'>// or
</span><span class='line'>
</span><span class='line'>phpunit tests/My/Example/ClassTest.php</span></code></pre></td></tr></table></div></figure>


<p><img class="left" src="http://odino.org/images/phpunit-notification-ok.png"></p>

<p>and see that as soon as the tests are over you will
see one of those usual notifications on the top right
of your screen, hopefully telling you that the automated
tests suite is greener than ever.</p>

<p>The <code>notify-send</code> utility is probably not available on
Macs, but I guess you can just replace it with <code>growlnotify</code>.</p>

<p>If you are interested into digging deeper into the topic,
I would suggest you to read a very nice article from
Giulio Di Donato which explains how to <a href="http://welcometothebundle.com/automate-test-and-code-inspection-in-php-with-guard-and-symfony2/">run PHPUnit tests for Symfony2 as soon as any file in your filesystem changes, and get the same type of notifications</a>:
even though I personally think this approach is a little
bit too extreme<sup id='fnref:3'><a href='#fn:3' rel='footnote'>3</a></sup>, it is anyhow interesting as
it pushes automation and time-management to their best limits.</p>

<div class="footnotes">
<span>
Notes
</span>
    <ol>
        <li id='fn:1'>Or, for example, to empty the tables of the right database after each test (there are different databases for each website) <a href='#fnref:1' rev='footnote'>↩</a></li><li id='fn:2'>I am personally using ZSH: https://github.com/robbyrussell/oh-my-zsh <a href='#fnref:2' rev='footnote'>↩</a></li><li id='fn:3'>If you modify 5 files and your test suite is 30secs long, woul will already have to wait 2 and a half minutes <a href='#fnref:3' rev='footnote'>↩</a></li>
    </ol>
</div>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[PHP User Group Dubai, here we start again!]]></title>
    <link href="http://odino.org/php-user-group-dubai-here-we-start-again/"/>
    <updated>2013-06-18T13:38:00+04:00</updated>
    <id>http://odino.org/php-user-group-dubai-here-we-start-again</id>
    <content type="html"><![CDATA[<p>After launching a couple
PHP User Groups in Italy
(<a href="http://roma.grusp.org">Rome</a> and <a href="http://friuli.grusp.org">Friuli</a>),
I started to feel kind of lost here in
Dubai, a place that gathers together lots
of talents but doesn&rsquo;t have that much of
knowledge-sharing culture.</p>

<p>Given this and the pro-active involvement of
some of my colleagues from <a href="http://en-ae.namshi.com">Namshi</a>,
I really wanted to see some sort of community
raise in this desert.</p>

<!-- more -->


<p>So a couple weeks ago I opened a
<a href="https://groups.google.com/forum/?fromgroups#!forum/php-user-group-dubai">google group</a>
for the PHP User Group Dubai &ndash; pretty empty right now &ndash; which is the place
where we&rsquo;re going to discuss meetings, ask for support
and <em>chillax</em> in a nerdy way.</p>

<p>Yesterday we had our first meeting, where 7 of us
discussed on the directions that we should initially take to gain the attention of others in the development community and
which kind of formats to use during our meetings; the main points that came out of the meeting are:</p>

<ul>
<li>we will try to meet once a month</li>
<li>we will try to set and prepare the next meeting before the beginning of Ramadan (~10 July)</li>
<li>everyone will try to bring a new joiner (friend, colleague, etc.) to the next meeting</li>
<li>we will have a talk and a discussion after that, most probably in front of a dinner accompanied by some <em>sheesha</em></li>
<li>most probably, since not everyone is aware of the potential and benefits of automated testing, we will prepare a talk on
PHPUnit</li>
</ul>


<p>So, if you are a PHP developer based in the UAE
&ndash; not necessarily Dubai &ndash; why don&rsquo;t you subscribe
to our <a href="http://groups.google.com/forum/?fromgroups#!forum/php-user-group-dubai">PHP User Group Dubai google group</a> and
introduce yourself? Do you want to understand why testing your applications manually it&rsquo;s a waste of your energies and of money of your company? Do you know about <a href="http://twig.sensiolabs.org">Twig</a>? Have you ever tried developing an application with <a href="http://angularjs.org/">AngularJS</a> and some HTTP APIs as the backend of that app? How can you <a href="http://odino.org/securing-your-http-api-with-javascript-object-signing-and-encryption/">integrate the JWS authentication mechanism in your PHP code</a>?</p>

<p>It would be great to see you at the next meeting!<sup id='fnref:1'><a href='#fn:1' rel='footnote'>1</a></sup></p>

<div class="footnotes">
<span>
Notes
</span>
    <ol>
        <li id='fn:1'>By the way, we will decide the date, location and topic of the meeting with a discussion in the google group <a href='#fnref:1' rev='footnote'>↩</a></li>
    </ol>
</div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Integrating Twig in your legacy code, Part 2: a less wild approach]]></title>
    <link href="http://odino.org/integrating-twig-in-your-legacy-code-part-2-a-less-wild-approach/"/>
    <updated>2013-06-18T12:07:00+04:00</updated>
    <id>http://odino.org/integrating-twig-in-your-legacy-code-part-2-a-less-wild-approach</id>
    <content type="html"><![CDATA[<p>In my last post I wrote about
<a href="http://odino.org/integrating-twig-in-your-legacy-php-code/">integrating Twig into your legacy code</a>
with a really <strong>wild</strong>
approach.</p>

<p>Today I came up with a better
solution that lets you take advantage
of Twig full features without any hack
(like the <code>partial</code> tag I was
talking about in my previous post).</p>

<!-- more -->


<p>Instead of parsing the generated output
as a string with Twig, we can store it
into a template, which lets us use
features like <code>use</code>, <code>extends</code>, <code>include</code>,
thing that is almost impossible &ndash; in a clean way &ndash;
if we use the Twig string loader:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Framework_Base_Controller</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">function</span> <span class="nf">render</span><span class="p">(</span><span class="nv">$templateName</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$parameters</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="c1">// ....</span>
</span><span class='line'>      <span class="c1">// do stuff to render your template</span>
</span><span class='line'>      <span class="c1">// we have the HTML output in the $templateOutput variable</span>
</span><span class='line'>      <span class="c1">// ...</span>
</span><span class='line'>
</span><span class='line'>        <span class="nv">$twig</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Twig_Environment</span><span class="p">(</span><span class="k">new</span> <span class="nx">Twig_Loader_String</span><span class="p">(),</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>          <span class="s1">&#39;autoescape&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>      <span class="p">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="nv">$templateOutput</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Instead of using the <code>Twig_String_Loader</code> we would use an array
loader, and store <code>$templateOutput</code> in a unique template, called <code>__MAIN__</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Framework_Base_Controller</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">function</span> <span class="nf">render</span><span class="p">(</span><span class="nv">$templateName</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$parameters</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="c1">// ....</span>
</span><span class='line'>      <span class="c1">// do stuff to render your template</span>
</span><span class='line'>      <span class="c1">// we have the HTML output in the $templateOutput variable</span>
</span><span class='line'>      <span class="c1">// ...</span>
</span><span class='line'>
</span><span class='line'>      <span class="nv">$finder</span>     <span class="o">=</span> <span class="k">new</span> <span class="nx">Symfony\Component\Finder\Finder</span><span class="p">();</span>
</span><span class='line'>      <span class="nv">$templates</span>  <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">foreach</span> <span class="p">(</span><span class="nv">$finder</span><span class="o">-&gt;</span><span class="na">in</span><span class="p">(</span><span class="s1">&#39;/path/to/twig/templates&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$file</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$file</span><span class="o">-&gt;</span><span class="na">isDir</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>              <span class="nv">$templates</span><span class="p">[</span><span class="nv">$file</span><span class="o">-&gt;</span><span class="na">getRelativePathName</span><span class="p">()]</span> <span class="o">=</span> <span class="nv">$file</span><span class="o">-&gt;</span><span class="na">getContents</span><span class="p">();</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="nv">$loader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Twig_Loader_Array</span><span class="p">(</span><span class="nv">$templates</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$loader</span><span class="o">-&gt;</span><span class="na">setTemplate</span><span class="p">(</span><span class="s1">&#39;__MAIN__&#39;</span><span class="p">,</span> <span class="nv">$templateOutput</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="nv">$twig</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Twig_Environment</span><span class="p">(</span><span class="nv">$loader</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>          <span class="s1">&#39;autoescape&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>      <span class="p">));</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">try</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">twig</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="nv">$templateName</span><span class="p">,</span> <span class="nx">Alice_Component_Registry</span><span class="o">::</span><span class="na">getAll</span><span class="p">());</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Twig_Error_Loader</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">twig</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s2">&quot;__MAIN__&quot;</span><span class="p">,</span> <span class="nx">Alice_Component_Registry</span><span class="o">::</span><span class="na">getAll</span><span class="p">());</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And that&rsquo;s it!</p>

<p>Now you can write your own <code>$templateName</code>:</p>

<figure class='code'><figcaption><span>/path/to/twig/templates/$templateName</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">{</span> % extends <span class="s1">&#39;__MAIN__&#39;</span> % <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">{</span> % use <span class="s1">&#39;whatever&#39;</span> % <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">{</span> % block somewhat % <span class="o">}</span>
</span><span class='line'>  some content
</span><span class='line'><span class="o">{</span> % endblock % <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Integrating Twig in your legacy PHP code]]></title>
    <link href="http://odino.org/integrating-twig-in-your-legacy-php-code/"/>
    <updated>2013-06-15T23:15:00+04:00</updated>
    <id>http://odino.org/integrating-twig-in-your-legacy-php-code</id>
    <content type="html"><![CDATA[<p>It might happen that you are working
on a legacy code that is years old,
with its own templating mechanism<sup id='fnref:1'><a href='#fn:1' rel='footnote'>1</a></sup>
that doesn&rsquo;t really allow you to take
advantage of the benefits that a structured
and object-oriented engine like
<a href="http://twig.sensiolabs.org/">Twig</a>.</p>

<p>In this situations, when a complete replacement
would cost too much to your organization,
you can take advantage of a <em>wild</em> integration between
this advanced template engine and your
existing code.</p>

<!-- more -->




<p class='info info' data-title='Outdated'>This article is outdated! A better approach was described here:<br/> http://integrating-twig-in-your-legacy-code-part-2-a-less-wild-approach/</p>


<h2>Approach</h2>

<p>The main idea is that you should anyway
have a man function which outputs
what is being rendered on the view, so that
you can capture that output and parse it via
Twig, something like a <code>render</code> function
in your controllers:</p>

<figure class='code'><figcaption><span>Example controller</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">My_Controller</span> <span class="k">extends</span> <span class="nx">Framework_Base_Controller</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">function</span> <span class="nf">indexAction</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="c1">// ....</span>
</span><span class='line'>      <span class="c1">// do stuff</span>
</span><span class='line'>      <span class="c1">// ...</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">&#39;my_template&#39;</span><span class="p">,</span> <span class="nv">$parametersForTheView</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Example of a base controller</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Framework_Base_Controller</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">function</span> <span class="nf">render</span><span class="p">(</span><span class="nv">$templateName</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$parameters</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="c1">// ....</span>
</span><span class='line'>      <span class="c1">// do stuff to render your template</span>
</span><span class='line'>      <span class="c1">// ...</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">return</span> <span class="nv">$templateOutput</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// will become</span>
</span><span class='line'>      <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">twig</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="nv">$templateOutput</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>At this point the only thing that
you need is to inject the Twig engine
into your base controller and parse the
output of your legacy templates with Twig<sup id='fnref:2'><a href='#fn:2' rel='footnote'>2</a></sup>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// your actual rendering:</span>
</span><span class='line'><span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">twig</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="nv">$templateOutput</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// which means:</span>
</span><span class='line'><span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">twig</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">&#39;&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello world&lt;/title&gt;...&lt;/html&gt;&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// so that you can actually write twig in your templates:</span>
</span><span class='line'><span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">twig</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">&#39;&lt;html&gt;&lt;head&gt;&lt;title&gt;{ % block title % }Hello world{ % endblock % }&lt;/title&gt;...&lt;/html&gt;&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>




<p class='info warning' data-title='Attention'>The &#8216;block&#8217; tag in the example above is having a space between curly brackets and the percentage char since my blog engine (octopress) doesn&#8217;t allow those tags them in code blocks.<br/>In all of the next examples you will see Twig tags written like that.</p>


<h2>Rendering content via Twig</h2>

<p>To integrate Twig in your application
it it really a matter of a few minutes:
first, you will have to download and move
the library inside your codebase, then,
thanks to the PSR-0 autoloading (here we
will be using Symfony2&rsquo;s autoloader, but
you can use any PSR-0 compliant autoloader) you just
need to include it and setup Twig&rsquo;s own
autoloader:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="k">require_once</span> <span class="nx">__DIR__</span><span class="o">.</span><span class="s1">&#39;/vendor/symfony/Symfony/Component/ClassLoader/UniversalClassLoader.php&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">use</span> <span class="nx">Symfony\Component\ClassLoader\UniversalClassLoader</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$loader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UniversalClassLoader</span><span class="p">();</span>
</span><span class='line'><span class="nv">$loader</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$loader</span><span class="o">-&gt;</span><span class="na">registerNamespaces</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
</span><span class='line'>    <span class="s1">&#39;Twig&#39;</span> <span class="o">=&gt;</span> <span class="nx">__DIR__</span> <span class="o">.</span> <span class="s1">&#39;/vendor/twig/lib/&#39;</span><span class="p">,</span>
</span><span class='line'><span class="p">));</span>
</span><span class='line'>
</span><span class='line'><span class="k">require_once</span> <span class="nx">__DIR__</span> <span class="o">.</span> <span class="s1">&#39;/vendor/twig/lib/Twig/Autoloader.php&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nx">Twig_Autoloader</span><span class="o">::</span><span class="na">register</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>At this point, let&rsquo;s get back to our <code>render</code>
function, which we will need to modify in order
to include Twig:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Framework_Base_Controller</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">function</span> <span class="nf">render</span><span class="p">(</span><span class="nv">$templateName</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$parameters</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="c1">// ....</span>
</span><span class='line'>      <span class="c1">// do stuff to render your template</span>
</span><span class='line'>      <span class="c1">// we have the HTML output in the $templateOutput variable</span>
</span><span class='line'>      <span class="c1">// ...</span>
</span><span class='line'>
</span><span class='line'>        <span class="nv">$twig</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Twig_Environment</span><span class="p">(</span><span class="k">new</span> <span class="nx">Twig_Loader_String</span><span class="p">(),</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>          <span class="s1">&#39;autoescape&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>      <span class="p">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="nv">$templateOutput</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>At this point we would be already able to write
Twig code inside our templates:</p>

<figure class='code'><figcaption><span>my_index.html</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">{ % set posts = registry.get(&#39;blog_post&#39;).findByUser($user.id) % }</span>
</span><span class='line'><span class="x">&lt;p&gt;</span>
</span><span class='line'><span class="x">  { % for post in posts % }</span>
</span><span class='line'><span class="x">      ...</span>
</span><span class='line'><span class="x">  { % else % }</span>
</span><span class='line'><span class="x">      This user didn&#39;t write any post</span>
</span><span class='line'><span class="x">  { % endfor % }</span>
</span><span class='line'><span class="x">&lt;/p&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>A new tag</h2>

<p>Unfortunately, to support some kind of
inheritance, which is one of the greatest
features of Twig, the situation becomes a little
bit trickier: first of all, we will need to add
to the parsed HTML some extra content to override
blocks, then we will need to create a new Twig
token parser in order to allow declaring multiple
blocks with the same name, which is not allowed by the
<code>block</code> tag.</p>

<p>Let&rsquo;s say that all of your templates are including
a base layout made of a very clean HTML structure:</p>

<figure class='code'><figcaption><span>Base layout of your framework</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">&lt;html&gt;</span>
</span><span class='line'><span class="x">  &lt;head&gt;</span>
</span><span class='line'><span class="x">      &lt;title&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$title</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="x">&lt;/title&gt;</span>
</span><span class='line'><span class="x">      ...</span>
</span><span class='line'><span class="x">      ...</span>
</span><span class='line'><span class="x">  &lt;/head&gt;</span>
</span><span class='line'><span class="x">  &lt;body&gt;</span>
</span><span class='line'><span class="x">      </span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$content</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  &lt;/body&gt;</span>
</span><span class='line'><span class="x">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>At this point, since we are able to parse generated
HTMLs with Twig, you can simply add a couple blocks:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">&lt;html&gt;</span>
</span><span class='line'><span class="x">  &lt;head&gt;</span>
</span><span class='line'><span class="x">      &lt;title&gt;</span>
</span><span class='line'><span class="x">          { % block title % }</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$title</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="x">{ % endblock % }</span>
</span><span class='line'><span class="x">      &lt;/title&gt;</span>
</span><span class='line'><span class="x">      ...</span>
</span><span class='line'><span class="x">      ...</span>
</span><span class='line'><span class="x">  &lt;/head&gt;</span>
</span><span class='line'><span class="x">  &lt;body&gt;</span>
</span><span class='line'><span class="x">      { % block content % }</span>
</span><span class='line'><span class="x">          </span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$content</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">      { % endblock% }</span>
</span><span class='line'><span class="x">  &lt;/body&gt;</span>
</span><span class='line'><span class="x">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>After we do it, how can we override these blocks
differently from each controllers&#8217; actions?
You simply include other Twig content at the end of the
generated HTML:</p>

<figure class='code'><figcaption><span>Adding support for basic inheritance</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Framework_Base_Controller</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">function</span> <span class="nf">render</span><span class="p">(</span><span class="nv">$templateName</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$parameters</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="c1">// ....</span>
</span><span class='line'>      <span class="c1">// do stuff to render your template</span>
</span><span class='line'>      <span class="c1">// we have the HTML output in the $templateOutput variable</span>
</span><span class='line'>      <span class="c1">// ...</span>
</span><span class='line'>
</span><span class='line'>        <span class="nv">$twig</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Twig_Environment</span><span class="p">(</span><span class="k">new</span> <span class="nx">Twig_Loader_String</span><span class="p">(),</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>          <span class="s1">&#39;autoescape&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>      <span class="p">));</span>
</span><span class='line'>      <span class="nv">$twigTemplate</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s2">&quot;path/to/twig/templates/%s.twig&quot;</span><span class="p">,</span> <span class="nv">$templateName</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$twigTemplate</span><span class="p">)))</span> <span class="p">{</span>
</span><span class='line'>          <span class="nv">$templateOutput</span> <span class="o">.=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$twigTemplate</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="nv">$templateOutput</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And then override the content with your own twig template:</p>

<figure class='code'><figcaption><span>path/to/twig/templates/templateName.twig</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">{</span> % block title % <span class="o">}</span>
</span><span class='line'>  About: this is our about page
</span><span class='line'><span class="o">{</span> % endblock % <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>After you setup everything, you will realize that
there is a huge problem here: since Twig doesn&rsquo;t allow
to declare blocks Twig, you can use the <code>block</code> tag!</p>

<p>To overcome the problem, you can simply add a new tag,
<code>partial</code>:</p>

<figure class='code'><figcaption><span>The new tag is implemented via a token parser</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="sd">/**</span>
</span><span class='line'><span class="sd"> * Token parser for the twig engine that adds support to redefinable blocks,</span>
</span><span class='line'><span class="sd"> * under the &#39;partial&#39; alias.</span>
</span><span class='line'><span class="sd"> * </span>
</span><span class='line'><span class="sd"> * IE:</span>
</span><span class='line'><span class="sd"> * { % partial myPartial % }First{ % endpartial %}</span>
</span><span class='line'><span class="sd"> * { % partial myPartial % }Second{ % endpartial %}</span>
</span><span class='line'><span class="sd"> * </span>
</span><span class='line'><span class="sd"> * will render &quot;Second&quot;.</span>
</span><span class='line'><span class="sd"> * </span>
</span><span class='line'><span class="sd"> * This is needed since the { % block % } tag doesnt support redefining blocks</span>
</span><span class='line'><span class="sd"> * with the string loader, it just supports it via inheritance.</span>
</span><span class='line'><span class="sd"> */</span>
</span><span class='line'><span class="k">class</span> <span class="nc">PartialTokenParser</span> <span class="k">extends</span> <span class="nx">Twig_TokenParser_Block</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * Parses the twig token in order to replace the &#39;partial&#39; block.</span>
</span><span class='line'><span class="sd">     * </span>
</span><span class='line'><span class="sd">     * @param Twig_Token $token</span>
</span><span class='line'><span class="sd">     * @return Twig_Node_BlockReference</span>
</span><span class='line'><span class="sd">     * @throws Twig_Error_Syntax</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">parse</span><span class="p">(</span><span class="nx">Twig_Token</span> <span class="nv">$token</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$lineno</span> <span class="o">=</span> <span class="nv">$token</span><span class="o">-&gt;</span><span class="na">getLine</span><span class="p">();</span>
</span><span class='line'>        <span class="nv">$stream</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parser</span><span class="o">-&gt;</span><span class="na">getStream</span><span class="p">();</span>
</span><span class='line'>        <span class="nv">$name</span> <span class="o">=</span> <span class="nv">$stream</span><span class="o">-&gt;</span><span class="na">expect</span><span class="p">(</span><span class="nx">Twig_Token</span><span class="o">::</span><span class="na">NAME_TYPE</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getValue</span><span class="p">();</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parser</span><span class="o">-&gt;</span><span class="na">setBlock</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$block</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Twig_Node_Block</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Twig_Node</span><span class="p">(</span><span class="k">array</span><span class="p">()),</span> <span class="nv">$lineno</span><span class="p">));</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parser</span><span class="o">-&gt;</span><span class="na">pushLocalScope</span><span class="p">();</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parser</span><span class="o">-&gt;</span><span class="na">pushBlockStack</span><span class="p">(</span><span class="nv">$name</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nv">$stream</span><span class="o">-&gt;</span><span class="na">test</span><span class="p">(</span><span class="nx">Twig_Token</span><span class="o">::</span><span class="na">BLOCK_END_TYPE</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="nv">$stream</span><span class="o">-&gt;</span><span class="na">next</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>            <span class="nv">$body</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parser</span><span class="o">-&gt;</span><span class="na">subparse</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">&#39;decideBlockEnd&#39;</span><span class="p">),</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nv">$stream</span><span class="o">-&gt;</span><span class="na">test</span><span class="p">(</span><span class="nx">Twig_Token</span><span class="o">::</span><span class="na">NAME_TYPE</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="nv">$value</span> <span class="o">=</span> <span class="nv">$stream</span><span class="o">-&gt;</span><span class="na">next</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getValue</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="nv">$value</span> <span class="o">!=</span> <span class="nv">$name</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig_Error_Syntax</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span><span class="s2">&quot;Expected endblock for block &#39;</span><span class="si">$name</span><span class="s2">&#39; (but %s given)&quot;</span><span class="p">,</span> <span class="nv">$value</span><span class="p">),</span> <span class="nv">$stream</span><span class="o">-&gt;</span><span class="na">getCurrent</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getLine</span><span class="p">(),</span> <span class="nv">$stream</span><span class="o">-&gt;</span><span class="na">getFilename</span><span class="p">());</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="nv">$body</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Twig_Node</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
</span><span class='line'>                <span class="k">new</span> <span class="nx">Twig_Node_Print</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parser</span><span class="o">-&gt;</span><span class="na">getExpressionParser</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">parseExpression</span><span class="p">(),</span> <span class="nv">$lineno</span><span class="p">),</span>
</span><span class='line'>            <span class="p">));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nv">$stream</span><span class="o">-&gt;</span><span class="na">expect</span><span class="p">(</span><span class="nx">Twig_Token</span><span class="o">::</span><span class="na">BLOCK_END_TYPE</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="nv">$block</span><span class="o">-&gt;</span><span class="na">setNode</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">,</span> <span class="nv">$body</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parser</span><span class="o">-&gt;</span><span class="na">popBlockStack</span><span class="p">();</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parser</span><span class="o">-&gt;</span><span class="na">popLocalScope</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nx">Twig_Node_BlockReference</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$lineno</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getTag</span><span class="p">());</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * Returns the tag this parses will look for.</span>
</span><span class='line'><span class="sd">     * </span>
</span><span class='line'><span class="sd">     * @return string</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">getTag</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="s1">&#39;partial&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * Decides when to stop parsing for an open &#39;partial&#39; tag.</span>
</span><span class='line'><span class="sd">     * </span>
</span><span class='line'><span class="sd">     * @param Twig_Token $token</span>
</span><span class='line'><span class="sd">     * @return bool</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">decideBlockEnd</span><span class="p">(</span><span class="nx">Twig_Token</span> <span class="nv">$token</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nv">$token</span><span class="o">-&gt;</span><span class="na">test</span><span class="p">(</span><span class="s1">&#39;endpartial&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then you just need to tell the Twig environment to
add this token parser:</p>

<figure class='code'><figcaption><span>While bootstrapping Twig:</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$twig</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Twig_Environment</span><span class="p">(</span><span class="k">new</span> <span class="nx">Twig_Loader_String</span><span class="p">(),</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>  <span class="s1">&#39;autoescape&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'><span class="p">));</span>
</span><span class='line'><span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">addTokenParser</span><span class="p">(</span><span class="k">new</span> <span class="nx">PartialTokenParser</span><span class="p">());</span>
</span></code></pre></td></tr></table></div></figure>


<p>and at this point you can use it in your templates:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">&lt;html&gt;</span>
</span><span class='line'><span class="x">  &lt;head&gt;</span>
</span><span class='line'><span class="x">      &lt;title&gt;</span>
</span><span class='line'><span class="x">          { % partial title % }</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$title</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="x">{ % endpartial % }</span>
</span><span class='line'><span class="x">      &lt;/title&gt;</span>
</span><span class='line'><span class="x">      ...</span>
</span><span class='line'><span class="x">      ...</span>
</span><span class='line'><span class="x">  &lt;/head&gt;</span>
</span><span class='line'><span class="x">  &lt;body&gt;</span>
</span><span class='line'><span class="x">      { % partial content % }</span>
</span><span class='line'><span class="x">          </span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$content</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">      { % endpartial% }</span>
</span><span class='line'><span class="x">  &lt;/body&gt;</span>
</span><span class='line'><span class="x">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>path/to/twig/templates/templateName.twig</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">{</span> % partial title % <span class="o">}</span>
</span><span class='line'>  About: this is our about page
</span><span class='line'><span class="o">{</span> % endpartial % <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>So?</h2>

<p>If you spot any typo /
mistake please do let me know: I wrote the
example code adapting the one I had from a previous
project so it might be that something slipped my
mind.</p>

<p>Since I never dug <strong>that deep</strong> into
Twig it might be that some things
could be done in a cleaner way, so if
you have suggestions or feedbacks I would
strongly encourage you to go
<em>berserk mode</em> in the comments section below.</p>

<div class="footnotes">
<span>
Notes
</span>
    <ol>
        <li id='fn:1'>Being PHP or something like Smarty or xTemplate <a href='#fnref:1' rev='footnote'>↩</a></li><li id='fn:2'>Unfortunately, to do so we will have to turn off Twig&#8217;s default escaping strategy <a href='#fnref:2' rev='footnote'>↩</a></li>
    </ol>
</div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Configuring a Symfony2 application to support SOA]]></title>
    <link href="http://odino.org/configuring-a-symfony2-application-to-support-soa/"/>
    <updated>2013-06-06T13:00:00+04:00</updated>
    <id>http://odino.org/configuring-a-symfony2-application-to-support-soa</id>
    <content type="html"><![CDATA[<p>When you think in terms of
<a href="http://odino.org/refactoring-your-architecture-go-for-soa/">Service Oriented Architecture</a>
one of the tricky things is to decide
how to organize your development workflow
in order to develop <strong>architecture</strong>,
not a single application: for example, how would
you configure deployments (when you need
to deploy <strong>part</strong> of your architecture, not
just a web application) or push cross-service
features to your SCM?</p>

<!-- more -->


<p>This article gives an overview of the constraints
and preferences that we wanted to implement
in our SOA, which is mainly done with Symfony2,
but most of it can be read in a
framework/language-agnostic key.</p>

<h2>Problems</h2>

<p>We can at least identify 3 problems which pop
up after you decide to layer your architecture
and avoid <a href="http://www.slideshare.net/odino/the-rocket-internet-experience-phptostart-2013-in-turin/103">a monolithic approach</a>:</p>

<ul>
<li><p>given that every of your service will require
some time (1~5 minutes) to be deployed, how do you
ensure that you can release a new version of a service
without the need of updating <strong>all</strong> the other
services?
If you have, for example, 9 machines and 3 services
(A, B and C, 3 machines for each service),
you cant really afford to <strong>deploy everywhere</strong>
when you need to update just the service A, because
you might need to shutdown service B and C during the
deployment, while they dont really need to be updated.
The solution here would be to update just a bunch of
your servers</p></li>
<li><p>how do you create <em>Pull Requests</em> and organize your
repositories? This is not a trivial question: if you
need a feature that involves changes in services A and B,
and you have 2 repositories you will need to add some
overhead on top of every single operation that you
would usually do with a new feature</p></li>
<li><p>is your software able to automatically support SOA?
By this I mean, when you want to add a new service,
how easy is to configure your architecture to be able
to support the new layer? Of course, you would need
something that lets you do this in a matter of a minute</p></li>
</ul>


<h2>Deployments</h2>

<p>As I stated earlier, the solution is to be able
to specify, upon deployments, which services need
to be updated, and your best friend, here, could
be something like <a href="https://github.com/capistrano/capistrano">Capistrano</a>.</p>

<p>If you ever worked with capistrano, you know
that deployments basically depend on the <code>deploy.rb</code> file,
in which you can configure different <strong>stages</strong> of your
architecture:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">set</span> <span class="ss">:stages</span><span class="p">,</span> <span class="sx">%w(live staging)</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:default_stage</span><span class="p">,</span> <span class="s2">&quot;staging&quot;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;capistrano/ext/multistage&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the example, weare declaring that our application
can be deployed on 2 stages, <code>live</code> and <code>staging</code>; by doing a
<code>cap live deploy</code> or <code>cap deploy</code> you are ready to either deploy to your live
servers or staging ones, after configuring the staging
files (<code>live.rb</code> and <code>staging.rb</code>):</p>

<figure class='code'><figcaption><span>An example live.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">role</span> <span class="ss">:web</span><span class="p">,</span>        <span class="s2">&quot;company.com&quot;</span>
</span><span class='line'><span class="n">role</span> <span class="ss">:app</span><span class="p">,</span>        <span class="s2">&quot;company.com&quot;</span><span class="p">,</span> <span class="ss">:primary</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'><span class="n">role</span> <span class="ss">:db</span><span class="p">,</span>         <span class="s2">&quot;company.com&quot;</span><span class="p">,</span> <span class="ss">:primary</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'>
</span><span class='line'><span class="n">set</span> <span class="ss">:app_environment</span><span class="p">,</span> <span class="s2">&quot;live&quot;</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:deploy_to</span><span class="p">,</span>   <span class="s2">&quot;/var/www/htdocs/</span><span class="si">#{</span><span class="n">application</span><span class="si">}</span><span class="s2">.</span><span class="si">#{</span><span class="n">app_environment</span><span class="si">}</span><span class="s2">&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This still doesn&rsquo;t solve the problem of
<strong>just deploying a single service</strong>, but to
overcome it, thanks to the capistrano <code>multistage</code>
extension, it&rsquo;s a matter of configuring a few deployment
files.</p>

<p>For example, here&rsquo;s how you would write your deployment
files once you have a couple services (<code>A</code> and <code>B</code>):</p>

<figure class='code'><figcaption><span>deploy.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">set</span> <span class="ss">:stages</span><span class="p">,</span> <span class="sx">%w(a-live a-staging b-live b-staging, live, staging)</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:default_stage</span><span class="p">,</span> <span class="s2">&quot;staging&quot;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;capistrano/ext/multistage&#39;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>a-live.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">role</span> <span class="ss">:web</span><span class="p">,</span>        <span class="s2">&quot;a.company.com&quot;</span>
</span><span class='line'><span class="n">role</span> <span class="ss">:app</span><span class="p">,</span>        <span class="s2">&quot;a.company.com&quot;</span><span class="p">,</span> <span class="ss">:primary</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'><span class="n">role</span> <span class="ss">:db</span><span class="p">,</span>         <span class="s2">&quot;a.company.com&quot;</span><span class="p">,</span> <span class="ss">:primary</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'>
</span><span class='line'><span class="n">set</span> <span class="ss">:app_environment</span><span class="p">,</span> <span class="s2">&quot;live&quot;</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:deploy_to</span><span class="p">,</span>   <span class="s2">&quot;/var/www/htdocs/</span><span class="si">#{</span><span class="n">application</span><span class="si">}</span><span class="s2">.</span><span class="si">#{</span><span class="n">app_environment</span><span class="si">}</span><span class="s2">&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you see, we are creating a few different stages:</p>

<ul>
<li><code>serviceName-environment</code> (ie. a-live), which includes servers for a
specific environment of a service</li>
<li><code>environment</code> (ie. live), which includes the entire architecture,
useful in those cases when you really want to deploy
the entire architecture<sup id='fnref:1'><a href='#fn:1' rel='footnote'>1</a></sup></li>
</ul>


<p>For Symfony2, to ease your job, you can use
<a href="http://capifony.org/">capifony</a> which takes
care of configure the remaining,
specific, crucial parts of the deployment for the
framework (such as clearing and warming up the cache,
installing the dependencies via composer and so on).</p>

<h2>Software lifecycle</h2>

<p><img class="left" src="http://odino.org/images/cylinders.png"></p>

<p>Ah, good old SCM problems!</p>

<p>Let&rsquo;s say your are working on a traditional, monolithic application:
you branch to implement a new feature, commit, push, open
a pull request, the PR gets merged, deployed on staging, tested and
then goes to live; very simple as well as efficient:
<strong>zero overhead</strong>.</p>

<p>You might think that in SOAs this is not different: you <code>cd</code> into a
specific&rsquo;s service repository, branch to
implement a new feature, commit, push, open
a pull request, the PR gets merged in that repository, the service gets deployed
on its staging servers, tested and then goes to live;
very simple as well as efficient?</p>

<p>No, at all.</p>

<p>Thing is, often you will need to develop <strong>cross-service
features</strong>, which require code to be updated in N different
repositories: as a result, you will need to open N pull requests;
<span class='pullquote-right' data-pullquote='to be on the safe side, being able to rollback the
entire architecture is a must'>
if you think that this is not a problem, consider what happens
once you pack and test everything and are ready to go live:
a critical bug is found, and it couldn&rsquo;t have been discovered
earlier since it just happens due to some specific configuration
that you have on the live environments: time to <strong>rollback N new services</strong>.</p>

<p>Since rollbacking is a very critical operation<sup id='fnref:2'><a href='#fn:2' rel='footnote'>2</a></sup>, you
want to rollback each of the affected services separately, which makes your
downtimes N times slower than a usual, monolithic rollback: in these
cases, to be on the safe side, being able to rollback the
entire architecture is a must.
</span></p>

<p>That&rsquo;s why I would advice to keep all of your services under
one repositories, to avoid overheads:</p>

<ul>
<li>N projects in your IDE</li>
<li>N SCM operations (<code>git checkout -b myBranch</code> as well as <code>git push origin myBranch</code>)</li>
<li>N pull requests</li>
<li>N code reviews</li>
</ul>


<p>Due to this, honestly, I don&rsquo;t really see the need of separating services
into different repositories: when you deploy, you deploy a tag of the architecture
itself (only on the servers which host the services to be updated with that tag),
when you rollback, you rollback the entire architecture to a specific
version.</p>

<p><img class="left" src="http://odino.org/images/baby-birds.jpg"></p>

<p>This seems to go against what I preached earlier, while talking
about deployments, but the truth is that you want to be on the safe side
once something goes wrong: you can optimize deployments so that you can
just deploy some services, but in case of rollback, you need to take an
immediate, &ldquo;total&rdquo; action to <strong>restore all of your services</strong>.</p>

<p>Consider the situation from a very similar perspective coming
from a very, very different context: cultivate an healthy colony of newborns
in nature &ndash; as opposed to maintaining an healthy architecture on the internets.</p>

<p>Exactly like the mom of newborn birds, when it comes to feed (update)
them, you would give the weaker ones, in order to help them develop as healthy
as their stronger brothers, the biggest meals; but when it comes
to rescue (rollback) them from a predator, you would crave for having an
option to move them all in one go, without the risk of moving them one by
one, leaving the unluckiest ones defenseless against their own fate.</p>

<h2>Configuring new services in Symfony2</h2>

<p><img class="right" src="http://odino.org/images/cubic-architecture.jpg"></p>

<p>This post has to come to an end dealing with Symfony2,
since, in our experience,
<a href="http://odino.org/why-we-choose-symfony2-over-any-other-php-framework/">we have decided to go SOA with this framework</a>:
all in all, we found that due to the integration with capistrano
and the concept of bundles, together with the ability to have
per-bundle specific hostnames, this framework is pretty friendly
towards the ideas and constraints that we want to implement in
our SOA: what we&rsquo;ve seen is no rocket science, and even
the approach that we are using with Symfony2 is nothing
extraordinary, but it helps maintaining a very clean and
efficient workflow while developing a SOA.</p>

<p>As I said, for deploying you might want to use capifony,
and when it comes to isolate services in just one repository
we realized that a good solution would be to have <strong>one
Symfony2 application</strong> and create <strong>a bundle for each service</strong>
that we need.</p>

<p>Thanks for the capabilities of Symfony2&rsquo;s routing
mechanism, you can also bind a subdomain to a specific
bundle; once you create the bundle, you can tell symfony
that the routes of that specific bundle can be matched only
if the subdomain of the application matches a particular
string:</p>

<figure class='code'><figcaption><span>app/config/routing.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mycompany_service_a:
</span><span class='line'>    resource: <span class="s2">&quot;@AcmeServiceABundle/Resources/config/routing.yml&quot;</span>
</span><span class='line'>    prefix:   /
</span><span class='line'>    host:     service-a.mycompany.com
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>src/Acme/ServiceABundle/Resources/config/routing.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mycompany_service_a_index:
</span><span class='line'>    pattern:  /index/<span class="o">{</span>whateverParameter<span class="o">}</span>
</span><span class='line'>    defaults: <span class="o">{</span> _controller: AcmeServiceABundle:Default:index <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this case, the route <code>mycompany_service_a_index</code> will only
be matched when the URL is using the hostname
<code>service-a.mycompany.com</code>: for example, <code>http://mycompany.com/index/param</code>
won&rsquo;t match it; this is pretty interesting since it gives you the
flexibility to develop features in just once repository, on
<strong>as many services as you want</strong>.</p>

<p>We are still heavily experimenting, but out of a few approaches &ndash;
for example <a href="http://symfony.com/doc/2.0/book/routing.html#prefixing-imported-routes">route prefixing</a> &ndash;
we decided to go on with the ones I explained here for cleanness,
clarity, efficiency and security of your development cycles
and architecture: if your experience suggests something different
or you want to share doubts, feel free to abuse of the comments
section, since I am very open and interested to discuss this topic.</p>

<div class="footnotes">
<span>
Notes
</span>
    <ol>
        <li id='fn:1'>Cases such as disaster recovery or deployments to a brand new servers&#8217; set (for example, if you want to switch from AWS to another provider) <a href='#fnref:1' rev='footnote'>↩</a></li><li id='fn:2'>Rollbacking, per se, shouldn&#8217;t be a pain in the ass, but you need to focus on it in order to reduce mistakes in an already-critical situation <a href='#fnref:2' rev='footnote'>↩</a></li>
    </ol>
</div>

]]></content>
  </entry>
  
</feed>