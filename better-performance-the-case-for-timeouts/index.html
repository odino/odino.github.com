
<!doctype html>
<!-- BEGIN _layouts/default.html -->
<html>
	<head>
		<meta charset="utf-8">
		
		<meta content="Use timeouts to build more robust and less expensive distributed systems: less memory, less downtime, more fun!" name="description">
		<meta content="Alessandro Nadalin" name="author">
		
		<title>Better performance: the case for timeouts</title>
		<meta name="google-site-verification" content="dSNHLHJFQzKASjN8qHJisk2XLkKqbF_ilGSj9bscwKs" />
		<link href="/favicon.png" rel="icon">
		<link href="/stylesheets/screen.css" rel="stylesheet">
		<link href="/atom.xml" rel="alternate" title="Alessandro Nadalin" type="application/atom+xml">
		<link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" type="text/css" href="/MyFontsWebfontsKit.css">

		<meta name="twitter:card" content="summary" />
		<meta name="twitter:creator" content="@_odino_" />
		<meta property="og:url" content="https://odino.org/better-performance-the-case-for-timeouts/" />
		<meta property="og:title" content="Better performance: the case for timeouts" />
		<meta property="og:description" content="Use timeouts to build more robust and less expensive distributed systems: less memory, less downtime, more fun!" />
		
	</head>
	<body>
		<div class="wrap">
			<header>
				<div class="navi">
					<ul>
                        <li><a href="/"><i class="icon-home icon-large"></i> Home</a></li>
                        <li><a href="/about"><i class="icon-user icon-large"></i> About</a></li>
                        <li><a href="/conferences"><i class="icon-group icon-large"></i> Conferences</a></li>
                        <li><a href="/archives"><i class="icon-briefcase icon-large"></i> Archives</a></li>
                        <li><a href="/atom.xml"><i class="icon-rss icon-large"></i> RSS</a></li>
					</ul>
				</div>
			</header>
			<!-- BEGIN _layouts/post.html -->

    <header>
        <h1><a href="/better-performance-the-case-for-timeouts/">Better performance: the case for timeouts</a></h1>
        <time>19 January 2017</time>
        <!-- 
        
        
        
          <br />
          <time>(note: this post was written 4 years ago and might be outdated)</time>
         -->
    </header>
<div class="entry-content "><p>Most of the larger-scale services that we design
nowadays depend, more or less, on external APIs:
you&rsquo;ve heard it multiple times, as soon as your codebase
starts to look like a monolith it&rsquo;s time to start
splitting it into <a href="https://en.wikipedia.org/wiki/Microservices">smaller services</a>
that can evolve independently and aren&rsquo;t strongly
coupled with the monolith.</p>

<p>Even if you don&rsquo;t really employ microservices, chances
are that you already depend on external services, such
as <a href="https://en.wikipedia.org/wiki/Elasticsearch">elasticsearch</a>,
<a href="https://redis.io/">redis</a> or a payment gateway, and need to integrate
with them via some kind of APIs.</p>

<p>What happens when those services are slow or unavailable? Well,
you can&rsquo;t process search queries, or payments, but your
app would still be working &ldquo;fine&rdquo; &mdash; right?</p>

<p><strong>That is not always the case</strong>, and I want to run a few
benchmarks to show you how a little tweak, <a href="https://en.wikipedia.org/wiki/Timeout_(computing">timeouts</a>,
prove beneficial when dealing with external services.</p>

<!-- more -->


<h2>Our case</h2>

<p>We&rsquo;ve started a new <em>Hello World!</em> startup that,
surprisingly, makes money by deploying a useless
service that prints a string retrieved from another
service: as you understand,
this is an oversimplification of a real-world
scenario, but it will serve our purpose well enough.</p>

<p><img class="center" src="/images/a-b-service.png"></p>

<p>Our clients will be connecting to our main frontend,
<code>server1.js</code> which will then make an HTTP request towards
another service, <code>server2.js</code> which will reply back:
once we have an answer from <code>server2.js</code>  we can then
return the response body to our client.</p>

<figure class='code'><figcaption><span>server1.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">let</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;unirest&#39;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;http://localhost:3001&#39;</span><span class="p">).</span><span class="nx">end</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">error</span> <span class="o">?</span> <span class="mi">500</span> <span class="o">:</span> <span class="mi">200</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">res</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">error</span> <span class="o">?</span> <span class="nx">r</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span> <span class="o">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
</span><span class='line'>  <span class="p">})</span>
</span><span class='line'><span class="p">}).</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>server2.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">let</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">_</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">res</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">&#39;Hello!&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
</span><span class='line'>  <span class="p">},</span> <span class="mi">100</span><span class="p">)</span>
</span><span class='line'><span class="p">}).</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3001</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>A few things to note:</p>

<ul>
<li>the servers run on port <code>3000</code> (main app) and <code>3001</code> (&ldquo;backend&rdquo; server): so once the client will make a request to <code>localhost:3000</code> a new HTTP request will be sent to <code>localhost:3001</code></li>
<li>the backend service will wait 100ms (this is to simulate real-world use cases) before returning a response</li>
<li>I&rsquo;m using the <a href="https://github.com/Mashape/unirest-nodejs">unirest</a> HTTP client: I like it a lot and, even though we could have simply used the built-in <code>http</code> module, I&rsquo;m confident this will gives us a better feeling in terms of real-world applications</li>
<li>unirest is nice enough to tell us if there was an error on our request, so we can just check <code>response.error</code> and handle the drama from there</li>
<li>I&rsquo;m going to be using <a href="https://www.docker.com/">docker</a> to run these tests, and the code is <a href="https://github.com/odino/the-case-for-timeouts">available on github</a></li>
</ul>


<h2>Let&rsquo;s run our first tests</h2>

<p>Let&rsquo;s run our servers and start bombing <code>server1.js</code> with
requests: we&rsquo;ll be using <a href="https://www.joedog.org/siege-home/">siege</a> (I&rsquo;m too hipster for <a href="https://httpd.apache.org/docs/2.4/programs/ab.html">AB</a>),
which provides some useful info upon executing the load test:</p>

<figure class='code'><figcaption><span>server2.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">siege</span> <span class="o">-</span><span class="nx">c</span> <span class="mi">5</span> <span class="nx">www</span><span class="p">.</span><span class="nx">google</span><span class="p">.</span><span class="nx">com</span>
</span><span class='line'><span class="o">**</span> <span class="nx">SIEGE</span> <span class="mf">3.0</span><span class="p">.</span><span class="mi">5</span>
</span><span class='line'><span class="o">**</span> <span class="nx">Preparing</span> <span class="mi">5</span> <span class="nx">concurrent</span> <span class="nx">users</span> <span class="k">for</span> <span class="nx">battle</span><span class="p">.</span>
</span><span class='line'><span class="nx">The</span> <span class="nx">server</span> <span class="nx">is</span> <span class="nx">now</span> <span class="nx">under</span> <span class="nx">siege</span><span class="p">...</span><span class="o">^</span><span class="nx">C</span>
</span><span class='line'><span class="nx">Lifting</span> <span class="nx">the</span> <span class="nx">server</span> <span class="nx">siege</span><span class="p">...</span>      <span class="nx">done</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="nx">Transactions</span><span class="o">:</span>                <span class="mi">26</span> <span class="nx">hits</span>
</span><span class='line'><span class="nx">Availability</span><span class="o">:</span>            <span class="mf">100.00</span> <span class="o">%</span>
</span><span class='line'><span class="nx">Elapsed</span> <span class="nx">time</span><span class="o">:</span>              <span class="mf">6.78</span> <span class="nx">secs</span>
</span><span class='line'><span class="nx">Data</span> <span class="nx">transferred</span><span class="o">:</span>          <span class="mf">0.20</span> <span class="nx">MB</span>
</span><span class='line'><span class="nx">Response</span> <span class="nx">time</span><span class="o">:</span>             <span class="mf">0.52</span> <span class="nx">secs</span>
</span><span class='line'><span class="nx">Transaction</span> <span class="nx">rate</span><span class="o">:</span>          <span class="mf">3.83</span> <span class="nx">trans</span><span class="o">/</span><span class="nx">sec</span>
</span><span class='line'><span class="nx">Throughput</span><span class="o">:</span>                <span class="mf">0.03</span> <span class="nx">MB</span><span class="o">/</span><span class="nx">sec</span>
</span><span class='line'><span class="nx">Concurrency</span><span class="o">:</span>               <span class="mf">2.01</span>
</span><span class='line'><span class="nx">Successful</span> <span class="nx">transactions</span><span class="o">:</span>          <span class="mi">27</span>
</span><span class='line'><span class="nx">Failed</span> <span class="nx">transactions</span><span class="o">:</span>              <span class="mi">0</span>
</span><span class='line'><span class="nx">Longest</span> <span class="nx">transaction</span><span class="o">:</span>           <span class="mf">1.28</span>
</span><span class='line'><span class="nx">Shortest</span> <span class="nx">transaction</span><span class="o">:</span>          <span class="mf">0.36</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>-c</code> option, in siege, defines how many concurrent requests
we should send to the server, and you can even specify how many
repetitions (<code>-r</code>) you&rsquo;d like to run: for example, <code>-c 10 -r 5</code>
would mean we&rsquo;d be sending to the server 50 total requests, in
batches of 10 concurrent requests. For the purpose of our benchmark
I decided, though, to keep the tests running for 3 minutes and
analyze the results afterwards, without setting a max number of
repetitions.</p>

<p>Additionally, in my next examples I will be trimming down the results
to the most important items provided by siege:</p>

<ul>
<li>availability: how many of our requests was the server able to handle</li>
<li>transaction rate: how many requests per second we were able to male</li>
<li>successful / failed transactions: how many requests ended up with successful / failure status codes (ie. 2xx vs 5xx)</li>
</ul>


<p>Let&rsquo;s start by sending 500 concurrent requests to observe how the services
behave.</p>

<figure class='code'><figcaption><span>server2.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">docker</span> <span class="nx">run</span> <span class="o">--</span><span class="nx">net</span> <span class="nx">host</span> <span class="o">-</span><span class="nx">v</span> <span class="nx">$</span><span class="p">(</span><span class="nx">pwd</span><span class="p">)</span><span class="o">:</span><span class="err">/src -d mhart/alpine-node:7.1 node /src/server1.js</span>
</span><span class='line'><span class="nx">docker</span> <span class="nx">run</span> <span class="o">--</span><span class="nx">net</span> <span class="nx">host</span> <span class="o">-</span><span class="nx">v</span> <span class="nx">$</span><span class="p">(</span><span class="nx">pwd</span><span class="p">)</span><span class="o">:</span><span class="err">/src -d mhart/alpine-node:7.1 node /src/server2.js</span>
</span><span class='line'>
</span><span class='line'><span class="nx">siege</span> <span class="o">-</span><span class="nx">c</span> <span class="mi">500</span> <span class="mf">127.0</span><span class="p">.</span><span class="mf">0.1</span><span class="o">:</span><span class="mi">3000</span>
</span></code></pre></td></tr></table></div></figure>


<p>After around 3 minutes, it&rsquo;s time to stop siege (<code>ctrl+c</code>) and see how the results
look like:</p>

<figure class='code'><figcaption><span>server2.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">Availability</span><span class="o">:</span>             <span class="mf">100.00</span> <span class="o">%</span>
</span><span class='line'><span class="nx">Transaction</span> <span class="nx">rate</span><span class="o">:</span>       <span class="mf">1156.89</span> <span class="nx">trans</span><span class="o">/</span><span class="nx">sec</span>
</span><span class='line'><span class="nx">Successful</span> <span class="nx">transactions</span><span class="o">:</span>      <span class="mi">205382</span>
</span><span class='line'><span class="nx">Failed</span> <span class="nx">transactions</span><span class="o">:</span>              <span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure>


<p>Not bad, as we&rsquo;ve been able to serve 1156 transactions per second;
even better than that, it doesn&rsquo;t seem like we&rsquo;ve got any
error, which means our success rate is 100%.
What if we up our game and go for 1k concurrent transactions?</p>

<figure class='code'><figcaption><span>server2.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">siege</span> <span class="o">-</span><span class="nx">c</span> <span class="mi">1000</span> <span class="mf">127.0</span><span class="p">.</span><span class="mf">0.1</span><span class="o">:</span><span class="mi">3000</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="nx">Availability</span><span class="o">:</span>            <span class="mf">100.00</span> <span class="o">%</span>
</span><span class='line'><span class="nx">Transaction</span> <span class="nx">rate</span><span class="o">:</span>       <span class="mf">1283.61</span> <span class="nx">trans</span><span class="o">/</span><span class="nx">sec</span>
</span><span class='line'><span class="nx">Successful</span> <span class="nx">transactions</span><span class="o">:</span>      <span class="mi">232141</span>
</span><span class='line'><span class="nx">Failed</span> <span class="nx">transactions</span><span class="o">:</span>              <span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure>


<p>Well, well done: we slightly increased throughput, as now our app
is able to handle 1283 requests per second: since the apps
do very less (print a string and that&rsquo;s it) it is likely that
the more concurrent requests we&rsquo;ll send the higher the throughput.</p>

<p>These numbers might be useless now (we&rsquo;re not comparing them
to anything) but will prove essential in the next paragraphs.</p>

<h2>Introducing failure</h2>

<p>This is not how real-world webservices behave: you have
to <strong>accept failures</strong> and build resilient applications
that are capable of overcoming them.</p>

<p>For example, suppose our backend service is going through
a hard phase and starts lagging every now and then:</p>

<figure class='code'><figcaption><span>server2.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">let</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'><span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">let</span> <span class="nx">delay</span> <span class="o">=</span> <span class="mi">100</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">delay</span> <span class="o">=</span> <span class="mi">10000</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">i</span><span class="o">++</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">_</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">res</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">&#39;Hello!&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
</span><span class='line'>  <span class="p">},</span> <span class="nx">delay</span><span class="p">)</span>
</span><span class='line'><span class="p">}).</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3001</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this example, 1 out of 10 requests will be served after a
timeout of 10s has passed, whereas the other ones will be
processed with the &ldquo;standard&rdquo; delay of 100ms: this kind of
simulates a scenario where we have multiple servers behind
a load balancer, and one of them starts throwing random
errors or becomes slower due to excessive load.</p>

<p>Let&rsquo;s go back to our benchmark and see how our <code>server1.js</code>
performs now that its dependency will start to slow down:</p>

<figure class='code'><figcaption><span>server2.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">siege</span> <span class="o">-</span><span class="nx">c</span> <span class="mi">1000</span> <span class="mf">127.0</span><span class="p">.</span><span class="mf">0.1</span><span class="o">:</span><span class="mi">3000</span>
</span><span class='line'>
</span><span class='line'><span class="nx">Availability</span><span class="o">:</span>            <span class="mf">100.00</span> <span class="o">%</span>
</span><span class='line'><span class="nx">Transaction</span> <span class="nx">rate</span><span class="o">:</span>        <span class="mf">853.93</span> <span class="nx">trans</span><span class="o">/</span><span class="nx">sec</span>
</span><span class='line'><span class="nx">Successful</span> <span class="nx">transactions</span><span class="o">:</span>      <span class="mi">154374</span>
</span><span class='line'><span class="nx">Failed</span> <span class="nx">transactions</span><span class="o">:</span>              <span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>What a bummer</strong>: our transaction rate has plummeted,
down by more than 30%, just because some of the responses
are lagging &mdash; this means that <code>server1.js</code> needs
to hold on for longer in order to receive responses
from <code>server2.js</code>, thus using more resources and being
able to serve less requests than it theoretically can.</p>

<h2>An error now is better than a response tomorrow</h2>

<p>The case for timeouts starts by recognizing one simple
fact: <strong>users won&rsquo;t wait for slow responses</strong>.</p>

<p>After 1 or 2 seconds, their attention will fade away and the
chances that they might still be hooked to your content
will vanish as soon as you cross the 4/5s threshold &mdash;
this mean that <strong>it&rsquo;s generally better to give them
an immediate feedback,
even if negative</strong> (&ldquo;<em>An error occurred, please try again</em>&rdquo;),
rather than letting them get frustrated over how slow your
service is.</p>

<p>In the spirit of &ldquo;<a href="https://en.wikipedia.org/wiki/Fail-fast">fail fast</a>&rdquo;, we decide to add a timeout
in order to make sure that our responses meet a certain SLA:
in this case, we decide that our SLA is 3s, which is the
time our users will possibly wait to use our service<sup id='fnref:1'><a href='#fn:1' rel='footnote'>1</a></sup>.</p>

<figure class='code'><figcaption><span>server1.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;unirest&#39;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;http://localhost:3001&#39;</span><span class="p">).</span><span class="nx">timeout</span><span class="p">(</span><span class="mi">3000</span><span class="p">).</span><span class="nx">end</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s see how the numbers look like with timeouts enabled:</p>

<figure class='code'><figcaption><span>server1.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">Availability</span><span class="o">:</span>              <span class="mf">90.14</span> <span class="o">%</span>
</span><span class='line'><span class="nx">Transaction</span> <span class="nx">rate</span><span class="o">:</span>       <span class="mf">1125.26</span> <span class="nx">trans</span><span class="o">/</span><span class="nx">sec</span>
</span><span class='line'><span class="nx">Successful</span> <span class="nx">transactions</span><span class="o">:</span>      <span class="mi">209861</span>
</span><span class='line'><span class="nx">Failed</span> <span class="nx">transactions</span><span class="o">:</span>          <span class="mi">22964</span>
</span></code></pre></td></tr></table></div></figure>


<p>Oh boy, we&rsquo;re back into the game: the transaction rate is
again higher than 1k per second and we can almost serve
as many requests as we&rsquo;d do under ideal conditions (when
there&rsquo;s no lag in the backend service).</p>

<p>Of course, one of the drawbacks is that we have now
increased the number of failures (10% of total requests),
which means that some
users will be presented an error page &mdash; still better,
though, than serving them after 10s, as most of them
would have abandoned our service anyway.</p>

<p><span class='pullquote-right' data-pullquote='timeouts help you preserve
near-ideal rps'>
We&rsquo;ve now seen that, ideally, <strong>timeouts help you preserve
near-ideal rps</strong> (requests per second), but what about
resource consumption? Will they be better at
making sure that our servers won&rsquo;t require
extra resources if one of their dependencies becomes
less responsive?
</span></p>

<p>Let&rsquo;s dig into it.</p>

<h2>The RAM factor</h2>

<p>In order to figure out how much memory our <code>server1.js</code>
is consuming, we need to measure, at intervals, the amount
of memory the server is using; in production, we would
use tools such as <a href="https://newrelic.com/">NewRelic</a> or <a href="https://keymetrics.io/">KeyMetrics</a>
but, for our simple scripts, we&rsquo;ll resort to the poor man&rsquo;s
version of such tools: we&rsquo;ll be printing the amount of
memory from <code>server1.js</code> and we&rsquo;ll use another script
to record the output and print some simple stats.</p>

<p>Let&rsquo;s make sure <code>server1.js</code> prints the amount of memory
used every 100ms:</p>

<figure class='code'><figcaption><span>server1.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="nx">setInterval</span><span class="p">(</span><span class="nx">_</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">memoryUsage</span><span class="p">().</span><span class="nx">heapUsed</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">)</span>
</span><span class='line'><span class="p">},</span> <span class="mi">100</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>If we start the server we should see something like:</p>

<figure class='code'><figcaption><span>server1.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="mf">3.990176</span>
</span><span class='line'><span class="mf">4.066752</span>
</span><span class='line'><span class="mf">4.076024</span>
</span><span class='line'><span class="mf">4.077784</span>
</span><span class='line'><span class="mf">4.079544</span>
</span><span class='line'><span class="mf">4.081304</span>
</span><span class='line'><span class="mf">4.083064</span>
</span><span class='line'><span class="mf">4.084824</span>
</span></code></pre></td></tr></table></div></figure>


<p>which is the amount of memory, in MB, that the server is
using: in order to crunch the numbers I wrote a simple script
that reads the input from the <code>stdin</code> and computes the stats:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">let</span> <span class="nx">inputs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>
</span><span class='line'><span class="nx">process</span><span class="p">.</span><span class="nx">stdin</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">inputs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="mi">10</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">let</span> <span class="nx">min</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(...</span><span class="nx">inputs</span><span class="p">))</span>
</span><span class='line'>  <span class="kd">let</span> <span class="nx">max</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(...</span><span class="nx">inputs</span><span class="p">))</span>
</span><span class='line'>  <span class="kd">let</span> <span class="nx">avg</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">inputs</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">)</span> <span class="o">/</span> <span class="nx">inputs</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
</span><span class='line'>  <span class="kd">let</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">inputs</span><span class="p">[</span><span class="nx">inputs</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="err">`</span><span class="nx">Meas</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">inputs</span><span class="p">.</span><span class="nx">length</span><span class="p">}</span> <span class="nx">Min</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">min</span><span class="p">}</span> <span class="nx">Max</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">max</span><span class="p">}</span> <span class="nx">Avg</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">avg</span><span class="p">}</span> <span class="nx">Cur</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">cur</span><span class="p">}</span><span class="err">\</span><span class="nx">r</span><span class="err">`</span><span class="p">)</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>The module is <a href="https://github.com/odino/node-number-aggregator-stats">public</a>
and <a href="https://www.npmjs.com/package/number-aggregator-stats">available on NPM</a>,
so we can just install it globally and redirect the output of the server to it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">docker</span> <span class="nx">run</span> <span class="o">--</span><span class="nx">net</span> <span class="nx">host</span> <span class="o">-</span><span class="nx">v</span> <span class="nx">$</span><span class="p">(</span><span class="nx">pwd</span><span class="p">)</span><span class="o">:</span><span class="err">/src -ti mhart/alpine-node:7.1 sh</span>
</span><span class='line'><span class="nx">npm</span> <span class="nx">install</span> <span class="o">-</span><span class="nx">g</span> <span class="nx">number</span><span class="o">-</span><span class="nx">aggregator</span><span class="o">-</span><span class="nx">stats</span>
</span><span class='line'><span class="nx">node</span> <span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">server1</span><span class="p">.</span><span class="nx">js</span> <span class="o">|</span> <span class="nx">number</span><span class="o">-</span><span class="nx">aggregator</span><span class="o">-</span><span class="nx">stats</span>
</span><span class='line'>
</span><span class='line'><span class="nx">Meas</span><span class="o">:</span> <span class="mi">18</span> <span class="nx">Min</span><span class="o">:</span> <span class="mi">3</span> <span class="nx">Max</span><span class="o">:</span> <span class="mi">4</span> <span class="nx">Avg</span><span class="o">:</span> <span class="mi">4</span> <span class="nx">Cur</span><span class="o">:</span> <span class="mi">4</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s now run our benchmark again &mdash; 3 minutes, 1k
concurrent requests, no timeouts:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">node</span> <span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">server1</span><span class="p">.</span><span class="nx">js</span> <span class="o">|</span> <span class="nx">number</span><span class="o">-</span><span class="nx">aggregator</span><span class="o">-</span><span class="nx">stats</span>
</span><span class='line'>
</span><span class='line'><span class="nx">Meas</span><span class="o">:</span> <span class="mi">1745</span> <span class="nx">Min</span><span class="o">:</span> <span class="mi">3</span> <span class="nx">Max</span><span class="o">:</span> <span class="mi">349</span> <span class="nx">Avg</span><span class="o">:</span> <span class="mi">194</span> <span class="nx">Cur</span><span class="o">:</span> <span class="mi">232</span>
</span></code></pre></td></tr></table></div></figure>


<p>And now let&rsquo;s enable the 3s timeout:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">node</span> <span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">server1</span><span class="p">.</span><span class="nx">js</span> <span class="o">|</span> <span class="nx">number</span><span class="o">-</span><span class="nx">aggregator</span><span class="o">-</span><span class="nx">stats</span>
</span><span class='line'>
</span><span class='line'><span class="nx">Meas</span><span class="o">:</span> <span class="mi">1429</span> <span class="nx">Min</span><span class="o">:</span> <span class="mi">3</span> <span class="nx">Max</span><span class="o">:</span> <span class="mi">411</span> <span class="nx">Avg</span><span class="o">:</span> <span class="mi">205</span> <span class="nx">Cur</span><span class="o">:</span> <span class="mi">172</span>
</span></code></pre></td></tr></table></div></figure>


<p>Whoa, at a first look it seems like <strong>timeouts aren&rsquo;t helping
after all: our memory usage hits a high with timeouts enabled
and is, on average, 5% higher as well</strong>. Is there any reasonable
explanation to that?</p>

<p>There is, of course, as we just need to go back to siege and
look at the rps:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="mf">853.60</span> <span class="nx">trans</span><span class="o">/</span><span class="nx">sec</span> <span class="o">--&gt;</span> <span class="nx">without</span> <span class="nx">timeouts</span>
</span><span class='line'><span class="mf">1134.48</span> <span class="nx">trans</span><span class="o">/</span><span class="nx">sec</span> <span class="o">--&gt;</span> <span class="kd">with</span> <span class="nx">timeouts</span>
</span></code></pre></td></tr></table></div></figure>


<p><img class="right" src="/images/vegeta.jpg"></p>

<p>Here we&rsquo;re comparing <strong>apples to oranges</strong>: it&rsquo;s useless
to look at memory usage of 2 servers that are serving
a different number of rps, as we should instead
make sure they are both offering the same throughput,
and only measure the memory at that point, else the
server that&rsquo;s serving more requests will always start
with some disadvantage!</p>

<p>To do so, we need some kind of tool that makes it easy
to generate rps-based load, and siege is not very
suitable for that: it&rsquo;s time to call our friend <a href="https://github.com/tsenart/vegeta">vegeta</a>,
a modern load testing tool written in <a href="https://golang.org/">golang</a>.</p>

<h2>Enter vegeta</h2>

<p>Vegeta is very simple to use, just start &ldquo;attacking&rdquo;
a server and let it report the results:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">echo</span> <span class="s2">&quot;GET http://google.com&quot;</span> <span class="o">|</span> <span class="nx">vegeta</span> <span class="nx">attack</span> <span class="o">--</span><span class="nx">duration</span> <span class="mi">1</span><span class="nx">h</span> <span class="o">-</span><span class="nx">rate</span> <span class="mi">1000</span> <span class="o">|</span> <span class="nx">tee</span> <span class="nx">results</span><span class="p">.</span><span class="nx">bin</span> <span class="o">|</span> <span class="nx">vegeta</span> <span class="nx">report</span>
</span></code></pre></td></tr></table></div></figure>


<p>2 very interesting options here:</p>

<ul>
<li><code>--duration</code>, so that vegeta will stop after a certain time</li>
<li><code>--rate</code>, as in rps</li>
</ul>


<p>Looks like vegeta is the right tool for us &mdash; we can then issue
a command tailored to our server and see the results:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">echo</span> <span class="s2">&quot;GET http://localhost:3000&quot;</span> <span class="o">|</span> <span class="nx">vegeta</span> <span class="nx">attack</span> <span class="o">--</span><span class="nx">duration</span> <span class="mi">3</span><span class="nx">m</span> <span class="o">--</span><span class="nx">insecure</span> <span class="o">-</span><span class="nx">rate</span> <span class="mi">1000</span> <span class="o">|</span> <span class="nx">tee</span> <span class="nx">results</span><span class="p">.</span><span class="nx">bin</span> <span class="o">|</span> <span class="nx">vegeta</span> <span class="nx">report</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is what vegeta outputs without timeouts:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">Requests</span>      <span class="p">[</span><span class="nx">total</span><span class="p">,</span> <span class="nx">rate</span><span class="p">]</span>            <span class="mi">180000</span><span class="p">,</span> <span class="mf">1000.01</span>
</span><span class='line'><span class="nx">Duration</span>      <span class="p">[</span><span class="nx">total</span><span class="p">,</span> <span class="nx">attack</span><span class="p">,</span> <span class="nx">wait</span><span class="p">]</span>    <span class="mi">3</span><span class="nx">m10</span><span class="p">.</span><span class="mi">062132905</span><span class="nx">s</span><span class="p">,</span> <span class="mi">2</span><span class="nx">m59</span><span class="p">.</span><span class="mi">998999675</span><span class="nx">s</span><span class="p">,</span> <span class="mf">10.06313323</span><span class="nx">s</span>
</span><span class='line'><span class="nx">Latencies</span>     <span class="p">[</span><span class="nx">mean</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="nx">max</span><span class="p">]</span>  <span class="mf">1.172619756</span><span class="nx">s</span><span class="p">,</span> <span class="mf">170.947889</span><span class="nx">ms</span><span class="p">,</span> <span class="mf">10.062145485</span><span class="nx">s</span><span class="p">,</span> <span class="mf">10.134037994</span><span class="nx">s</span><span class="p">,</span> <span class="mf">10.766903205</span><span class="nx">s</span>
</span><span class='line'><span class="nx">Bytes</span> <span class="nx">In</span>      <span class="p">[</span><span class="nx">total</span><span class="p">,</span> <span class="nx">mean</span><span class="p">]</span>            <span class="mi">1080000</span><span class="p">,</span> <span class="mf">6.00</span>
</span><span class='line'><span class="nx">Bytes</span> <span class="nx">Out</span>     <span class="p">[</span><span class="nx">total</span><span class="p">,</span> <span class="nx">mean</span><span class="p">]</span>            <span class="mi">0</span><span class="p">,</span> <span class="mf">0.00</span>
</span><span class='line'><span class="nx">Success</span>       <span class="p">[</span><span class="nx">ratio</span><span class="p">]</span>                  <span class="mf">100.00</span><span class="o">%</span>
</span><span class='line'><span class="nx">Status</span> <span class="nx">Codes</span>  <span class="p">[</span><span class="nx">code</span><span class="o">:</span><span class="nx">count</span><span class="p">]</span>             <span class="mi">200</span><span class="o">:</span><span class="mi">180000</span>
</span><span class='line'><span class="nb">Error</span> <span class="nx">Set</span><span class="o">:</span>
</span></code></pre></td></tr></table></div></figure>


<p>and this is what we get when <code>server1.js</code> has
the 3s timeout enabled:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">Requests</span>      <span class="p">[</span><span class="nx">total</span><span class="p">,</span> <span class="nx">rate</span><span class="p">]</span>            <span class="mi">180000</span><span class="p">,</span> <span class="mf">1000.01</span>
</span><span class='line'><span class="nx">Duration</span>      <span class="p">[</span><span class="nx">total</span><span class="p">,</span> <span class="nx">attack</span><span class="p">,</span> <span class="nx">wait</span><span class="p">]</span>    <span class="mi">3</span><span class="nx">m3</span><span class="p">.</span><span class="mi">028009507</span><span class="nx">s</span><span class="p">,</span> <span class="mi">2</span><span class="nx">m59</span><span class="p">.</span><span class="mi">998999479</span><span class="nx">s</span><span class="p">,</span> <span class="mf">3.029010028</span><span class="nx">s</span>
</span><span class='line'><span class="nx">Latencies</span>     <span class="p">[</span><span class="nx">mean</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="nx">max</span><span class="p">]</span>  <span class="mf">455.780741</span><span class="nx">ms</span><span class="p">,</span> <span class="mf">162.876833</span><span class="nx">ms</span><span class="p">,</span> <span class="mf">3.047947339</span><span class="nx">s</span><span class="p">,</span> <span class="mf">3.070030628</span><span class="nx">s</span><span class="p">,</span> <span class="mf">3.669993753</span><span class="nx">s</span>
</span><span class='line'><span class="nx">Bytes</span> <span class="nx">In</span>      <span class="p">[</span><span class="nx">total</span><span class="p">,</span> <span class="nx">mean</span><span class="p">]</span>            <span class="mi">1142472</span><span class="p">,</span> <span class="mf">6.35</span>
</span><span class='line'><span class="nx">Bytes</span> <span class="nx">Out</span>     <span class="p">[</span><span class="nx">total</span><span class="p">,</span> <span class="nx">mean</span><span class="p">]</span>            <span class="mi">0</span><span class="p">,</span> <span class="mf">0.00</span>
</span><span class='line'><span class="nx">Success</span>       <span class="p">[</span><span class="nx">ratio</span><span class="p">]</span>                  <span class="mf">90.00</span><span class="o">%</span>
</span><span class='line'><span class="nx">Status</span> <span class="nx">Codes</span>  <span class="p">[</span><span class="nx">code</span><span class="o">:</span><span class="nx">count</span><span class="p">]</span>             <span class="mi">500</span><span class="o">:</span><span class="mi">18000</span>  <span class="mi">200</span><span class="o">:</span><span class="mi">162000</span>
</span><span class='line'><span class="nb">Error</span> <span class="nx">Set</span><span class="o">:</span>
</span><span class='line'><span class="mi">500</span> <span class="nx">Internal</span> <span class="nx">Server</span> <span class="nb">Error</span>
</span></code></pre></td></tr></table></div></figure>


<p>as you see, the total number of requests and
elapsed time is the same between the 2
benchmarks, meaning that we&rsquo;ve put the servers
under the same level of stress: now that we&rsquo;ve
got them to perform the same tasks, under the
same load, we can look at memory usage to see
if timeouts helped us keeping a lower memory
footprint.</p>

<p>Without timeouts:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">node</span> <span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">server1</span><span class="p">.</span><span class="nx">js</span> <span class="o">|</span> <span class="nx">number</span><span class="o">-</span><span class="nx">aggregator</span><span class="o">-</span><span class="nx">stats</span>
</span><span class='line'>
</span><span class='line'><span class="nx">Meas</span><span class="o">:</span> <span class="mi">1818</span> <span class="nx">Min</span><span class="o">:</span> <span class="mi">3</span> <span class="nx">Max</span><span class="o">:</span> <span class="mi">372</span> <span class="nx">Avg</span><span class="o">:</span> <span class="mi">212</span> <span class="nx">Cur</span><span class="o">:</span> <span class="mi">274</span>
</span></code></pre></td></tr></table></div></figure>


<p>and with timeouts:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">node</span> <span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">server1</span><span class="p">.</span><span class="nx">js</span> <span class="o">|</span> <span class="nx">number</span><span class="o">-</span><span class="nx">aggregator</span><span class="o">-</span><span class="nx">stats</span>
</span><span class='line'>
</span><span class='line'><span class="nx">Meas</span><span class="o">:</span> <span class="mi">1886</span> <span class="nx">Min</span><span class="o">:</span> <span class="mi">3</span> <span class="nx">Max</span><span class="o">:</span> <span class="mi">299</span> <span class="nx">Avg</span><span class="o">:</span> <span class="mi">149</span> <span class="nx">Cur</span><span class="o">:</span> <span class="mi">292</span>
</span></code></pre></td></tr></table></div></figure>


<p>This looks more like it: timeouts have
helped us keeping the <strong>memory usage, on average,
30% lower</strong><sup id='fnref:2'><a href='#fn:2' rel='footnote'>2</a></sup>.</p>

<p>All of this thanks to a simple <code>.timeout(3000)</code>:
what a win!</p>

<h2>Avoiding the domino effect</h2>

<p>Quoting myself:</p>

<blockquote><p>What happens when those services are slow or unavailable? Well,<br/>you can&#8217;t process search queries, or payments, but your<br/>app would still be working &#8220;fine&#8221; &#8211; right?</p></blockquote>


<p>Fun fact: <strong>a missing timeout can
cripple your entire infrastructure!</strong></p>

<p><img class="left" src="/images/domino.jpg"></p>

<p>In our basic example we saw how a service that
starts to fail at a 10% rate can significantly
increase memory
usage of the services depending on it, and that&rsquo;s
not an unrealistic scenario &mdash; it&rsquo;s basically
just a single, wonky server in a pool of ten.</p>

<p>Imagine you have a webpage that relies on a
backend service, behind a load balancer, that
starts to perform slower than usual: the service
still works (it&rsquo;s just way slower than it should),
your healthcheck is probably
still getting a <code>200 Ok</code> from the service (even
though it comes after several seconds rather than
milliseconds), so the service won&rsquo;t be removed from
the load balancer.</p>

<p><span class='pullquote-right' data-pullquote='This is what a domino effect looks like: a system
slows down (or incurs in downtime) and other pieces
in the architecture are affected'>
You&rsquo;ve just created <strong>a trap
for your frontends</strong>: they will start requiring
more memory, serve less requests and&hellip; &hellip;a recipe for disaster.</p>

<p>This is what a domino effect looks like: a system
slows down (or incurs in downtime) and other pieces
in the architecture are affected by it,
highlighting a design that didn&rsquo;t consider failure
an option and is neither robust nor resilient enough.</p>

<p>The key thing to keep in mind is: <strong>embrace failures</strong>,
let them come and make sure you can fight them with
ease.
</span></p>

<h2>A note on timeouts</h2>

<p>If you thought waiting is dangerous, let&rsquo;s add to the
fire:</p>

<ul>
<li>we&rsquo;re not talking HTTP only &mdash; everytime we rely on an external system we should <a href="https://github.com/mysqljs/mysql#connection-options">use timeouts</a></li>
<li>a server could have an open port and drop every packet you send &mdash; this will result in a TCP connection timeout. Try this in your terminal: <code>time curl example.com:81</code>. Good luck!</li>
<li>a server could reply instantly, but be very slow at sending each packet (as in, seconds between packets). You would then need to protect yourself against a <strong>read timeout</strong></li>
</ul>


<p>&hellip;and many more edge cases to list. I know, distributed systems are nasty.</p>

<p>Luckily, high-level APIs (like the one <a href="https://github.com/Mashape/unirest-nodejs#requesttimeoutnumber">exposed by unirest</a>)
are generally helpful since they take care of all of the hiccups that
might happen on the way.</p>

<h2>Closing remarks: I&rsquo;ve broken every single benchmarking rule</h2>

<p>If you have any &ldquo;aggressive&rdquo; feedback about my <em>rusty</em> benchmarking skills&hellip;
&hellip;well, I would agree with you, as I purposely took some shortcuts
for the sake of simplifying my job and the ability, for you, to
easily reproduce these benchmarks.</p>

<p>Things you should do if you&rsquo;re serious about benchmarks:</p>

<ul>
<li>do not run the code you&rsquo;re benchmarking and the tool you use to benchmark on the same machine. Here I ran everything on my XPS which is powerful enough to let me run these tests, though running siege / vegeta on the same machine the servers run definitely has an impact on the results (I say <code>ulimit</code> and you figure out the rest). My advice is to try to get some hardware on AWS and benchmark from there &mdash; more isolation, less doubts</li>
<li>do not measure memory by logging it out with a <code>console.log</code>, instead use a tool such as NewRelic which, I think, is less invasive</li>
<li>measure more data: benchmarking for 3 minutes is ok for the sake of this post, but if we want to look at real-world data, to give a better estimate of how helpful timeouts are, you should leave the benchmarks running for way longer</li>
<li>keep Gmail closed while you run <code>siege ...</code>, the tenants living in <code>/proc/cpuinfo</code> will be grateful</li>
</ul>


<p>And&hellip;I&rsquo;m done for the day: I hope you enjoyed this post and, if otherwise, feel
free to rant in the comment box below!</p>

<div class="footnotes">
<span>
Notes
</span>
    <ol>
        <li id='fn:1'>For system-to-system integrations it could even be 10 to 20 seconds, depending on how slow the backend you have to connect to is (sigh: don&#8217;t ask me) <a href='#fnref:1' rev='footnote'>↩</a></li><li id='fn:2'>But don&#8217;t be naive and think that the 30% of memory saved will be the same in your production infrastructure. It really depends on your setup &#8211; it could be lower (most likely) or even higher. Benchmark for yourself and see what you&#8217;re missing out on! <a href='#fnref:2' rev='footnote'>↩</a></li>
    </ol>
</div>

</div>



<div class="recent entry-content">
  <hr class="divider-cazzuto">
  <h3>
    In the mood for some more reading?
  </h3>
  <ul>
    
      <li><a href="/fwupd-is-the-best-thing-that-ever-happened-to-linux/">fwupd is the best thing that ever happened to Linux</a> (15 April 2021)</li>
    
      <li><a href="/avoid-battery-draining-on-your-linux-flavored-dell-xps/">Avoid battery draining on your Linux-flavored Dell XPS</a> (31 January 2021)</li>
    
      <li><a href="/combining-two-numbers-into-a-unique-one-pairing-functions/">Combining two numbers into a unique one: pairing functions</a> (05 December 2020)</li>
    
      <li><a href="/running-ci-tests-in-kubernetes-through-github-actions/">Running CI tests in Kubernetes through Github Actions</a> (20 March 2020)</li>
    
      <li><a href="/ive-decided-to-make-the-wasec-ebook-free-during-these-trying-times/">I've decided to make the WASEC ebook free during these trying times</a> (20 March 2020)</li>
    
      <li><a href="/local-k8s-development-in-2020/">Local k8s development in 2020</a> (31 December 2019)</li>
    
      <li><a href="/wasec-a-book-about-web-application-security-is-now-available-for-sale/">WASEC, a book about Web Application Security, is now available for sale</a> (25 November 2019)</li>
    
  </ul>
    <p>
      ...or <a href="/archives/">check the archives</a>.
    </p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/anchor-js/3.2.0/anchor.min.js"></script>
<script type="text/javascript" />
(function () {
  'use strict';

  anchors.options = {
    placement: 'left',
    visible: 'hover',
    icon: '¶'
  };

  anchors.add('h2');
  anchors.add('h3');
  anchors.add('h4');

})();
</script>

			<footer>
				<center>
	Copyleft <!--[if lte IE 8]><span style="filter: FlipH; -ms-filter: "FlipH"; display: inline-block;"><![endif]--><span style="-moz-transform: scaleX(-1); -o-transform: scaleX(-1); -webkit-transform: scaleX(-1); transform: scaleX(-1); display: inline-block;">©</span><!--[if lte IE 8]></span><![endif]--> 2021 — Alessandro Nadalin
	<address>
	</address>
</center>
			</footer>
		</div>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-7407627-3', 'auto');
      ga('send', 'pageview');
	</script>
	
	<script type="application/ld+json">
		{
		"@context": "https://schema.org/",
		"@type": "BlogPosting",
		"mainEntityOfPage": {
			"@type": "WebPage",
			"@id": "https://odino.org/better-performance-the-case-for-timeouts/"
		},
		"headline": "Better performance: the case for timeouts",
		"description": "Use timeouts to build more robust and less expensive distributed systems: less memory, less downtime, more fun!",
		
		"author": {
			"@type": "Person",
			"name": "Alessandro Nadalin"
		},
		"datePublished": "2017-01-19 18:57:00 +0000"
		}
	</script>
	
	</body>
</html>
<!-- END _layouts/default.html -->
